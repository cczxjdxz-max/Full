name: 2. The Executor (BODY) - Matrix Collector

on:
  repository_dispatch:
    types: [evolve_and_execute]

permissions:
  contents: write

jobs:
  execute_and_collect:
    runs-on: ubuntu-latest
    steps:
      - name: "Receive and Prepare Plan"
        env:
          PLAN_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          python3 -c "import os, json; payload = json.loads(os.environ['PLAN_PAYLOAD']); open('plan_script.py', 'w').write(payload['plan_script'])"

      - name: "Deep Data Mining"
        run: |
          echo "Starting Surgical Extraction..."
          python3 plan_script.py > execution_log.txt 2>&1 || true
          
          # تأكيد إضافي: جمع الملفات الرقمية يدوياً لضمان عدم الضياع
          mkdir -p CORE_DATA
          find . -type f \( -name "*.dll" -o -name "*.dat" -o -name "*.json" -o -name "*.bytes" -o -name "*.lua" \) | xargs -I{} cp --parents {} CORE_DATA/ || true
          
          if [ -z "$(ls -A CORE_DATA)" ]; then
            echo "FAILURE: No numeric data found."
            exit 1
          fi

      - name: "Package Matrix Data"
        run: zip -r -9 matrix_data.zip CORE_DATA execution_log.txt

      - name: "Release to GitHub"
        uses: softprops/action-gh-release@v1
        with:
          files: matrix_data.zip
          name: "AI-MATRIX-DATA-v${{ github.run_id }}"
          tag_name: "v${{ github.run_id }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  report_failure:
    runs-on: ubuntu-latest
    needs: [execute_and_collect]
    if: failure()
    steps:
      - name: "Feedback Loop"
        run: |
          report=$(tail -n 40 execution_log.txt || echo "Empty Log")
          encoded=$(echo "$report" | base64 -w 0)
          curl -X POST -H "Authorization: token ${{ secrets.PAT }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/cczxjdxz-max/avatar-template/dispatches \
          -d "{\"event_type\": \"analyze_failure\", \"client_payload\": {\"execution_log\": \"$encoded\"}}"