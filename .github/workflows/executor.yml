name: Geass_Final_Complete_Build
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_apk:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Android Project
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù†Ø¸Ø§Ù… Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
          mkdir -p app/src/main/java/com/geass/shell
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/drawable
          
          # Ù†Ù‚Ù„ ØµÙˆØ± PNG Ù…Ù† Ù…Ø¬Ù„Ø¯ build Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ drawable Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…
          cp build/geass_eye_full.png app/src/main/res/drawable/ || echo "Eye image not found!"
          cp build/geass_icon.png app/src/main/res/drawable/ || echo "Icon image not found!"
          cp build/magic_array.png app/src/main/res/drawable/ || echo "Circle image not found!"

          # 1. ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø·Ø§ÙÙŠØ© (Ø§Ù„Ø¹ÙŠÙ† ÙÙˆÙ‚ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©)
          cat <<EOF > app/src/main/res/layout/floating_layout.xml
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="wrap_content" android:layout_height="wrap_content">
              <ImageView android:id="@+id/magic_circle"
                  android:layout_width="280dp" android:layout_height="280dp"
                  android:layout_gravity="center" android:src="@drawable/magic_array" />
              <ImageView android:id="@+id/geass_eye"
                  android:layout_width="190dp" android:layout_height="190dp"
                  android:layout_gravity="center" android:src="@drawable/geass_eye_full" />
          </FrameLayout>
          EOF

          # 2. ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø±ÙƒÙŠ)
          cat <<EOF > app/src/main/java/com/geass/shell/FloatingService.java
          package com.geass.shell;
          import android.animation.*;
          import android.app.Service;
          import android.content.Intent;
          import android.graphics.PixelFormat;
          import android.os.IBinder;
          import android.view.*;
          import android.view.animation.LinearInterpolator;
          import android.widget.ImageView;

          public class FloatingService extends Service {
              private WindowManager wm;
              private View root;
              private WindowManager.LayoutParams params;

              @Override public void onCreate() {
                  super.onCreate();
                  wm = (WindowManager) getSystemService(WINDOW_SERVICE);
                  root = LayoutInflater.from(this).inflate(R.layout.floating_layout, null);
                  
                  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø§ÙÙŠØ© ÙÙˆÙ‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                  params = new WindowManager.LayoutParams(
                      WindowManager.LayoutParams.WRAP_CONTENT, WindowManager.LayoutParams.WRAP_CONTENT,
                      WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE, PixelFormat.TRANSLUCENT);
                  
                  wm.addView(root, params);

                  ImageView circle = root.findViewById(R.id.magic_circle);
                  ImageView eye = root.findViewById(R.id.geass_eye);

                  // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©: Ù„ÙØ© ÙƒØ§Ù…Ù„Ø© ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù
                  ObjectAnimator rotate = ObjectAnimator.ofFloat(circle, "rotation", 0f, 360f);
                  rotate.setDuration(3000);
                  rotate.setInterpolator(new LinearInterpolator());
                  rotate.setRepeatCount(ValueAnimator.INFINITE);
                  rotate.start();

                  // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±Ù…Ø´: ØªØºÙ…Ø¶ ÙˆØªÙØªØ­ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
                  setupBlink(eye);

                  // Ù…ÙŠØ²Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ Ø¨Ø§Ù„Ø¥ØµØ¨Ø¹
                  setupDrag();
              }

              private void setupBlink(View eye) {
                  eye.animate().scaleY(0).setDuration(200).setStartDelay(5000).withEndAction(() -> 
                  eye.animate().scaleY(1).setDuration(200).withEndAction(() -> setupBlink(eye)).start()).start();
              }

              private void setupDrag() {
                  root.setOnTouchListener(new View.OnTouchListener() {
                      private int ix, iy; private float itx, ity;
                      @Override public boolean onTouch(View v, MotionEvent e) {
                          switch (e.getAction()) {
                              case MotionEvent.ACTION_DOWN:
                                  ix = params.x; iy = params.y;
                                  itx = e.getRawX(); ity = e.getRawY();
                                  return true;
                              case MotionEvent.ACTION_MOVE:
                                  params.x = ix + (int)(e.getRawX() - itx);
                                  params.y = iy + (int)(e.getRawY() - ity);
                                  wm.updateViewLayout(root, params);
                                  return true;
                          }
                          return false;
                      }
                  });
              }

              @Override public IBinder onBind(Intent i) { return null; }
              @Override public void onDestroy() { if(root != null) wm.removeView(root); super.onDestroy(); }
          }
          EOF

      - name: ğŸ”¨ Execute Build Process
        run: |
          echo "include ':app'" > settings.gradle
          cat <<EOF > app/build.gradle
          apply plugin: 'com.android.application'
          android { 
              compileSdkVersion 31
              namespace 'com.geass.shell'
              defaultConfig { 
                  applicationId "com.geass.shell" 
                  minSdkVersion 26 
                  targetSdkVersion 31 
                  versionCode 1
                  versionName "1.0"
              } 
          }
          EOF
          wget -q https://services.gradle.org/distributions/gradle-7.5-bin.zip
          unzip -q gradle-7.5-bin.zip
          ./gradle-7.5/bin/gradle :app:assembleDebug --no-daemon

      - name: ğŸ“¦ Deliver Final APK
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/debug/app-debug.apk
          tag_name: "v_geass_beast_final"
          body: "The Geass summoning system is ready. Dragon rotation 3s, Blink 5s, Drag-to-move enabled."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}