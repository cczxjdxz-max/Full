name: 2. The Executor (BODY) - Matrix Collector

on:
  repository_dispatch:
    types: [evolve_and_execute]

permissions:
  contents: write

jobs:
  execute_and_collect:
    runs-on: ubuntu-latest
    steps:
      - name: "Receive Plan"
        env:
          PLAN_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          python3 -c "import os, json; open('plan_script.py', 'w').write(json.loads(os.environ['PLAN_PAYLOAD'])['plan_script'])"

      - name: "Extract Numerical Data"
        run: |
          python3 plan_script.py > execution_log.txt 2>&1 || true

      - name: "Surgical Data Mining"
        run: |
          mkdir -p CORE_DATA
          # البحث عن ملفات الإعدادات والبرمجة فقط (بدون صور أو أصوات)
          find . -type f \( -name "*.json" -o -name "*.lua" -o -name "*.xml" -o -name "*.csv" -o -name "*.bytes" -o -name "*.dll" -o -name "*.dat" \) | xargs -I{} cp --parents {} CORE_DATA/ || true
          
          # حذف أي ملفات صور قد تكون تسللت بالخطأ لتقليل الحجم
          find CORE_DATA -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.mp3" \) -delete
          
          zip -r -9 matrix_data.zip CORE_DATA

      - name: "Release Matrix Data"
        uses: softprops/action-gh-release@v1
        with:
          files: matrix_data.zip
          name: "AI-MATRIX-DATA-${{ github.run_id }}"
          tag_name: "matrix-v${{ github.run_id }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}