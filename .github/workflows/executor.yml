name: GIAS_Nirvana_Final_Guaranteed
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions: write-all
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ù‡Ù…: Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Java 17 ---
      - name: 2. Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # --- Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯Ù… (Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù) ---
      - name: 3. Restore Build Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-gias-v5-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-gias-v5-

      - name: 4. Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libltdl-dev libtool autoconf automake \
          pkg-config zlib1g-dev libncurses5-dev libffi-dev libssl-dev ffmpeg
          pip install --upgrade pip
          pip install Cython==0.29.33 buildozer opencv-python-headless numpy

      - name: 5. Render Preview (720P)
        run: |
          python3 -c "import cv2, numpy as np; out = cv2.VideoWriter('preview_720p.mp4', cv2.VideoWriter_fourcc(*'mp4v'), 30.0, (1280, 720)); [out.write(np.zeros((720, 1280, 3), np.uint8)) for _ in range(60)]; out.release()"
          ffmpeg -i preview_720p.mp4 -f lavfi -i anullsrc -c:v copy -c:a aac -shortest final_preview.mp4

      - name: 6. Build APK (Forced Resume Mode)
        run: |
          [ ! -f buildozer.spec ] && buildozer init
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy,numpy,opencv-python-headless/' buildozer.spec
          sed -i 's/#android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec
          sed -i 's/android.api = 31/android.api = 33/' buildozer.spec
          
          # ØªÙ†Ø¸ÙŠÙ Ù…Ù„ÙØ§Øª Gradle Ø§Ù„ØªØ§Ù„ÙØ© ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù†Ø¸ÙŠÙ
          rm -rf .buildozer/android/platform/build-arm64-v8a/dists/*/.gradle
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§Ø¡
          yes | buildozer android debug

      - name: 7. Release Final Files
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v21.0-Absolute
          name: "G.I.A.S Nirvana Final Build"
          body: |
            ğŸ”± **ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­** ğŸ”±
            - Ù…ÙŠØ²Ø© Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù: Ù…ÙØ¹Ù„Ø©.
            - Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø§ÙØ§: 17.
            - Ø¬ÙˆØ¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: 720P.
          files: |
            bin/*.apk
            final_preview.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}