name: Geass_Force_Show_Eye
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_apk:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Android Project
        run: |
          mkdir -p app/src/main/java/com/geass/shell
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/drawable
          
          # 1. Manifest Ù…Ø¹Ø¯Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ´ØºÙŠÙ„
          cat <<EOF > app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.geass.shell">
              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
              <application android:label="Geass Shell" android:theme="@android:style/Theme.NoTitleBar" android:icon="@drawable/geass_icon">
                  <service android:name=".FloatingService" android:enabled="true" android:exported="false"/>
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # 2. MainActivity ØªØ·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† ÙˆØªØ´ØºÙ„ Ø§Ù„Ø¹ÙŠÙ† ÙÙˆØ±Ø§Ù‹
          cat <<EOF > app/src/main/java/com/geass/shell/MainActivity.java
          package com.geass.shell;
          import android.app.Activity;
          import android.content.Intent;
          import android.net.Uri;
          import android.os.Bundle;
          import android.provider.Settings;
          import android.widget.Toast;

          public class MainActivity extends Activity {
              @Override protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  if (!Settings.canDrawOverlays(this)) {
                      Toast.makeText(this, "Please allow 'Display over apps'", Toast.LENGTH_LONG).show();
                      Intent i = new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION, Uri.parse("package:" + getPackageName()));
                      startActivityForResult(i, 1);
                  } else { 
                      startForegroundService(new Intent(this, FloatingService.class)); 
                      finish(); 
                  }
              }
              @Override protected void onActivityResult(int req, int res, Intent data) {
                  if (Settings.canDrawOverlays(this)) {
                      startForegroundService(new Intent(this, FloatingService.class));
                      finish();
                  }
              }
          }
          EOF

          # Ù†Ù‚Ù„ Ø§Ù„ØµÙˆØ± Ù…Ù† Ù…Ø¬Ù„Ø¯ build
          cp build/geass_eye_full.png app/src/main/res/drawable/
          cp build/geass_icon.png app/src/main/res/drawable/
          cp build/magic_array.png app/src/main/res/drawable/

          # 3. Floating Layout (ØªØ£ÙƒØ¯Ù†Ø§ Ù…Ù† Ø§Ù„Ø´ÙØ§ÙÙŠØ©)
          cat <<EOF > app/src/main/res/layout/floating_layout.xml
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="wrap_content" android:layout_height="wrap_content"
              android:background="@android:color/transparent">
              <ImageView android:id="@+id/magic_circle"
                  android:layout_width="280dp" android:layout_height="280dp"
                  android:layout_gravity="center" android:src="@drawable/magic_array" />
              <ImageView android:id="@+id/geass_eye"
                  android:layout_width="190dp" android:layout_height="190dp"
                  android:layout_gravity="center" android:src="@drawable/geass_eye_full" />
          </FrameLayout>
          EOF

          # 4. Floating Service (ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ¹Ù„ÙŠ)
          cat <<EOF > app/src/main/java/com/geass/shell/FloatingService.java
          package com.geass.shell;
          import android.animation.*;
          import android.app.*;
          import android.content.Intent;
          import android.graphics.PixelFormat;
          import android.os.IBinder;
          import android.view.*;
          import android.view.animation.LinearInterpolator;
          import android.widget.ImageView;
          import androidx.core.app.NotificationCompat;

          public class FloatingService extends Service {
              private WindowManager wm;
              private View root;

              @Override public void onCreate() {
                  super.onCreate();
                  // Ø¥Ø´Ø¹Ø§Ø± Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø§Ù„Ø­Ø¯ÙŠØ« Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
                  Notification n = new NotificationCompat.Builder(this, "default")
                      .setContentTitle("Geass Active").setSmallIcon(android.R.drawable.ic_menu_compass).build();
                  startForeground(1, n);

                  wm = (WindowManager) getSystemService(WINDOW_SERVICE);
                  root = LayoutInflater.from(this).inflate(R.layout.floating_layout, null);
                  
                  WindowManager.LayoutParams p = new WindowManager.LayoutParams(
                      WindowManager.LayoutParams.WRAP_CONTENT, WindowManager.LayoutParams.WRAP_CONTENT,
                      WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE, PixelFormat.TRANSLUCENT);
                  
                  wm.addView(root, p);

                  ImageView c = root.findViewById(R.id.magic_circle);
                  ImageView e = root.findViewById(R.id.geass_eye);

                  c.animate().rotationBy(360000).setDuration(3000000).setInterpolator(new LinearInterpolator()).start();
                  setupBlink(e);
                  
                  root.setOnTouchListener((v, event) -> {
                      static float dx, dy;
                      if(event.getAction()==0){ dx=p.x-event.getRawX(); dy=p.y-event.getRawY(); }
                      if(event.getAction()==2){ p.x=(int)(event.getRawX()+dx); p.y=(int)(event.getRawY()+dy); wm.updateViewLayout(root, p); }
                      return true;
                  });
              }
              private void setupBlink(View e) {
                  e.animate().scaleY(0).setDuration(200).setStartDelay(5000).withEndAction(() -> 
                  e.animate().scaleY(1).setDuration(200).withEndAction(() -> setupBlink(e)).start()).start();
              }
              @Override public IBinder onBind(Intent i) { return null; }
          }
          EOF

      - name: ğŸ”¨ Build APK
        run: |
          echo "include ':app'" > settings.gradle
          cat <<EOF > build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:7.2.1' }
          }
          allprojects { repositories { google(); mavenCentral() } }
          EOF
          cat <<EOF > app/build.gradle
          apply plugin: 'com.android.application'
          android { 
              compileSdkVersion 31
              namespace 'com.geass.shell'
              defaultConfig { applicationId "com.geass.shell"; minSdkVersion 26; targetSdkVersion 31 }
          }
          EOF
          wget -q https://services.gradle.org/distributions/gradle-7.5-bin.zip
          unzip -q gradle-7.5-bin.zip
          ./gradle-7.5/bin/gradle :app:assembleDebug --no-daemon

      - name: ğŸ“¦ Release
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/debug/app-debug.apk
          tag_name: "v_geass_visible"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}