name: 3. The Visualizer (BODY) - Combat Simulation Video

on:
  repository_dispatch:
    types: [generate_video]

permissions:
  contents: write
  packages: write

jobs:
  create_simulation_video:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Install Python Dependencies"
        run: |
          pip install numpy matplotlib imageio
          # ุชุฃูุฏ ูู ูุฌูุฏ ููู discovered_wisdom.dat ูู ูุฌูุฏ ุงูุนูู
          # (ูุฐุง ูุชุทูุจ ุฃู ูููู ูุฏ ุชู ุฑูุนู ูู Artifact ุฃู ุฌุฒุก ูู ุงูู Release ุงูุณุงุจู)
          # ูุฃุบุฑุงุถ ุงูุชุฌุฑุจุฉุ ุณูููู ุจุฅูุดุงุก ููู ูููู ูุคูุชุงู
          python -c "import numpy as np; np.random.randn(2048, 1024).astype(np.float32).tofile('discovered_wisdom.dat')"

      - name: "Decode and Run Visualizer Script"
        run: |
          echo "${{ github.event.client_payload.plan_base64 }}" | base64 -d > visualizer.py
          python3 visualizer.py

      - name: "Upload Simulation GIF"
        uses: actions/upload-artifact@v4
        with:
          name: combat-simulation-gif
          path: combat_simulation.gif
          retention-days: 7

      - name: "Update README with Video Link"
        run: |
          # ุชุญุชุงุฌ ููุง ุฅูู ุฑุงุจุท ูุจุงุดุฑ ููู artifact
          # ูุฐุง ูุซุงู ููุทุ ุณุชุญุชุงุฌ ููุญุตูู ุนูู ุงูุฑุงุจุท ุงููุนูู ุจุนุฏ ุงูุฑูุน
          echo "## ๐ฌ Visual Combat Simulation" >> README.md
          echo "ุดุงูุฏ ุจุทููุง ูุชุตุฏู ูู 100 ุฎุตู:" >> README.md
          echo "![Combat Simulation GIF](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${{ github.run_id }}/artifacts/combat-simulation-gif)" >> README.md
          # ุฃู ูููู ุชุญุฏูุซ README ุจุนุฏ ุงูู release ูุจุงุดุฑุฉ
          
      - name: "Release Simulation Output"
        uses: softprops/action-gh-release@v1
        with:
          files: |
            combat_simulation.gif
            results.txt # ุฅุฐุง ูุงู ููุงู ููู ูุชุงุฆุฌ ุฅุถุงูู ูู ุงูู visualizer
          name: "Combat-Simulation-v${{ github.run_id }}"
          tag_name: "sim-v${{ github.run_id }}"
          body: "ููุฏูู ุชุฎููู ููุถุญ ุงุณุชุฑุงุชูุฌูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุถุฏ 100 ุฎุตู."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}