name: 2. The Executor (BODY)

on:
  repository_dispatch:
    types: [execute_extraction_plan]

permissions:
  contents: write # صلاحية ضرورية لإنشاء الـ Release

jobs:
  execute_the_plan:
    runs-on: ubuntu-latest
    steps:
      - name: "Receive and Write Plan"
        run: |
          # طريقة آمنة ومباشرة لكتابة الخطة المستلمة في ملف
          python3 -c "import os, json; open('miner_script.py', 'w').write(json.loads(os.environ['PLAN_PAYLOAD'])['plan'])"
        env:
          PLAN_PAYLOAD: ${{ toJSON(github.event.client_payload) }}

      - name: "Execute the Manager's plan"
        run: |
          echo "Executing the plan designed by The Manager..."
          chmod +x miner_script.py
          python3 miner_script.py || echo "Script finished, possibly with non-fatal errors."

      - name: "Secure Data with Final Sweep"
        run: |
          echo "Performing a final sweep to secure all valuable assets..."
          mkdir -p CORE_DATA
          find . -type f \( -name "*.json" -o -name "*.xml" -o -name "*.lua" \) -exec cp --parents {} CORE_DATA/ \; || echo "No extra files found."
          zip -r core_data.zip CORE_DATA

      - name: "Report Mission Status by Creating a Release"
        uses: softprops/action-gh-release@v1
        if: always() # سيحاول دائمًا رفع تقرير
        with:
          files: core_data.zip
          name: "Extraction-Report-${{ github.run_id }}"
          tag_name: "v${{ github.run_id }}"
          body: "Extraction mission completed. Review attached zip for extracted assets."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}