name: 2. The Executor (BODY) - Surgical Reporter

on:
  repository_dispatch:
    types: [evolve_and_execute]

permissions:
  contents: write

jobs:
  execute_evolutionary_plan:
    runs-on: ubuntu-latest
    steps:
      # ... (نفس خطوات الاستعادة، الاستقبال، التنفيذ، التحميل) ...
      - name: "Restore Previous State"
        uses: actions/cache/restore@v4
        with:
          path: .
          key: state-${{ github.run_id }}
          restore-keys: |
            state-

      - name: "Receive and Write Plan"
        run: |
          python3 -c "import os, json; open('plan_script.py', 'w').write(json.loads(os.environ['PLAN_PAYLOAD'])['plan_script'])"
        env:
          PLAN_PAYLOAD: ${{ toJSON(github.event.client_payload) }}

      - name: "Execute the Manager's Plan"
        run: |
          echo "Executing the plan designed by The Manager..."
          chmod +x plan_script.py
          # تنفيذ السكربت والتقاط كل المخرجات
          ./plan_script.py > execution_log.txt 2>&1 || true
          echo "Plan execution finished."

      - name: "Archive Execution Log"
        uses: actions/upload-artifact@v4
        with:
          name: execution-log-for-${{ github.run_id }}
          path: execution_log.txt

      - name: "Verify Goal Achievement"
        run: |
          echo "Verifying if assets were extracted into CORE_DATA..."
          if [ -d "CORE_DATA" ] && [ -n "$(ls -A CORE_DATA)" ]; then
            echo "SUCCESS: Assets found. Mission accomplished."
          else
            echo "FAILURE: CORE_DATA is empty or does not exist."
            exit 1
          fi
      # ... (نفس خطوات إنشاء الـ Release عند النجاح) ...

  # --- مهمة إرسال التقرير الجراحي ---
  report_failure:
    runs-on: ubuntu-latest
    needs: [execute_evolutionary_plan]
    if: failure()

    steps:
      - name: "Download Log from Failed Job"
        uses: actions/download-artifact@v4
        with:
          name: execution-log-for-${{ github.run_id }}

      # --- الخطوة الجديدة: التحليل الجراحي للسجل ---
      - name: "Surgical Log Analysis"
        id: surgical_analysis
        run: |
          # نقرأ السجل ونستخرج منه فقط الأسطر التي تحتوي على كلمات مثل ERROR, FATAL, Traceback
          # أو نأخذ آخر 20 سطرًا إذا لم نجد شيئًا، لضمان وجود سياق
          error_report=$(grep -iE 'error|fatal|traceback|fail' execution_log.txt || tail -n 20 execution_log.txt)
          
          # إذا كان التقرير فارغًا، نرسل رسالة واضحة
          if [ -z "$error_report" ]; then
            error_report="Execution finished, but the CORE_DATA directory was empty. The script produced no errors but also no results."
          fi
          
          # ترميز التقرير الجراحي فقط
          encoded_report=$(echo "$error_report" | base64 -w 0)
          echo "report_data=${encoded_report}" >> $GITHUB_OUTPUT

      - name: "Save State for Next Attempt"
        uses: actions/cache/save@v4
        with:
          path: .
          key: state-${{ github.run_id }}

      - name: "Report Surgical Failure to Manager"
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          repository: cczxjdxz-max/avatar-template
          event-type: analyze_failure
          # نرسل التقرير الجراحي المركز
          client-payload: '{"execution_log": "${{ steps.surgical_analysis.outputs.report_data }}" }'