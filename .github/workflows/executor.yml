name: Geass_Vision_Pro_Sizing
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ 1. Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ 2. Setup
        run: |
          mkdir -p app/src/main/java/com/geass/shell
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/drawable
          cp -v build/*.png app/src/main/res/drawable/ || echo "Check images"

      - name: ğŸ“ 3. Manifest
        run: |
          cat <<EOF > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.geass.shell">
              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
              <application android:label="Geass Vision" android:icon="@drawable/geass_icon" android:theme="@android:style/Theme.NoTitleBar">
                  <service android:name=".FloatingService" android:enabled="true" android:exported="false"/>
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: ğŸ¨ 4. Fixed Layout (ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¨Ø¤Ø¨Ø¤ ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬)
        run: |
          cat <<EOF > app/src/main/res/layout/floating_layout.xml
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="160dp" android:layout_height="160dp">
              
              <FrameLayout 
                  android:layout_width="100dp" 
                  android:layout_height="100dp"
                  android:layout_gravity="center">
                  <ImageView android:id="@+id/pupil"
                      android:layout_width="75dp" android:layout_height="75dp" 
                      android:layout_gravity="center"
                      android:src="@drawable/pupil" />
              </FrameLayout>

              <ImageView android:id="@+id/geass_eye_base"
                  android:layout_width="match_parent" 
                  android:layout_height="match_parent"
                  android:src="@drawable/geass_eye_base" />
          </FrameLayout>
          EOF

      - name: ğŸ§  5. Logic (Ø­Ø±ÙƒØ© Ù…Ù‚ÙŠØ¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹ÙŠÙ†)
        run: |
          cat <<EOF > app/src/main/java/com/geass/shell/FloatingService.java
          package com.geass.shell;
          import android.app.*;
          import android.graphics.PixelFormat;
          import android.view.*;
          import android.os.*;
          import android.widget.ImageView;
          public class FloatingService extends Service {
              private WindowManager wm;
              private View root;
              private Handler h = new Handler(Looper.getMainLooper());
              @Override public void onCreate() {
                  super.onCreate();
                  wm = (WindowManager) getSystemService(WINDOW_SERVICE);
                  root = LayoutInflater.from(this).inflate(R.layout.floating_layout, null);
                  WindowManager.LayoutParams p = new WindowManager.LayoutParams(
                      500, 500, 
                      (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) ? 2038 : 2003,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE, PixelFormat.TRANSLUCENT);
                  p.gravity = Gravity.CENTER;
                  wm.addView(root, p);
                  startEyeMotion();
              }
              private void startEyeMotion() {
                  h.post(new Runnable() {
                      @Override public void run() {
                          if(root == null) return;
                          View p = root.findViewById(R.id.pupil);
                          View e = root.findViewById(R.id.geass_eye_base);
                          
                          // Ø­Ø±ÙƒØ© Ø§Ù„Ø±Ù…Ø´
                          e.animate().scaleY(0.05f).setDuration(120).withEndAction(() -> e.animate().scaleY(1f).setDuration(120).start()).start();
                          
                          // Ø­Ø±ÙƒØ© Ø§Ù„Ø¨Ø¤Ø¨Ø¤: ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù‰ (Range) Ù„ÙŠØ¨Ù‚Ù‰ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙˆØ§Ø¯
                          float moveX = (float)(Math.random() * 40 - 20); // Ù…Ø¯Ù‰ Ø­Ø±ÙƒØ© Ø¶ÙŠÙ‚
                          float moveY = (float)(Math.random() * 40 - 20);
                          p.animate().translationX(moveX).translationY(moveY).setDuration(300).start();
                          
                          h.postDelayed(this, 3000);
                      }
                  });
              }
              @Override public IBinder onBind(android.content.Intent i) { return null; }
          }
          EOF

      - name: ğŸš€ 6. MainActivity
        run: |
          cat <<EOF > app/src/main/java/com/geass/shell/MainActivity.java
          package com.geass.shell;
          import android.app.Activity;
          import android.content.Intent;
          import android.net.Uri;
          import android.os.*;
          import android.provider.Settings;
          public class MainActivity extends Activity {
              @Override protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && !Settings.canDrawOverlays(this)) {
                      startActivityForResult(new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION, Uri.parse("package:" + getPackageName())), 101);
                  } else { startService(new Intent(this, FloatingService.class)); finish(); }
              }
              @Override protected void onActivityResult(int req, int res, Intent d) {
                  if(req == 101) { startService(new Intent(this, FloatingService.class)); finish(); }
              }
          }
          EOF

      - name: ğŸ”¨ 7. Build
        run: |
          echo "include ':app'" > settings.gradle
          echo "buildscript { repositories { google(); mavenCentral() }; dependencies { classpath 'com.android.tools.build:gradle:7.2.1' } }" > build.gradle
          echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle
          echo "apply plugin: 'com.android.application'; android { compileSdkVersion 31; namespace 'com.geass.shell'; defaultConfig { applicationId 'com.geass.shell'; minSdkVersion 26; targetSdkVersion 31; versionCode 1; versionName '1.0' } }" > app/build.gradle
          wget -q https://services.gradle.org/distributions/gradle-7.5-bin.zip
          unzip -q gradle-7.5-bin.zip
          ./gradle-7.5/bin/gradle :app:assembleDebug --no-daemon

      - name: ğŸ“¦ 8. Release
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/debug/app-debug.apk
          tag_name: "v_vision_fixed_size"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}