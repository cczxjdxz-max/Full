name: Geass_Sovereign_Final_Vision
on:
  workflow_dispatch:

jobs:
  build_geass:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§  Phase 1: Logic Injection
        # ØªÙ… ØªØ¨Ø³ÙŠØ· Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ØªÙ…Ø§Ù…Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„Ø³Ø·Ø± 12
        run: |
          mkdir -p app/src/main/assets
          echo '{"vision_active": true, "pupil_focus": 1.2}' > app/src/main/assets/logic.json
          echo "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³: ØªÙ… Ø­Ù‚Ù† Ø¬ÙˆÙ‡Ø± Ø§Ù„Ø±Ø¤ÙŠØ©."

      - name: ğŸ—ï¸ Phase 2: Resource Setup
        run: |
          mkdir -p app/src/main/java/com/geass/shell
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/drawable
          # Ù†Ù‚Ù„ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙˆØ¶Ø¹ØªÙ‡Ø§ ÙÙŠÙ‡
          cp build/geass_eye_base.png app/src/main/res/drawable/ || echo "Base missing"
          cp build/pupil.png app/src/main/res/drawable/ || echo "Pupil missing"
          cp build/geass_icon.png app/src/main/res/drawable/ || echo "Icon missing"

      - name: ğŸ¨ Phase 3: Vision UI (The Sensor)
        run: |
          cat <<EOF > app/src/main/res/layout/floating_layout.xml
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="120dp" android:layout_height="120dp">
              <ImageView android:id="@+id/pupil"
                  android:layout_width="45dp" android:layout_height="45dp"
                  android:layout_gravity="center"
                  android:src="@drawable/pupil" />
              <ImageView android:id="@+id/geass_eye_base"
                  android:layout_width="match_parent" android:layout_height="match_parent"
                  android:src="@drawable/geass_eye_base" />
          </FrameLayout>
          EOF

      - name: ğŸ§  Phase 4: Vision Engine (Floating Service)
        run: |
          cat <<EOF > app/src/main/java/com/geass/shell/FloatingService.java
          package com.geass.shell;
          import android.app.*;
          import android.graphics.PixelFormat;
          import android.view.*;
          import android.os.*;
          import android.widget.ImageView;

          public class FloatingService extends Service {
              private WindowManager wm;
              private View root;
              private Handler mainHandler = new Handler(Looper.getMainLooper());

              @Override public void onCreate() {
                  super.onCreate();
                  wm = (WindowManager) getSystemService(WINDOW_SERVICE);
                  root = LayoutInflater.from(this).inflate(R.layout.floating_layout, null);
                  WindowManager.LayoutParams p = new WindowManager.LayoutParams(
                      300, 300, WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE, PixelFormat.TRANSLUCENT);
                  p.gravity = Gravity.CENTER;
                  wm.addView(root, p);
                  startSystemBlink();
                  startVisionPulse();
              }

              private void startSystemBlink() {
                  mainHandler.postDelayed(new Runnable() {
                      @Override public void run() {
                          final ImageView eyelid = root.findViewById(R.id.geass_eye_base);
                          eyelid.animate().scaleY(0f).setDuration(150).withEndAction(() -> {
                              eyelid.animate().scaleY(1f).setDuration(150).start();
                              startSystemBlink();
                          }).start();
                      }
                  }, 4000);
              }

              private void startVisionPulse() {
                  final ImageView pupil = root.findViewById(R.id.pupil);
                  mainHandler.postDelayed(new Runnable() {
                      @Override public void run() {
                          float targetY = (float)(Math.random() * -50); 
                          float targetX = (float)(Math.random() * 80 - 40);
                          pupil.animate().translationY(targetY).translationX(targetX)
                               .scaleX(1.2f).scaleY(1.2f).setDuration(100)
                               .withEndAction(() -> pupil.animate().scaleX(1f).scaleY(1f).setDuration(100).start())
                               .start();
                          mainHandler.postDelayed(this, 800);
                      }
                  }, 1000);
              }
              @Override public IBinder onBind(Intent i) { return null; }
          }
          EOF

      - name: ğŸ”¨ Final Compilation
        run: |
          echo "include ':app'" > settings.gradle
          echo "buildscript { repositories { google(); mavenCentral() }; dependencies { classpath 'com.android.tools.build:gradle:7.2.1' } }" > build.gradle
          echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle
          echo "apply plugin: 'com.android.application'; android { compileSdkVersion 31; namespace 'com.geass.shell'; defaultConfig { applicationId 'com.geass.shell'; minSdkVersion 26; targetSdkVersion 31 } }" > app/build.gradle
          wget -q https://services.gradle.org/distributions/gradle-7.5-bin.zip
          unzip -q gradle-7.5-bin.zip
          ./gradle-7.5/bin/gradle :app:assembleDebug --no-daemon

      - name: ğŸ“¦ Release
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/debug/app-debug.apk
          tag_name: "v_vision_embodiment_fixed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
