name: 2. The Executor (BODY)

on:
  repository_dispatch:
    types: [execute_extraction_plan]

jobs:
  execute_the_plan:
    runs-on: ubuntu-latest
    steps:
      - name: "Receive and Write Plan"
        id: receive_plan
        env:
          # نضع الخطة المرسلة داخل متغير بيئة لحمايتها من تفسير Bash
          PLAN_CODE: ${{ github.event.client_payload.plan }}
        run: |
          # نستخدم بايثون لكتابة المتغير إلى ملف لضمان سلامة الرموز
          python3 -c "import os; open('miner_script.py', 'w').write(os.environ['PLAN_CODE'])"

      - name: "Prepare environment for execution"
        run: chmod +x miner_script.py

      - name: "Execute the Manager's plan"
        env:
          GAME_DOWNLOAD_URL: "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
        run: |
          echo "Executing the plan designed by The Manager..."
          # تنفيذ السكربت
          python3 miner_script.py

      - name: "Secure the extracted assets"
        # نستخدم || true لضمان عدم توقف الأكشن إذا لم يجد ملفات
        run: |
          echo "Packaging results..."
          mkdir -p CORE_DATA
          zip -r core_data.zip CORE_DATA || echo "No data found to zip"

      - name: "Report success by creating a Release"
        uses: softprops/action-gh-release@v1
        # سيتم إنشاء الريليز فقط إذا وجد ملف المضغوط
        if: success()
        with:
          files: core_data.zip
          name: "Extraction-Report-${{ github.run_id }}"
          tag_name: "data-v${{ github.run_id }}"
          body: "Mission accomplished as per The Manager's plan. Core data secured."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}