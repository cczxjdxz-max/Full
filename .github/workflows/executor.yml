name: 2. The Executor (BODY) - Matrix Collector

on:
  repository_dispatch:
    types: [evolve_and_execute]

permissions:
  contents: write

jobs:
  execute_and_collect:
    runs-on: ubuntu-latest
    steps:
      - name: "Receive Plan"
        env:
          PLAN_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          python3 -c "import os, json; open('plan_script.py', 'w').write(json.loads(os.environ['PLAN_PAYLOAD'])['plan_script'])"

      - name: "Execution and Validation"
        run: |
          echo "Executing the AI Data Mine..."
          python3 plan_script.py > execution_log.txt 2>&1
          
          # فحص حقيقي: إذا كان المجلد فارغاً أو غير موجود، نعتبر العملية فشلت
          if [ ! -d "CORE_DATA" ] || [ -z "$(ls -A CORE_DATA)" ]; then
            echo "CRITICAL ERROR: No data was extracted (Fake Success detected)."
            exit 1
          fi

      - name: "Package Matrix Data"
        if: success()
        run: |
          mkdir -p CORE_DATA
          find . -maxdepth 5 -name "*.json" -o -name "*.bytes" -o -name "*.dll" | xargs -I{} cp --parents {} CORE_DATA/ || true
          zip -r -9 matrix_data.zip CORE_DATA

      - name: "Release Data"
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          files: matrix_data.zip
          name: "REAL-DATA-v${{ github.run_id }}"
          tag_name: "v${{ github.run_id }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  report_failure:
    runs-on: ubuntu-latest
    needs: [execute_and_collect]
    if: failure()
    steps:
      - name: "Send Real Log to Manager"
        run: |
          # نرسل آخر 50 سطر لنفهم لماذا حدث النجاح الوهمي
          report=$(tail -n 50 execution_log.txt || echo "Timeout or silent failure")
          encoded=$(echo "$report" | base64 -w 0)
          curl -X POST -H "Authorization: token ${{ secrets.PAT }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/cczxjdxz-max/avatar-template/dispatches \
          -d "{\"event_type\": \"analyze_failure\", \"client_payload\": {\"execution_log\": \"$encoded\"}}"