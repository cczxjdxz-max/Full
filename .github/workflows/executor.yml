name: 2. The Executor (BODY)

on:
  repository_dispatch:
    types: [execute_extraction_plan]

permissions:
  contents: write # مهم جداً لإنشاء الـ Release

jobs:
  execute_the_plan:
    runs-on: ubuntu-latest
    steps:
      - name: "Receive and Write Plan"
        env:
          PLAN_CODE: ${{ github.event.client_payload.plan }}
        run: |
          python3 -c "import os; open('miner_script.py', 'w').write(os.environ['PLAN_CODE'])"

      - name: "Execute the Manager's plan"
        run: |
          echo "Executing the plan..."
          # تشغيل السكربت مع تجاهل الأخطاء غير القاتلة
          python3 miner_script.py || echo "Script encountered an issue but continuing..."

      - name: "Final Data Collection"
        # هذه الخطوة تعمل كـ 'تأمين' إضافي في حال فشل السكربت في نقل الملفات
        run: |
          mkdir -p CORE_DATA
          # البحث عن أي ملفات مهمة تم استخراجها ووضعها في المجلد النهائي
          find . -maxdepth 4 -name "*.json" -o -name "*.xml" -o -name "*.lua" | xargs -I{} cp --parents {} CORE_DATA/ || true
          zip -r core_data.zip CORE_DATA

      - name: "Report success by creating a Release"
        uses: softprops/action-gh-release@v1
        if: always() # سيحاول إنشاء ريليز حتى لو حدثت أخطاء جزئية
        with:
          files: core_data.zip
          name: "Extraction-Report-${{ github.run_id }}"
          tag_name: "v${{ github.run_id }}"
          body: "Extraction completed. Check the attached zip for assets."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}