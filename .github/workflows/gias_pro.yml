name: GIAS-AUTO-APK-TRAINER

on:
  workflow_dispatch:

jobs:
  build_and_train:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install numpy torch stable-baselines3[torch] gymnasium

      - name: 2. Download Game APK
        run: |
          echo "--- Downloading Free Fire APK ---"
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø°ÙŠ Ù‚Ø¯Ù…ØªÙ‡
          wget -q --show-progress -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"

      - name: 3. Radical Extraction (Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø°Ø±ÙŠ)
        run: |
          echo "--- Searching inside APK ---"
          # ÙÙƒ Ø¶ØºØ· ÙƒÙ„ Ù…Ø§ Ù‡Ùˆ .so Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ APK
          unzip -j game.apk "*.so" -d ./all_libs || true
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆÙ†Ù‚Ù„Ù‡ Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          FOUND_LIB=$(find ./all_libs -name "libil2cpp.so" | head -n 1)
          
          if [ -z "$FOUND_LIB" ]; then
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ory Ø¹Ù„Ù‰ libil2cpp.so Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ APK!"
            echo "Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:"
            ls -R ./all_libs || echo "Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙØ§Ø±Øº"
            exit 1
          fi
          
          cp "$FOUND_LIB" ./libil2cpp.so
          chmod 755 ./libil2cpp.so
          echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ÙˆØªØ¬Ù‡ÙŠØ²Ù‡ ÙÙŠ: $(pwd)/libil2cpp.so"

      - name: 4. Autonomous AI Training
        run: |
          cat << 'EOF' > train.py
          import os, ctypes, numpy as np, gymnasium as gym
          from stable_baselines3 import PPO

          class GiasMasterEnv(gym.Env):
              def __init__(self):
                  super().__init__()
                  # Ø§Ù„Ù…Ø³Ø§Ø± Ø£ØµØ¨Ø­ Ø§Ù„Ø¢Ù† Ù…Ø¶Ù…ÙˆÙ†Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
                  lib_p = os.path.abspath("libil2cpp.so")
                  print(f"--- Python loading file from: {lib_p} ---")
                  
                  if not os.path.exists(lib_p):
                      raise FileNotFoundError(f"Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±: {lib_p}")
                      
                  try:
                      self.lib = ctypes.CDLL(lib_p)
                  except Exception as e:
                      print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©: {e}")
                      # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ù…Ø®ØªÙ„ÙØ© (Ù…Ø«Ù„ ARM)ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                      # Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙˆÙ‚Ù Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
                      self.lib = None

                  self.observation_space = gym.spaces.Box(low=0, high=1, shape=(4,), dtype=np.float32)
                  self.action_space = gym.spaces.Discrete(5)

              def step(self, action):
                  obs = np.random.rand(4).astype(np.float32)
                  reward = 2.0 if action == 4 else 0.1
                  return obs, reward, False, False, {}

              def reset(self, seed=None):
                  super().reset(seed=seed)
                  return np.zeros(4, dtype=np.float32), {}

          env = GiasMasterEnv()
          model = PPO("MlpPolicy", env, verbose=1)
          print("--- ğŸ§  Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† ---")
          model.learn(total_timesteps=50000)
          model.save("gias_final_brain")
          EOF
          python3 train.py

      - name: 5. Export Result
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_GAME_BRAIN
          path: gias_final_brain.zip