name: GIAS-AUTO-APK-TRAINER

on:
  workflow_dispatch:

jobs:
  build_and_train:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install numpy torch stable-baselines3[torch] gymnasium

      - name: 2. Download Game APK (ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©)
        run: |
          echo "--- Downloading Free Fire APK ---"
          wget -q --show-progress -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"

      - name: 3. Extract libil2cpp.so (Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹)
        run: |
          echo "--- Extracting Library ---"
          # ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù€ APK Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
          unzip -q game.apk "lib/*" -d ./extracted_lib
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ Ù†Ø³Ø®Ø© (x86_64 Ù„Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø£Ùˆ arm64 Ù„Ù„Ù‡ÙˆØ§ØªÙ)
          # Ø³Ù†Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ù†Ø³Ø®Ø© x86_64 Ù„Ø£Ù†Ù‡Ø§ ØªØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø£Ø¹Ù„Ù‰ Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ±Ø§Øª GitHub
          SO_FILE=$(find ./extracted_lib -name "libil2cpp.so" | grep "x86_64" | head -n 1)
          
          # Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ Ø³Ù†Ø£Ø®Ø° Ø£ÙŠ Ù†Ø³Ø®Ø© Ù…ØªØ§Ø­Ø©
          if [ -z "$SO_FILE" ]; then
            SO_FILE=$(find ./extracted_lib -name "libil2cpp.so" | head -n 1)
          fi
          
          if [ -z "$SO_FILE" ]; then
            echo "âŒ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„Ù! Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø­Ù…ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø®ØªÙ„Ù."
            ls -R ./extracted_lib
            exit 1
          fi
          
          cp "$SO_FILE" ./libil2cpp.so
          echo "âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù†: $SO_FILE"

      - name: 4. Autonomous AI Training (Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
        run: |
          cat << 'EOF' > train.py
          import os, ctypes, numpy as np, gymnasium as gym
          from stable_baselines3 import PPO

          class GiasMasterEnv(gym.Env):
              def __init__(self):
                  super().__init__()
                  lib_p = os.path.abspath("libil2cpp.so")
                  # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                  self.lib = ctypes.CDLL(lib_p)
                  
                  # [ØµØ­Ø©ØŒ Ø°Ø®ÙŠØ±Ø©ØŒ Ø¬Ø¯Ø±Ø§Ù†ØŒ Ù…Ø³Ø§ÙØ©]
                  self.observation_space = gym.spaces.Box(low=0, high=1, shape=(4,), dtype=np.float32)
                  self.action_space = gym.spaces.Discrete(5)

              def step(self, action):
                  # Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                  obs = np.random.rand(4).astype(np.float32)
                  reward = 2.0 if action == 4 else 0.1 # Ù…ÙƒØ§ÙØ£Ø© ÙƒØ¨ÙŠØ±Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ø¯Ø§Ø± Ø§Ù„Ø¬Ù„Ùˆ
                  return obs, reward, False, False, {}

              def reset(self, seed=None):
                  super().reset(seed=seed)
                  return np.zeros(4, dtype=np.float32), {}

          # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (100 Ø£Ù„Ù Ø®Ø·ÙˆØ© Ù„ÙŠØµØ¨Ø­ Ù…Ø­ØªØ±ÙØ§Ù‹)
          model = PPO("MlpPolicy", GiasMasterEnv(), verbose=1)
          print("--- ğŸ§  Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ø¯Ø£ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ---")
          model.learn(total_timesteps=100000)
          model.save("gias_final_brain")
          EOF
          python3 train.py

      - name: 5. Export Final Brain
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_GAME_BRAIN
          path: gias_final_brain.zip