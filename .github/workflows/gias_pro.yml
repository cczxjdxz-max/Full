name: GIAS-ULTIMATE-AUTO-GYM

on:
  workflow_dispatch:
    inputs:
      environment_run_id:
        description: 'Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¦Ø© (Run ID)'
        required: true

jobs:
  everything_machine:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install numpy torch stable-baselines3[torch] gymnasium pyelftools

      - name: 2. Download Training Data
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.inputs.environment_run_id }}
          name: AI_Data_Ready_Lib
          path: ./temp_artifacts

      - name: 3. Smart Linker (Ø±Ø¨Ø· Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©)
        run: |
          # Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙˆÙ†Ù‚Ù„Ù‡ Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          FILE_PATH=$(find ./temp_artifacts -name "libil2cpp.so" | head -n 1)
          if [ -z "$FILE_PATH" ]; then
            echo "âŒ Ù…Ù„Ù libil2cpp.so ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ!"
            exit 1
          fi
          cp "$FILE_PATH" ./libil2cpp.so
          chmod 755 ./libil2cpp.so
          echo "âœ… Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ ÙÙŠ: $(pwd)/libil2cpp.so"

      - name: 4. Train the Legend (Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ)
        run: |
          cat << 'EOF' > train.py
          import os, ctypes, numpy as np
          import gymnasium as gym
          from stable_baselines3 import PPO

          class GiasProEnv(gym.Env):
              def __init__(self):
                  super().__init__()
                  lib_p = os.path.abspath("./libil2cpp.so")
                  self.lib = ctypes.CDLL(lib_p)
                  
                  # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­ÙˆØ§Ø³: [Ø§Ù„ØµØ­Ø©ØŒ Ø§Ù„Ø°Ø®ÙŠØ±Ø©ØŒ Ø¬Ø¯Ø±Ø§Ù† Ø§Ù„Ø¬Ù„ÙˆØŒ Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¹Ø¯Ùˆ]
                  self.observation_space = gym.spaces.Box(low=0, high=1, shape=(4,), dtype=np.float32)
                  # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£ÙØ¹Ø§Ù„: [Ø«Ø¨Ø§ØªØŒ Ø­Ø±ÙƒØ©ØŒ Ø¥Ø·Ù„Ø§Ù‚ØŒ Ù‚ÙØ²ØŒ ÙˆØ¶Ø¹ Ø¬Ø¯Ø§Ø±]
                  self.action_space = gym.spaces.Discrete(5)

              def step(self, action):
                  # Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯ÙˆØ§Ù„ libil2cpp Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
                  # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø°ÙƒÙŠØ© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø³Ø±ÙŠØ¹
                  obs = np.random.uniform(0.1, 1.0, size=(4,)).astype(np.float32)
                  
                  # Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: Ù…ÙƒØ§ÙØ£Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ø¨Ù‚Ø§Ø¡ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙØ§Ø¹ (Ø§Ù„Ø¬Ø¯Ø§Ø±)
                  reward = 0.2
                  if action == 4: reward += 1.5 # ØªØ´Ø¬ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ø¯Ø±Ø§Ù† Ø§Ù„Ø¬Ù„Ùˆ
                  
                  done = False # ÙÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù†Ø¬Ø¹Ù„Ù‡ ÙŠØ³ØªÙ…Ø± Ù„Ù„ØªØ¹Ù„Ù… Ø£ÙƒØ«Ø±
                  return obs, reward, done, False, {}

              def reset(self, seed=None):
                  super().reset(seed=seed)
                  return np.array([1.0, 1.0, 1.0, 1.0], dtype=np.float32), {}

          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù‚Ù„ (PPO) Ø¨Ù€ 100 Ø£Ù„Ù Ø®Ø·ÙˆØ©
          env = GiasProEnv()
          model = PPO("MlpPolicy", env, verbose=1, learning_rate=0.0003)
          
          print("--- ğŸ§  Ø§Ù„Ø±ÙˆØ¨ÙˆØª Ø¨Ø¯Ø£ ÙŠØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù† (100,000 Ù…Ø­Ø§ÙˆÙ„Ø©) ---")
          model.learn(total_timesteps=100000)
          
          model.save("gias_pro_brain")
          print("--- âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­! ---")
          EOF
          python3 train.py

      - name: 5. Export Final Brain
        uses: actions/upload-artifact@v4
        with:
          name: PRO_AI_BRAIN
          path: gias_pro_brain.zip