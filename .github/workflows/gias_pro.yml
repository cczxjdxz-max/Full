name: GIAS-ULTIMATE-AUTO-GYM

on:
  workflow_dispatch:
    inputs:
      environment_run_id:
        description: 'Ø±Ù‚Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¦Ø©'
        required: true

jobs:
  everything_machine:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install numpy torch stable-baselines3[torch] gymnasium pyelftools

      - name: 2. Download Artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.inputs.environment_run_id }}
          name: AI_Data_Ready_Lib
          path: ./temp_download

      - name: 3. Smart Extraction (ÙÙƒ Ø§Ù„Ø¶ØºØ· ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø±)
        run: |
          echo "--- Looking for the library file ---"
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…Ø¶ØºÙˆØ·Ø§Ù‹ØŒ Ø³Ù†Ø­Ø§ÙˆÙ„ ÙÙƒÙ‡
          find ./temp_download -name "*.zip" -exec unzip -o {} -d ./temp_download \;
          
          # Ø§Ù„Ø¢Ù† Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙØ¹Ù„ÙŠ libil2cpp.so ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
          ACTUAL_FILE=$(find . -name "libil2cpp.so" | head -n 1)
          
          if [ -z "$ACTUAL_FILE" ]; then
            echo "âŒ ERROR: libil2cpp.so not found!"
            ls -R
            exit 1
          fi
          
          echo "Found file at: $ACTUAL_FILE"
          # Ù†Ù‚Ù„Ù‡ Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ÙŠÙƒÙˆÙ† Ø¨Ø¬Ø§Ù†Ø¨ Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø§ÙŠØ«ÙˆÙ†
          cp "$ACTUAL_FILE" ./libil2cpp.so
          chmod +x ./libil2cpp.so
          echo "âœ… File is ready at: $(pwd)/libil2cpp.so"

      - name: 4. The Professional Training Script
        run: |
          cat << 'EOF' > train.py
          import os, ctypes, numpy as np
          import gymnasium as gym
          from stable_baselines3 import PPO

          class GiasProEnv(gym.Env):
              def __init__(self):
                  super().__init__()
                  # Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¢Ù† Ø«Ø§Ø¨Øª ÙˆÙ…Ø¶Ù…ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                  lib_p = os.path.abspath("libil2cpp.so")
                  print(f"--- Python loading: {lib_p} ---")
                  
                  self.lib = ctypes.CDLL(lib_p)
                  
                  # [ØµØ­Ø©ØŒ Ø°Ø®ÙŠØ±Ø©ØŒ Ø¬Ø¯Ø±Ø§Ù†ØŒ Ù…Ø³Ø§ÙØ©]
                  self.observation_space = gym.spaces.Box(low=0, high=1, shape=(4,), dtype=np.float32)
                  self.action_space = gym.spaces.Discrete(5)

              def step(self, action):
                  # Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙŠØªØ¹Ù„Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)
                  obs = np.random.uniform(0.1, 1.0, size=(4,)).astype(np.float32)
                  # Ù…ÙƒØ§ÙØ£Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ø¯Ø§Ø± Ø§Ù„Ø¬Ù„Ùˆ (Action 4)
                  reward = 1.0 if action == 4 else 0.05
                  return obs, reward, False, False, {}

              def reset(self, seed=None):
                  super().reset(seed=seed)
                  return np.array([1.0, 1.0, 1.0, 1.0], dtype=np.float32), {}

          # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ
          env = GiasProEnv()
          model = PPO("MlpPolicy", env, verbose=1)
          print("--- ğŸ§  AI Training Started! ---")
          model.learn(total_timesteps=100000)
          model.save("gias_pro_brain")
          EOF
          python3 train.py

      - name: 5. Export Final Brain
        uses: actions/upload-artifact@v4
        with:
          name: PRO_AI_BRAIN
          path: gias_pro_brain.zip