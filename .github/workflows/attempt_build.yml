name: 2. The Executor
on:
  repository_dispatch:
    types: [execute_mission]

jobs:
  execute_task:
    runs-on: ubuntu-latest
    steps:
      # الخطوة 1: استنساخ الكود
      - name: "1. Checkout Code"
        uses: actions/checkout@v4

      # الخطوة 2: محاولة تنفيذ المهمة
      - name: "2. Execute Mission"
        id: execution_step
        # السماح للخطوة بالفشل دون إيقاف السير بالكامل
        continue-on-error: true
        run: |
          echo "Executor is attempting to execute the mission..."
          # تنفيذ الأوامر المستلمة من القائد
          eval "${{ github.event.client_payload.commands }}"
          # هذا السطر يحتوي على خطأ مقصود للاختبار (اسم حزمة غير موجود)
          sudo apt-get install non_existent_package_for_testing

      # الخطوة 3: الإبلاغ عن الفشل (يعمل فقط إذا فشلت الخطوة السابقة)
      - name: "3. Report Failure to Manager"
        if: steps.execution_step.outcome == 'failure'
        env:
          PAT: ${{ secrets.PAT }}
          # اسم مستودع القائد
          MANAGER_REPO: cczxjdxz-max/avatar-template
        run: |
          echo "Execution failed. Reporting error log to the Manager..."
          # هنا يجب أن نجمع سجل الخطأ الفعلي، لكن للمحاكاة سنرسل رسالة
          ERROR_MESSAGE="Execution failed at step 'Execute Mission'. The command 'sudo apt-get install non_existent_package_for_testing' returned a non-zero exit code."
          
          # تغليف رسالة الخطأ في JSON
          JSON_PAYLOAD=$(jq -n --arg log "$ERROR_MESSAGE" '{"event_type": "executor_failed", "client_payload": {"error_log": $log}}')

          # إرسال تقرير الخطأ إلى القائد
          curl -L -X POST -H "Authorization: Bearer $PAT" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/${{ env.MANAGER_REPO }}/dispatches \
               -d "$JSON_PAYLOAD"
          # إنهاء المهمة بفشل
          exit 1

      # الخطوة 4: الإبلاغ عن النجاح (يعمل فقط إذا نجحت كل الخطوات)
      - name: "4. Report Success"
        if: success()
        run: |
          echo "Mission completed successfully."
          # في المستقبل، يمكن إرسال إشارة نجاح إلى القائد هنا أيضاً