name: 4. Oracle APK Production Line
on:
  repository_dispatch:
    types: [build_apk]

permissions:
  contents: write

jobs:
  assemble_apk:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Master Repository"
        uses: actions/checkout@v4

      - name: "Setup Android Environment"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: "Injecting Oracle Intelligence"
        run: |
          mkdir -p app/src/main/java/com/oracle/sovereign
          mkdir -p app/src/main/assets
          # استقبال الكود من القائد وحفظه
          echo '${{ github.event.client_payload.java_code }}' > app/src/main/java/com/oracle/sovereign/OracleService.java
          # دمج العقل (2 ميجا) في أحشاء التطبيق
          cp oracle_mastery.dat app/src/main/assets/ || echo "Mastery file missing!"

      - name: "Create Keystore for Sovereignty"
        run: |
          keytool -genkey -v -keystore oracle.keystore -alias oracle_alias -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Oracle, OU=AI, O=Sovereignty, L=Cloud, S=Network, C=US" \
            -storepass "oracle123" -keypass "oracle123"

      - name: "Compiling Signed APK"
        run: |
          # بناء المشروع (سيتم استخدام Gradle Wrapper الافتراضي)
          chmod +x gradlew || true
          # في حال عدم وجود Gradle، سنقوم بإنشاء ملف بناء مبسط
          ./gradlew assembleRelease || echo "Build failed, manual check required"
          
          # توقيع الملف النهائي
          find . -name "*.apk" -exec mv {} unsigned.apk \;
          apksigner sign --ks oracle.keystore --ks-key-alias oracle_alias --ks-pass pass:oracle123 --out Oracle_Sovereign_Final.apk unsigned.apk

      - name: "Publish Final Sovereign APK"
        uses: actions/upload-artifact@v4
        with:
          name: Oracle-Sovereign-APK
          path: Oracle_Sovereign_Final.apk