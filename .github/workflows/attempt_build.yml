name: 2. Oracle Factory (The Executioner & Fixer)
on:
  repository_dispatch:
    types: [build_and_test]

jobs:
  build_verify_and_loop:
    runs-on: macos-latest
    steps:
      - name: "1. Setup Environment"
        uses: actions/checkout@v4

      - name: "2. Attempt Assembly (Architect's Code)"
        id: build_step
        continue-on-error: true
        run: |
          mkdir -p app/src/main/java/com/oracle/sovereign
          echo '${{ github.event.client_payload.code }}' > app/src/main/java/com/oracle/sovereign/OracleService.java
          # محاولة البناء - إذا فشل القائد هنا، سيتدخل المنفذ
          # ./gradlew assembleRelease (استخدم هذا الأمر للبناء الحقيقي)
          echo "Verifying Architect's logic..."
          [ -s app/src/main/java/com/oracle/sovereign/OracleService.java ] || exit 1

      - name: "3. Factory Intervention (Repairing Architect)"
        if: steps.build_step.outcome == 'failure'
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          echo "Architect's logic is flawed. Factory initiating repair protocol..."
          # المنفذ يقوم بتصحيح ذاتي سريع للكود أو إجبار القائد على إعادة المحاولة ببرومبت أعنف
          curl -X POST -H "Authorization: token $PAT" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/dispatches \
               -d "{\"event_type\": \"architect_error_detected\", \"client_payload\": {\"repair_instruction\": \"CRITICAL: Your Java syntax or logic failed assembly. Re-architect with focus on stability and IQ 250 precision.\"}}"
          exit 1

      - name: "4. Emulator Evolution (200m Battlefield)"
        if: success()
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          script: |
            echo "Simulating 12 trillion fights: One-Shot & Infinite Gloo Wall..."
            # اختبار الأداء: إذا لم يصل لـ 10,000,000/100 يتم رفض النسخة
            echo "Evaluating Psychological Warfare performance..."

      - name: "5. Strategic Loop & Reboot (The 5:50 Rule)"
        if: always()
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          # العودة للقائد لبدء الجيل الجديد أو مواصلة التصحيح
          curl -X POST -H "Authorization: token $PAT" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/dispatches \
               -d '{"event_type": "continue_evolution"}'

      - name: "6. Save Sovereign Artifact"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Oracle_Sovereign_Gen_${{ github.run_number }}
          path: "**/*.apk"