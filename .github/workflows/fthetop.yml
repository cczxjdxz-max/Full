name: TOTAL-REPAIR-V3-FINAL

on:
  workflow_dispatch:

jobs:
  full_rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          # ØªØ­Ù…ÙŠÙ„ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. FETCH LATEST RELEASE (Auto-download)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          file: 'Geass_Internal_Citadel.apk'
          target: './broken.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 3. DEEP SURGERY (Decompile & Patch)
        run: |
          echo "ğŸ—ï¸ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚..."
          java -jar apktool.jar d broken.apk -o decoded_dir -f
          
          echo "ğŸ’‰ Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙÙƒÙˆÙƒ..."
          # Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø¨Ù„ ÙˆØ³Ù… application Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' decoded_dir/AndroidManifest.xml
          
          echo "ğŸ—ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„Ø© (Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†)..."
          java -jar apktool.jar b decoded_dir -o repatched_unsigned.apk
          
          echo "ğŸ” Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ (V2/V3)..."
          java -jar signer.jar --apks repatched_unsigned.apk --out ./ --allowResign
          
          # ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
          mv repatched_unsigned-aligned-debugSigned.apk Geass_Master_V3.apk

      - name: 4. FINAL VERIFICATION (Self-Check)
        run: |
          # ÙØ­Øµ Ø¯Ø§Ø®Ù„ÙŠ Ø³Ø±ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
          unzip -p Geass_Master_V3.apk AndroidManifest.xml | strings | grep "SYSTEM_ALERT_WINDOW" && echo "FINAL_CHECK=PASSED" >> $GITHUB_ENV || echo "FINAL_CHECK=FAILED" >> $GITHUB_ENV

      - name: 5. PUBLISH REPAIRED RELEASE
        if: env.FINAL_CHECK == 'PASSED'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v3.0-final"
          name: "Geass Citadel - Master Fix"
          body: "ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ù…Ù„: Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ù‚ÙˆÙ†Ø© Ø¨Ù†Ø³Ø¨Ø© 100% ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙƒØ§Ù…Ù„ V2/V3."
          files: Geass_Master_V3.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}