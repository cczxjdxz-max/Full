name: TOTAL-REPAIR-V3-DIRECT

on:
  workflow_dispatch:

jobs:
  full_rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. DIRECT DOWNLOAD
        run: |
          echo "ğŸ“¥ Downloading from direct link..."
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ Ù„ÙŠ
          curl -L "https://release-assets.githubusercontent.com/github-production-release-asset/1140560756/2ba806ea-4930-426a-ac86-c5c58fa7e548?sp=r&sv=2018-11-09&sr=b&spr=https&se=2026-02-02T23%3A06%3A01Z&rscd=attachment%3B+filename%3DGeass_Internal_Citadel.apk&rsct=application%2Fvnd.android.package-archive&skoid=96c2d410-5711-43a1-aedd-ab1947aa7ab0&sktid=398a6654-997b-47e9-b12b-9515b896b4de&skt=2026-02-02T22%3A05%3A36Z&ske=2026-02-02T23%3A06%3A01Z&sks=b&skv=2018-11-09&sig=s4ghLatFIhueRhPtuyibj%2FPNH5D6V9uQgXSMKbf8Hvo%3D&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZS1hc3NldHMuZ2l0aHVidXNlcmNvbnRlbnQuY29tIiwia2V5Ijoia2V5MSIsImV4cCI6MTc3MDA3MzUzNiwibmJmIjoxNzcwMDY5OTM2LCJwYXRoIjoicmVsZWFzZWFzc2V0cHJvZHVjdGlvbi5ibG9iLmNvcmUud2luZG93cy5uZXQifQ.-bz5Bm2bGcr_BAYm6bOdMcsmJzHRZS7g4AjLvwXmPoc&response-content-disposition=attachment%3B%20filename%3DGeass_Internal_Citadel.apk&response-content-type=application%2Fvnd.android.package-archive" -o broken.apk

      - name: 3. DEEP SURGERY
        run: |
          echo "ğŸ—ï¸ Decompiling..."
          java -jar apktool.jar d broken.apk -o decoded_dir -f
          
          echo "ğŸ’‰ Injecting Floating Window Permission..."
          # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€ Manifest ÙÙŠ Ø¨ÙŠØ¦Ø© Ù…ÙÙƒÙˆÙƒØ© ÙŠØ¶Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ 100%
          sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' decoded_dir/AndroidManifest.xml
          
          echo "ğŸ—ï¸ Rebuilding (Please wait, this takes time)..."
          java -jar apktool.jar b decoded_dir -o patched_unsigned.apk
          
          echo "ğŸ” Full V2/V3 Signing..."
          java -jar signer.jar --apks patched_unsigned.apk --out ./ --allowResign
          
          mv patched_unsigned-aligned-debugSigned.apk Geass_Master_V3.apk

      - name: 4. PUBLISH REPAIRED RELEASE
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v3.0-final"
          name: "Geass Citadel - Master Fix"
          files: Geass_Master_V3.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}