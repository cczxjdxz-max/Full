name: All-In-One Offset Extractor

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Build Il2CppDumper from Source
        run: |
          git clone https://github.com/Perfare/Il2CppDumper.git
          cd Il2CppDumper
          # بناء الأداة
          dotnet publish -c Release -f net8.0 -r linux-x64 --self-contained true /p:PublishSingleFile=true
          
          # البحث عن الملف التنفيذي في كل المجلدات الناتجة ونقله للمجلد الرئيسي
          # نستخدم -iname للبحث بغض النظر عن حالة الأحرف
          find . -type f -executable -name "Il2CppDumper" -exec cp {} ../Il2CppDumper \;
          
          cd ..
          if [ -f "./Il2CppDumper" ]; then
            chmod +x Il2CppDumper
            echo "[+] Il2CppDumper is ready at $(pwd)/Il2CppDumper"
          else
            echo "[-] Error: Executable not found after build!"
            exit 1
          fi

      - name: Run Il2CppDumper
        run: |
          if [ -f "libil2cpp.so" ] && [ -f "global-metadata.dat" ]; then
            # تشغيل الأداة مع توجيه الإدخالات تلقائياً (تجنب التوقف لطلب إدخال)
            echo -e "\n" | ./Il2CppDumper libil2cpp.so global-metadata.dat .
          else
            echo "[-] Error: Missing game files in root directory!"
            exit 1
          fi
        continue-on-error: true

      - name: Extract Offsets using Inline Python
        shell: python
        run: |
          import os, re, json, gzip
          
          dump_file = "dump.cs"
          output_zip = "offsets.json.gz"
          
          if os.path.exists(dump_file):
              print("[+] Starting extraction...")
              # نمط البحث عن العناوين والأسماء
              pattern = re.compile(r"// RVA: (0x[A-F0-9]+).*?\n\s+.*? ([\w_<>]+)\(")
              extracted_data = {}
              
              with open(dump_file, "r", encoding="utf-8") as f:
                  content = f.read()
                  for match in pattern.finditer(content):
                      address, name = match.groups()
                      extracted_data[name] = address
              
              # حفظ وضغط البيانات بصيغة JSON
              json_bytes = json.dumps(extracted_data, separators=(',', ':')).encode('utf-8')
              with gzip.open(output_zip, 'wb') as f:
                  f.write(json_bytes)
              
              print(f"[+] Done! Found {len(extracted_data)} methods.")
              # حذف الملف الضخم فوراً
              os.remove(dump_file)
          else:
              print("[-] dump.cs not found. Check Dumper output logs.")

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Full-Game-Offsets
          path: offsets.json.gz
          retention-days: 2