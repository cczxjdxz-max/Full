name: GEASS-INTEGRITY-CHECK

on:
  workflow_dispatch:

jobs:
  verify_integrity:
    runs-on: ubuntu-latest
    steps:
      - name: 1. FETCH ASSET
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          asset: 'Geass_Internal_Citadel.apk'
          target: './citadel.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. RUN BIO-METRIC SCAN (Ø§Ù„ÙØ­Øµ Ø§Ù„Ø­ÙŠÙˆÙŠ)
        run: |
          # ÙØ­Øµ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ
          sudo apt-get update && sudo apt-get install -y apksigner
          echo "ðŸ” Checking Signature..."
          apksigner verify --verbose citadel.apk > signature_report.txt
          
          # ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
          echo "ðŸ” Checking Permissions..."
          unzip -p citadel.apk AndroidManifest.xml > manifest_dump
          strings manifest_dump | grep "SYSTEM_ALERT_WINDOW" > permissions_report.txt
          
          # ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚Ù† ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
          echo "ðŸ” Checking Injection Paths..."
          unzip -l citadel.apk | grep -E "assets/python/internal_master.py|res/layout/geass_cockpit.xml" > files_report.txt

      - name: 3. GENERATE VERDICT (Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
        run: |
          echo "### ðŸ”± GEASS INTEGRITY REPORT ðŸ”±" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "verified" signature_report.txt; then
            echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Installable (Signature)** | âœ… YES |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Installable (Signature)** | âŒ NO |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -s permissions_report.txt ]; then
            echo "| **Overlay Permission** | âœ… ACTIVE |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Overlay Permission** | âŒ FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ $(wc -l < files_report.txt) -eq 2 ]; then
            echo "| **Injected Components** | âœ… FOUND |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Injected Components** | âŒ INCOMPLETE |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 4. UPLOAD LOGS
        uses: actions/upload-artifact@v4
        with:
          name: INTEGRITY_LOGS
          path: "*.txt"