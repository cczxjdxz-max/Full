name: GEASS-INTEGRITY-SCAN

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: 1. FETCH ASSET (Corrected Inputs)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          file: 'Geass_Internal_Citadel.apk' # ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø³Ù…Ù‰ Ù…Ù† asset Ø¥Ù„Ù‰ file
          target: './citadel.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. RUN DEEP SCAN
        run: |
          sudo apt-get update && sudo apt-get install -y apksigner
          
          # 1. ÙØ­Øµ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ
          apksigner verify --verbose citadel.apk > signature_report.txt 2>&1 || echo "failed" > signature_report.txt
          
          # 2. ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù‚ÙˆÙ†Ø©
          unzip -p citadel.apk AndroidManifest.xml > manifest_dump
          strings manifest_dump | grep "SYSTEM_ALERT_WINDOW" > permissions_report.txt || echo "missing" > permissions_report.txt
          
          # 3. ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
          unzip -l citadel.apk > file_list.txt

      - name: 3. FINAL VERDICT TABLE
        run: |
          echo "### ðŸ”± GEASS CITADEL INTEGRITY REPORT ðŸ”±" >> $GITHUB_STEP_SUMMARY
          echo "ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø®Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© | Ø§Ù„Ø­Ø§Ù„Ø© |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          # ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
          if grep -q "verified" signature_report.txt; then
            echo "| Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ | Ø³Ù„ÙŠÙ… (Signed) | âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ | ØªØ§Ù„Ù Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯ | âŒ Ù„Ù† ÙŠØ«Ø¨Øª |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
          if grep -q "SYSTEM_ALERT_WINDOW" permissions_report.txt; then
            echo "| Ù†Ø§ÙØ°Ø© Ø§Ù„Ù€ Overlay | Ù…ÙØ¹Ù„Ø© (Permission) | âœ… Ø³ØªØ¸Ù‡Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù†Ø§ÙØ°Ø© Ø§Ù„Ù€ Overlay | Ù…ÙÙ‚ÙˆØ¯Ø© | âŒ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù† ØªØ¹Ù…Ù„ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ØªÙ‚Ø±ÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
          if grep -q "assets/python/internal_master.py" file_list.txt; then
            echo "| Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† | Ù…ÙˆØ¬ÙˆØ¯ (Injected) | âœ… Ø§Ù„Ù†Ø®Ø§Ø¹ Ø­ÙŠ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† | ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | âŒ Ø§Ù„Ø­Ù‚Ù† ÙØ´Ù„ |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 4. ARCHIVE LOGS (Small Files)
        uses: actions/upload-artifact@v4
        with:
          name: SCAN_LOGS
          path: "*.txt"