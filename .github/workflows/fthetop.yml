name: GIAS-THE-FINAL-ASSEMBLER

on:
  workflow_dispatch:

jobs:
  extract_and_assemble:
    runs-on: ubuntu-latest
    steps:
      # ------------------- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„ÙÙ‡Ø±Ø³Ø© -------------------
      - name: 1. Setup & Download
        run: |
          pip install UnityPy
          echo "--- Downloading APK ---"
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          echo "--- Unpacking APK ---"
          unzip -o game.apk -d game_files

      - name: 2. Run Master Mapper (Creating the Index)
        id: mapping
        run: |
          # Ù‡Ø°Ø§ Ù‡Ùˆ Ù†ÙØ³ ÙƒÙˆØ¯ "Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„" Ù…Ù† Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          # ÙˆØ¸ÙŠÙØªÙ‡ Ù‡ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù full_game_inventory.json
          cat << 'EOF' > master_mapper.py
          import os
          import json

          target_dir = next((os.path.join(r, d) for r, dirs, f in os.walk("game_files") for d in dirs if d == "bin"), "game_files")
          full_inventory = {
              "Weapons_Logic": [], "Maps_Bermuda": [], "Characters_Physics": [], "Game_Rules": [], "Unidentified_Big_Files": []
          }
          categories = {
              "Weapons_Logic": [b"Weapon", b"Recoil", b"Bullet", b"Spread", b"Reload"],
              "Maps_Bermuda": [b"Bermuda", b"Terrain"],
              "Characters_Physics": [b"Gravity", b"Hitbox", b"Collider", b"Ragdoll", b"Physics"],
              "Game_Rules": [b"PlayerSkill", b"SpeedScale", b"Movement", b"Vehicle"]
          }
          print(f"ğŸ“¡ Stage 1: Scanning files to create inventory...")
          for root, dirs, files in os.walk(target_dir):
              for file in files:
                  f_path = os.path.join(root, file)
                  try:
                      f_size = os.path.getsize(f_path)
                      if f_size < 5000: continue
                      with open(f_path, 'rb') as f_content:
                          content = f_content.read()
                          found = False
                          for cat, keys in categories.items():
                              if any(k in content for k in keys):
                                  full_inventory[cat].append({"file_id": file, "path": f_path, "size": f_size})
                                  found = True
                                  break
                          if not found and f_size > 1000000:
                              full_inventory["Unidentified_Big_Files"].append({"file_id": file, "path": f_path, "size": f_size})
                  except: continue
          with open("full_game_inventory.json", "w") as f:
              json.dump(full_inventory, f, indent=4)
          print("âœ… Stage 1 Complete: Inventory created at full_game_inventory.json")
          EOF
          python3 master_mapper.py

      # ------------------- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„ØªØ¬Ù…ÙŠØ¹ -------------------
      - name: 3. Run Surgical Assembler (Reading the Index and Assembling Data)
        run: |
          # Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø±Ø£ Ø§Ù„ÙÙ‡Ø±Ø³ ÙˆÙŠØ¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          cat << 'EOF' > surgical_assembler.py
          import os
          import json
          import UnityPy

          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡
          with open("full_game_inventory.json", 'r') as f:
              inventory = json.load(f)

          # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
          final_data = {
              "PHYSICS_DATA": {},
              "MAP_GEOMETRY_DATA": [],
              "CHARACTER_DATA": {}
          }

          print("--- Stage 2: Assembling data based on inventory ---")

          # --- ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„Ø£Ø³Ù„Ø­Ø© ---
          print("...Assembling Physics & Weapon data...")
          weapon_files = inventory.get("Weapons_Logic", [])
          for item in weapon_files:
              try:
                  env = UnityPy.load(item["path"])
                  for obj in env.objects:
                      if obj.type.name == "MonoBehaviour":
                          data = obj.read()
                          # Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØ§Ù„Ù†ØµÙŠØ©
                          # Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©
                          tree = data.read_typetree()
                          final_data["PHYSICS_DATA"][f"{item['file_id']}_{data.name}"] = tree
              except Exception as e:
                  print(f"Warning: Could not process {item['file_id']}: {e}")
                  continue

          # --- ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
          print("...Assembling Map Geometry data...")
          map_files = inventory.get("Maps_Bermuda", []) + inventory.get("Unidentified_Big_Files", [])
          for item in map_files:
              try:
                  env = UnityPy.load(item["path"])
                  for obj in env.objects:
                      if obj.type.name == "Mesh":
                          mesh = obj.read()
                          if mesh.m_VertexCount > 100: # Ù†Ù‡ØªÙ… ÙÙ‚Ø· Ø¨Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
                              final_data["MAP_GEOMETRY_DATA"].append({
                                  "source_file": item["file_id"],
                                  "mesh_name": mesh.name,
                                  "vertices": mesh.m_VertexCount,
                                  "submeshes": len(mesh.m_SubMeshes)
                              })
              except Exception as e:
                  print(f"Warning: Could not process {item['file_id']}: {e}")
                  continue
          
          # --- ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ§Øª ---
          print("...Assembling Character data...")
          char_files = inventory.get("Characters_Physics", [])
          for item in char_files:
              try:
                  env = UnityPy.load(item["path"])
                  for obj in env.objects:
                      if obj.type.name == "MonoBehaviour":
                          data = obj.read()
                          if "hitbox" in str(data.read_typetree()).lower():
                              tree = data.read_typetree()
                              final_data["CHARACTER_DATA"][f"{item['file_id']}_{data.name}"] = tree
              except Exception as e:
                  print(f"Warning: Could not process {item['file_id']}: {e}")
                  continue

          # Ø­ÙØ¸ ÙƒÙ„ ÙØ¦Ø© ÙÙŠ Ù…Ù„Ù JSON Ù…Ù†ÙØµÙ„
          print("--- Saving final assembled data files ---")
          os.makedirs("FINAL_DATA", exist_ok=True)
          with open("FINAL_DATA/PHYSICS.json", "w") as f:
              json.dump(final_data["PHYSICS_DATA"], f, indent=4)
          with open("FINAL_DATA/MAP.json", "w") as f:
              json.dump(final_data["MAP_GEOMETRY_DATA"], f, indent=4)
          with open("FINAL_DATA/CHARACTERS.json", "w") as f:
              json.dump(final_data["CHARACTER_DATA"], f, indent=4)
              
          print("âœ… Stage 2 Complete: All data assembled!")
          EOF
          python3 surgical_assembler.py

      # Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
      - name: 4. Upload Final Assembled Data
        uses: actions/upload-artifact@v4
        with:
          name: GIAS_FINAL_ASSEMBLED_DATA
          path: FINAL_DATA/