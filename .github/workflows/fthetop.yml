name: FINAL-GEASS-AUDIT

on:
  workflow_dispatch:

jobs:
  audit_report:
    runs-on: ubuntu-latest
    steps:
      - name: 1. FETCH FIXED ASSET
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          file: 'Geass_Fixed_Citadel.apk' # ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù€ Release Ø§Ù„Ø£Ø®ÙŠØ±
          target: './final_citadel.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. DEEP FORENSIC SCAN
        run: |
          sudo apt-get update && sudo apt-get install -y apksigner
          
          echo "--- SIGNATURE ANALYSIS ---" > full_report.txt
          apksigner verify --verbose --print-certs final_citadel.apk >> full_report.txt 2>&1
          
          echo -e "\n--- PERMISSION ANALYSIS ---" >> full_report.txt
          unzip -p final_citadel.apk AndroidManifest.xml > manifest_dump
          strings manifest_dump | grep "SYSTEM_ALERT_WINDOW" >> full_report.txt || echo "Permission Not Found" >> full_report.txt
          
          echo -e "\n--- INTERNAL STRUCTURE ---" >> full_report.txt
          unzip -l final_citadel.apk | grep -E "assets/python/|res/layout/" >> full_report.txt

      - name: 3. VISUAL VERDICT TABLE
        run: |
          echo "### ðŸ”± GEASS CITADEL FINAL VERDICT ðŸ”±" >> $GITHUB_STEP_SUMMARY
          echo "ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Ø§Ù„Ù†ØªÙŠØ¬Ø© | Ø§Ù„ØªÙØ§ØµÙŠÙ„ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          # ÙØ­Øµ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ V2/V3
          if grep -q "Verified using v2 scheme: true" full_report.txt; then
            echo "| Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ | âœ… Ù†Ø§Ø¬Ø­ | ÙŠØ¯Ø¹Ù… Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ 11+ (V2/V3) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ | âš ï¸ Ø¬Ø²Ø¦ÙŠ | Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
          if grep -q "SYSTEM_ALERT_WINDOW" full_report.txt; then
            echo "| Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© | âœ… Ù…ÙØ¹Ù„ | ØµÙ„Ø§Ø­ÙŠØ© Overlay Ù…ÙˆØ¬ÙˆØ¯Ø© |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© | âŒ Ù…ÙÙ‚ÙˆØ¯ | Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù† ØªØ¸Ù‡Ø± |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÙØ­Øµ Ø§Ù„Ø­Ø¬Ù… Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          FILE_SIZE=$(du -h final_citadel.apk | cut -f1)
          echo "| Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„ | ðŸ“¦ $FILE_SIZE | ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© |" >> $GITHUB_STEP_SUMMARY

      - name: 4. UPLOAD FULL REPORT
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_FORENSIC_REPORT
          path: full_report.txt