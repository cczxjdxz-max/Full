name: GEASS-ALL-OFFSETS-DUMPER

on:
  workflow_dispatch:

jobs:
  dump_all:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP DUMPER ENVIRONMENT
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl
          # تحميل نسخة مستقرة تعمل على لينكس مباشرة عبر dotnet
          curl -L "https://github.com/Perfare/Il2CppDumper/releases/download/v6.7.40/Il2CppDumper-v6.7.40.zip" -o dumper.zip
          unzip dumper.zip -d dumper_tool

      - name: 2. GET YOUR APK
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o master.apk

      - name: 3. EXTRACT TARGETS
        run: |
          # استخراج الملفات الأساسية للتحليل
          unzip master.apk "lib/arm64-v8a/libil2cpp.so" -d ./extracted
          unzip master.apk "assets/bin/Data/Managed/Metadata/global-metadata.dat" -d ./extracted
          
          # وضعهم في المجلد الرئيسي للدامبر
          cp extracted/lib/arm64-v8a/libil2cpp.so ./libil2cpp.so
          cp extracted/assets/bin/Data/Managed/Metadata/global-metadata.dat ./global-metadata.dat

      - name: 4. THE ULTIMATE DUMP (استخراج الكل)
        run: |
          # تشغيل الدامبر يدوياً لتوليد ملف العناوين
          cd dumper_tool
          chmod +x Il2CppDumper
          # تنفيذ الدامبر (يحتاج مسار الـ SO ثم الميتاداتا ثم مجلد الإخراج)
          ./Il2CppDumper ../libil2cpp.so ../global-metadata.dat ../all_offsets

      - name: 5. UPLOAD THE MASTER LIST
        uses: actions/upload-artifact@v4
        with:
          name: FULL_GAME_CATALOG
          path: all_offsets/dump.cs