name: GEASS-INTERNAL-CITADEL-WITH-TEST

on:
  workflow_dispatch:

jobs:
  forge_and_test:
    runs-on: macos-latest  # Ù†Ø³ØªØ®Ø¯Ù… macOS Ù„Ø£Ù†Ù‡ ÙŠØ¯Ø¹Ù… ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙƒÙŠ (Hardware Acceleration)
    steps:
      - name: 1. INITIALIZE FORGE
        run: |
          sudo apt-get update || true
          brew install apktool
          mkdir -p ./INTERNAL_GEASS/output
          echo "âœ… Forge initialized on macOS runner."

      - name: 2. SURGICAL INJECTION (Building the APK)
        run: |
          # (Ù‡Ù†Ø§ Ù†Ø¶Ø¹ Ù†ÙØ³ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù‚Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ libunity ÙˆØ­Ù‚Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ù€ API)
          echo "ðŸ’‰ Injecting Sovereign Engine into APK..."
          # Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
          touch Geass_Internal_Citadel.apk 

      - name: 3. DEPLOY VIRTUAL TEST ENVIRONMENT (Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø± Ø§Ù„Ø°Ø§ØªÙŠ)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          script: |
            echo "ðŸš€ Installing the Citadel APK..."
            adb install Geass_Internal_Citadel.apk
            
            echo "â±ï¸ Launching Game & Internal API..."
            adb shell monkey -p com.dts.freefireth -c android.intent.category.LAUNCHER 1
            
            echo "ðŸ” Capturing 60 seconds of Internal Logs..."
            sleep 60
            adb logcat -d > citadel_field_report.log
            
            echo "ðŸ“Š Checking API Status on Port 1337..."
            adb shell "netstat -an | grep 1337" >> citadel_field_report.log

      - name: 4. GENERATE SOVEREIGN REPORT (README Update)
        run: |
          echo "ðŸ“ Analyzing Logs for Integrity..."
          if grep -q "Internal API Server active" citadel_field_report.log; then
            echo "### âœ… TEST RESULT: SUCCESS" >> README.md
            echo "- Game Status: Running" >> README.md
            echo "- Cockpit API: Active on Port 1337" >> README.md
          else
            echo "### âŒ TEST RESULT: CRITICAL FAILURE" >> README.md
            echo "- Reason: Internal Engine didn't start" >> README.md
          fi
          
          echo "#### Raw Log Snippet:" >> README.md
          tail -n 20 citadel_field_report.log >> README.md

      - name: 5. UPLOAD FINAL APK & LOGS
        uses: actions/upload-artifact@v4
        with:
          name: CITADEL_FINAL_AND_LOGS
          path: |
            Geass_Internal_Citadel.apk
            citadel_field_report.log