name: GEASS-OFFSETS-HUNTER-V2

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  extract_offsets:
    runs-on: ubuntu-latest
    steps:
      - name: 1. INSTALL PYTHON TOOLS
        run: |
          sudo apt-get update
          pip install pyelftools # Ù…ÙƒØªØ¨Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ .so

      - name: 2. FETCH LATEST APK
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o game.apk

      - name: 3. EXTRACT CORE FILES
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„
          unzip game.apk "lib/arm64-v8a/libil2cpp.so" -d ./
          unzip game.apk "assets/bin/Data/Managed/Metadata/global-metadata.dat" -d ./
          
          # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
          mv lib/arm64-v8a/libil2cpp.so ./libil2cpp.so
          mv assets/bin/Data/Managed/Metadata/global-metadata.dat ./global-metadata.dat

      - name: 4. RUN EMERGENCY DUMP (Script)
        run: |
          # Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø¨Ø§ÙŠØ«ÙˆÙ† Ø³Ø±ÙŠØ¹ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
          cat << 'EOF' > dumper.py
          import os
          
          def simple_dump(so_path, metadata_path):
              print(f"ğŸ” Analyzing {so_path}...")
              # Ù‡Ù†Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
              # Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ø¨ÙƒÙ„ Ø§Ù„Ù†ØµÙˆØµ (Strings) Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…ÙŠØªØ§Ø¯Ø§ØªØ§
              # Ù„Ø£Ù†Ù‡Ø§ ØºØ§Ù„Ø¨Ø§Ù‹ Ù…Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„
              with open(metadata_path, 'rb') as f:
                  data = f.read()
                  # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ‡Ù…Ù†Ø§
                  targets = [b"Health", b"Speed", b"Damage", b"Recoil", b"Aim"]
                  for t in targets:
                      if t in data:
                          print(f"âœ… Found Reference to: {t.decode()}")
          
          simple_dump("libil2cpp.so", "global-metadata.dat")
          EOF
          python3 dumper.py > offsets_preview.txt

      - name: 5. UPLOAD PREVIEW
        uses: actions/upload-artifact@v4
        with:
          name: OFFSETS_PREVIEW
          path: offsets_preview.txt