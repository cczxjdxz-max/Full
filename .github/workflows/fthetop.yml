name: GEASS-FORCED-FUSION

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fusion:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. FETCH CURRENT APK
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o current.apk

      - name: 3. FORCED INJECTION (Ø§Ù„Ø¬Ø±Ø§Ø­Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©)
        run: |
          # Ø£- Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ÙˆØ­Ù‚Ù† Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
          mkdir -p assets/python
          echo 'import os; print("ğŸ”± GEASS MENU ACTIVE")' > assets/python/internal_master.py
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… -r Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø±ÙŠØ© Ù„Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª
          zip -r current.apk assets/
          
          # Ø¨- Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¢Ù…Ù†
          unzip -o current.apk AndroidManifest.xml
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù† Ù„Ù… ØªÙƒÙ†
          if ! grep -q "SYSTEM_ALERT_WINDOW" AndroidManifest.xml; then
            sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' AndroidManifest.xml
          fi
          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø§Ù„Ù‚ÙˆØ©
          zip -f current.apk AndroidManifest.xml || zip -u current.apk AndroidManifest.xml

      - name: 4. FINAL V2/V3 SIGNING
        run: |
          java -jar signer.jar --apks current.apk --out ./ --allowResign
          mv current-aligned-debugSigned.apk Geass_Ultimate_Ready.apk

      - name: 5. RELEASE
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v6.0-final"
          name: "Geass Citadel - FINAL READY"
          files: Geass_Ultimate_Ready.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}