name: GEASS-CITADEL-RELEASE-FORGE

on:
  workflow_dispatch:

jobs:
  forge_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ Release
    steps:
      - name: 1. SETUP TOOLS & ENVIRONMENT
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk wget zip unzip curl
          
          echo "ğŸ“¥ Downloading Tools..."
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… curl -L Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­ ÙˆØªØ¬Ù†Ø¨ Error 8
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar
          
          # ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
          if [ ! -s apktool.jar ]; then echo "âŒ Apktool download failed"; exit 1; fi
          echo "âœ… Forge tools ready."

      - name: 2. THE SURGICAL PROCESS (Injection)
        run: |
          echo "ğŸ“¥ Downloading Official Base APK..."
          curl -L "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -o base.apk
          
          echo "ğŸ—ï¸ Decompiling..."
          java -jar apktool.jar d base.apk -o decoded
          
          echo "ğŸ’‰ Injecting Sovereign Core & Cockpit UI..."
          # Ø­Ù‚Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
          mkdir -p decoded/assets/python
          echo "import os; print('ğŸ”± Sovereign Internal Engine: ONLINE')" > decoded/assets/python/internal_master.py
          
          # Ø­Ù‚Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ©
          mkdir -p decoded/res/layout
          echo '<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:layout_width="match_parent" android:layout_height="wrap_content" android:background="#AA000000" android:orientation="vertical"><TextView android:id="@+id/console_title" android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="CITADEL CONSOLE" android:textColor="#FF0000" android:layout_gravity="center"/></LinearLayout>' > decoded/res/layout/geass_cockpit.xml

          echo "ğŸ› ï¸ Patching AndroidManifest..."
          # Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ Ù‚Ø¨Ù„ ÙˆØ³Ù… <application>
          sed -i '/<application/i <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' decoded/AndroidManifest.xml

          echo "ğŸ—ï¸ Rebuilding & Signing..."
          java -jar apktool.jar b decoded -o Unsigned.apk
          java -jar signer.jar --apks Unsigned.apk --out ./
          
          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ© Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
          mv Unsigned-aligned-debugSigned.apk Geass_Internal_Citadel.apk
          echo "âœ… Master APK Created."

      - name: 3. INTEGRITY CHECK
        run: |
          echo "ğŸ” Verifying Build..."
          unzip -l Geass_Internal_Citadel.apk | grep "internal_master.py" && echo "âœ… Python Core Found"
          java -jar signer.jar --verify --apks Geass_Internal_Citadel.apk && echo "âœ… Signature Verified"

      - name: 4. PUBLISH RELEASE
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v1.0.${{ github.run_number }}"
          name: "Geass Citadel Build #${{ github.run_number }}"
          body: |
            ğŸ”± **Geass Citadel Master Artifact**
            ---
            - **Status:** Structural Integrity Verified âœ…
            - **Injection:** Python Sovereign Engine + Cockpit UI
            - **Ready for:** Local Emulator or Mobile Testing.
            - **Note:** Install this APK and check logs for 'Sovereign' tag.
          files: Geass_Internal_Citadel.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}