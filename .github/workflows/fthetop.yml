# .github/workflows/geass-deep-extractor.yml
name: GEASS-DEEP-EXTRACTOR

on:
  workflow_dispatch:

jobs:
  rip_assets:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Environment
        run: |
          sudo apt-get update
          pip install UnityPy pillow
          mkdir -p ./GEASS/extracted

      - name: 2. Download and Unzip APK
        run: |
          wget -q -O Game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          # فك ضغط الـ APK يدوياً للوصول للملفات الداخلية
          unzip Game.apk -d extracted_apk

      - name: 3. Targeted Asset Extraction
        run: |
          cat << 'EOF' > rip_v3.py
          import UnityPy
          import os

          def extract():
              # تحديد مسار ملفات الداتا داخل الأندرويد
              base_path = "extracted_apk/assets/bin/Data/"
              count = 0
              
              if not os.path.exists(base_path):
                  print("❌ Data path not found, scanning entire extracted folder...")
                  base_path = "extracted_apk/"

              # تحميل المجلد بالكامل بدلاً من ملف الـ APK
              env = UnityPy.load(base_path)
              
              for obj in env.objects:
                  if obj.type.name in ["Texture2D", "Sprite"]:
                      try:
                          data = obj.read()
                          if data.image:
                              data.image.save(f"./GEASS/extracted/vision_{count}.png")
                              print(f"✅ Extracted: {data.name}")
                              count += 1
                      except:
                          continue
                  if count >= 10: break
              
              if count == 0:
                  print("⚠️ No images found. Trying to find UnityFS files directly...")
                  # بحث يدوي عن ملفات البندل
                  for root, dirs, files in os.walk("extracted_apk"):
                      for f in files:
                          if "unity" in f or "sharedassets" in f:
                              try:
                                  sub_env = UnityPy.load(os.path.join(root, f))
                                  for sub_obj in sub_env.objects:
                                      if sub_obj.type.name == "Texture2D":
                                          sub_obj.read().image.save(f"./GEASS/extracted/deep_{count}.png")
                                          count += 1
                                          if count >= 10: break
                              except: continue

          extract()
          EOF
          python3 rip_v3.py

      - name: 4. Upload Vision
        uses: artifacts/upload-artifact@v4
        with:
          name: GEASS_FINAL_VISION
          path: ./GEASS/extracted/