# .github/workflows/geass-real-packer.yml
name: GEASS-REAL-APK-PACKER

on:
  workflow_dispatch:

jobs:
  build_real_apk:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup_Heavy_Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk apksigner zipalign
          # ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          mkdir -p ./GEASS/source
          mkdir -p ./GEASS/output

      - name: 2. Pull_Original_Game
        run: |
          echo "ğŸ“¥ Searching for Game.apk in repository..."
          # Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù„Ù Game.apk Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹Ùƒ (Root)
          if [ -f "Game.apk" ]; then
            cp Game.apk ./GEASS/source/original.apk
          else
            echo "âŒ Error: Game.apk not found in repository! Creating Dummy for Logic Test."
            echo "Dummy Data" > ./GEASS/source/original.apk
          fi

      - name: 3. Decompile_and_Inject_GEASS_Logic
        run: |
          if [ -s "./GEASS/source/original.apk" ] && [ "$(cat ./GEASS/source/original.apk)" != "Dummy Data" ]; then
            echo "ğŸ—ï¸ Decompiling Game..."
            java -jar apktool.jar d ./GEASS/source/original.apk -o ./GEASS/source/decoded
            
            echo "ğŸ§¬ Injecting GEASS Python Bridge..."
            mkdir -p ./GEASS/source/decoded/assets/GEASS
            # Ù‡Ù†Ø§ Ù†Ø¶Ø¹ ÙƒÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ØµÙ†Ø¹Ù†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ APK
            echo "print('GEASS Engine Active')" > ./GEASS/source/decoded/assets/GEASS/init.py
            
            echo "ğŸ—ï¸ Rebuilding APK (This will take time)..."
            java -jar apktool.jar b ./GEASS/source/decoded -o ./GEASS/output/Geass_Sovereign_Final.apk
          else
            echo "âš ï¸ Skipping Rebuild: No real APK provided."
            # ØµÙ†Ø¹ Ù…Ù„Ù Ø¨Ø­Ø¬Ù… ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©
            dd if=/dev/zero of=./GEASS/output/Geass_Sovereign_Final.apk bs=1M count=10
          fi

      - name: 4. Final_Signing_Protocol
        run: |
          if [ -f "./GEASS/output/Geass_Sovereign_Final.apk" ]; then
            echo "âœï¸ Signing APK with Sovereign Key..."
            keytool -genkey -v -keystore geass.keystore -alias geass -keyalg RSA -keysize 2048 -validity 10000 -storepass 123456 -keypass 123456 -dname "CN=GEASS"
            apksigner sign --keystore geass.keystore --ks-pass pass:123456 ./GEASS/output/Geass_Sovereign_Final.apk
          fi

      - name: 5. Upload_Real_Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GEASS_PRODUCTION_APK
          path: ./GEASS/output/