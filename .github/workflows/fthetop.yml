name: GEASS-FUNCTIONAL-FUSION

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fusion:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. FETCH CURRENT APK
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          if [ -z "$APK_URL" ]; then echo "âŒ No APK found!"; exit 1; fi
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o current.apk

      - name: 3. INJECT FUNCTIONAL ENGINE
        run: |
          mkdir -p assets/python
          cat << 'EOF' > assets/python/internal_master.py
          import os

          class GameAPI:
              @staticmethod
              def get_player_by_name(name):
                  print(f"[API] Searching for player: {name}")
                  return {"name": name, "id": 123}

              @staticmethod
              def clear_inventory(player):
                  print(f"[API] Clearing inventory for player: {player['name']}")

              @staticmethod
              def give_item(player, item, quantity):
                  print(f"[API] Giving {quantity} of {item} to player: {player['name']}")

              @staticmethod
              def set_health(player, amount):
                  print(f"[API] Setting health of {player['name']} to {amount}")

              @staticmethod
              def spawn_bots(count, positions):
                  print(f"[API] Spawning {count} bots.")
                  return [{"id": i} for i in range(count)]

              @staticmethod
              def command_attack(bots, target):
                  print(f"[API] Commanding {len(bots)} bots to attack target: {target['name']}")

          def execute_scenario(code):
              try:
                  global_vars = {"GameAPI": GameAPI}
                  exec(code, global_vars)
                  print("[Engine] Scenario executed successfully.")
              except Exception as e:
                  print(f"[Engine] Error: {e}")

          print("ğŸ”± GEASS FUNCTIONAL ENGINE: ONLINE. Ready for scenarios.")
          EOF
          
          # Ø­Ù‚Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙˆØ§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ APK
          zip -r current.apk assets/
          
          # ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ Ø³ØªØªØ­ÙƒÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ø±Ùƒ
          unzip -o current.apk AndroidManifest.xml
          if ! grep -q "SYSTEM_ALERT_WINDOW" AndroidManifest.xml; then
            sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' AndroidManifest.xml
          fi
          zip -f current.apk AndroidManifest.xml

      - name: 4. FINAL SIGNING & RELEASE
        run: |
          java -jar signer.jar --apks current.apk --out ./ --allowResign
          mv current-aligned-debugSigned.apk Geass_Functional_Ready.apk

      - name: 5. PUBLISH RELEASE
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v7.0-functional"
          name: "Geass Citadel - FUNCTIONAL READY"
          body: "ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (GameAPI) Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¢Ù† Ù‚Ø§Ø¯Ø±Ø© Ø¹Ù„Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©."
          files: Geass_Functional_Ready.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}