name: Auto APK Offset Extractor

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up .NET & Python
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Download and Extract APK
        run: |
          echo "[+] Downloading Free Fire APK..."
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          
          echo "[+] Extracting required files..."
          # محاولة استخراج الملفات من جميع المسارات الممكنة داخل الـ APK
          unzip -o game.apk "lib/arm64-v8a/libil2cpp.so" "lib/armeabi-v7a/libil2cpp.so" "assets/bin/Data/Managed/Metadata/global-metadata.dat" -d extracted_files
          
          # نقل الملفات للمجلد الرئيسي لتسهيل الوصول إليها
          find extracted_files -name "libil2cpp.so" -exec cp {} . \;
          find extracted_files -name "global-metadata.dat" -exec cp {} . \;
          
          if [ -f "libil2cpp.so" ] && [ -f "global-metadata.dat" ]; then
            echo "[+] Files are ready."
            ls -lh libil2cpp.so global-metadata.dat
          else
            echo "[-] Error: Essential files not found in APK."
            exit 1
          fi

      - name: Build Il2CppDumper
        run: |
          git clone --depth 1 https://github.com/Perfare/Il2CppDumper.git source_code
          cd source_code
          dotnet publish -c Release -f net8.0 -r linux-x64 --self-contained true /p:PublishSingleFile=true
          find . -name "Il2CppDumper" -type f -executable -exec cp {} ../dumper \;
          cd ..
          chmod +x dumper

      - name: Run Dumper
        run: |
          # تشغيل الدامبر مع توجيه الإدخالات تلقائياً
          # إضافة الخيار "Auto" إذا طلبته الأداة
          echo -e "1\n" | ./dumper libil2cpp.so global-metadata.dat . || echo "Dumper finished with warnings"
          
          # تأكيد وجود الملف الناتج
          if [ -f "dump.cs" ]; then
            echo "[+] dump.cs created successfully."
          else
            echo "[-] dump.cs was NOT created. Listing current files:"
            ls -R
          fi

      - name: Extract Offsets to JSON (Inline Python)
        shell: python
        run: |
          import os, re, json
          
          dump_file = "dump.cs"
          output_json = "all_offsets.json"
          
          if os.path.exists(dump_file):
              print("[+] Extracting data to JSON...")
              pattern = re.compile(r"// RVA: (0x[A-F0-9]+).*?\n\s+.*? ([\w_<>]+)\(")
              extracted_data = {}
              
              with open(dump_file, "r", encoding="utf-8") as f:
                  content = f.read()
                  for match in pattern.finditer(content):
                      address, name = match.groups()
                      extracted_data[name] = address
              
              with open(output_json, "w", encoding="utf-8") as jf:
                  json.dump(extracted_data, jf, indent=4)
              print(f"[+] Found {len(extracted_data)} methods.")
          else:
              # إذا لم يجد dump.cs، سيقوم بإنشاء ملف خطأ لرفعه لكي نعرف السبب
              with open(output_json, "w") as f:
                  f.write(json.dumps({"error": "dump.cs was not found after running dumper"}))

      - name: Upload JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FreeFire-Offsets-JSON
          path: all_offsets.json
          if-no-files-found: error