# .github/workflows/geass-signer-fixed.yml
name: GEASS-SIGNER-FINAL-FIX

on:
  workflow_dispatch:

jobs:
  build_and_sign:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk apksigner
          mkdir -p ./GEASS/output
          # التأكد من وجود ملف تجريبي إذا لم ترفع اللعبة بعد لضمان عدم توقف السكربت
          if [ ! -f "Game.apk" ]; then
            dd if=/dev/zero of=./GEASS/output/Geass_Sovereign_Final.apk bs=1M count=10
            echo "⚠️ Warning: Real Game.apk not found. Creating a 10MB test file."
          else
            cp Game.apk ./GEASS/output/Geass_Sovereign_Final.apk
          fi

      - name: 2. Generate Sovereign Keystore
        run: |
          keytool -genkey -v -keystore geass.jks \
            -alias geass_alias -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass 123456 -keypass 123456 -dname "CN=GEASS"

      - name: 3. Final Signing Protocol (Fixed Syntax)
        run: |
          echo "✍️ Signing with Fixed Apksigner Syntax..."
          # استخدام الصيغة التي تقبلها جميع إصدارات أندرويد SDK
          apksigner sign --ks geass.jks --ks-pass pass:123456 \
            --out ./GEASS/output/Geass_Sovereign_Signed.apk \
            ./GEASS/output/Geass_Sovereign_Final.apk
          echo "✅ APK Signed Successfully."

      - name: 4. Verification & Upload
        uses: actions/upload-artifact@v4
        with:
          name: GEASS_FINAL_SIGNED_APK
          path: ./GEASS/output/Geass_Sovereign_Signed.apk