name: GEASS-FUNCTIONAL-AUDIT

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: 1. FETCH FUNCTIONAL APK
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          file: 'Geass_Functional_Ready.apk'
          target: './functional.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. FORENSIC CODE ANALYSIS
        run: |
          sudo apt-get update && sudo apt-get install -y apksigner
          
          echo "--- SIGNATURE VERIFICATION ---" > audit_log.txt
          apksigner verify --verbose functional.apk >> audit_log.txt 2>&1
          
          echo -e "\n--- PERMISSION INTEGRITY ---" >> audit_log.txt
          unzip -p functional.apk AndroidManifest.xml > m_dump
          strings m_dump | grep "SYSTEM_ALERT_WINDOW" >> audit_log.txt || echo "âŒ PERMISSION MISSING" >> audit_log.txt
          
          echo -e "\n--- ENGINE CODE VERIFICATION (INTERNAL_MASTER) ---" >> audit_log.txt
          # ÙØ­Øµ Ù…Ø­ØªÙˆÙ‰ Ù…Ù„Ù Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù€ API
          unzip -p functional.apk assets/python/internal_master.py > engine_content.py
          if grep -q "class GameAPI" engine_content.py; then
            echo "âœ… GameAPI Structure: FOUND" >> audit_log.txt
          else
            echo "âŒ GameAPI Structure: NOT FOUND" >> audit_log.txt
          fi
          
          if grep -q "def execute_scenario" engine_content.py; then
            echo "âœ… Execution Engine: ACTIVE" >> audit_log.txt
          fi

      - name: 3. READINESS SUMMARY
        run: |
          echo "### ðŸ”± GEASS FUNCTIONAL READINESS REPORT ðŸ”±" >> $GITHUB_STEP_SUMMARY
          echo "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ© (V7.0 Functional):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          # ÙØ­Øµ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
          if grep -q "Verified using v2 scheme: true" audit_log.txt; then
            echo "| Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ | âœ… ÙƒØ§Ù…Ù„ | V2/V3 Full Signature |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ | âš ï¸ Ø¬Ø²Ø¦ÙŠ | Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ ØªØ«Ø¨ÙŠØª ÙŠØ¯ÙˆÙŠ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
          if grep -q "SYSTEM_ALERT_WINDOW" audit_log.txt; then
            echo "| Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ Overlay | âœ… Ù…ÙØ¹Ù„ | Ø¬Ø§Ù‡Ø² Ù„Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ Overlay | âŒ Ù…ÙÙ‚ÙˆØ¯ | Ù„Ù† ØªØ¸Ù‡Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÙØ­Øµ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
          if grep -q "GameAPI Structure: FOUND" audit_log.txt; then
            echo "| Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª | âœ… Ø°ÙƒÙŠ | GameAPI & Scenarios Ready |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª | âŒ Ù…Ø¹Ø·Ù„ | Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ù… ÙŠÙØ­Ù‚Ù† |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 4. SAVE AUDIT LOGS
        uses: actions/upload-artifact@v4
        with:
          name: FUNCTIONAL_AUDIT_REPORT
          path: audit_log.txt