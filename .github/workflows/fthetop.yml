name: FORCE-RELEASE-V4

on:
  workflow_dispatch:

# Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ§Ù„Ø±ÙŠÙ„ÙŠØ²
permissions:
  contents: write
  packages: write

jobs:
  repair_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP ENVIRONMENT
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. DOWNLOAD & PATCH (The Core)
        run: |
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± APK Ù…Ø±ÙÙˆØ¹ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          
          if [ -z "$APK_URL" ]; then echo "âŒ No APK found in Releases!"; exit 1; fi
          
          echo "ğŸ“¥ Fetching: $APK_URL"
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o source.apk

          # ØªÙ†ÙÙŠØ° Ø§Ù„Ø¬Ø±Ø§Ø­Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©
          java -jar apktool.jar d source.apk -o decoded_dir -f
          sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' decoded_dir/AndroidManifest.xml
          java -jar apktool.jar b decoded_dir -o repatched_unsigned.apk
          
          # Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª
          java -jar signer.jar --apks repatched_unsigned.apk --out ./ --allowResign
          mv repatched_unsigned-aligned-debugSigned.apk Geass_Master_Final.apk

      - name: 3. CREATE STABLE RELEASE
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v4.0-master-final"
          name: "Geass Citadel - Master Production"
          body: |
            ğŸ”± **ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ø³Ø®Ø© Ø¨Ù†Ø¬Ø§Ø­** ğŸ”±
            - Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: SYSTEM_ALERT_WINDOW (Ù…ÙØ¹Ù„Ø© âœ…)
            - Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: V2/V3 Full Signature (Ø³Ù„ÙŠÙ… âœ…)
            - Ø§Ù„Ù…Ø­Ø±Ùƒ: Python Core Injected (Ø¬Ø§Ù‡Ø² âœ…)
          files: Geass_Master_Final.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}