name: GEASS-CITADEL-FINAL-FORGE

on:
  workflow_dispatch:

jobs:
  forge_and_test:
    runs-on: macos-latest
    steps:
      - name: 1. SETUP TOOLS
        run: |
          brew install apktool
          mkdir -p ./CITADEL/workspace ./CITADEL/output
          # ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø´Ø§Ù…Ù„Ø©
          curl -L https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar -o signer.jar
          echo "âœ… Infrastructure Ready."

      - name: 2. THE SURGICAL PROCESS (Injection & Build)
        run: |
          echo "ğŸ“¥ Downloading Official Base APK..."
          curl -L "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -o ./CITADEL/workspace/base.apk
          
          echo "ğŸ—ï¸ Decompiling..."
          apktool d ./CITADEL/workspace/base.apk -o ./CITADEL/workspace/decoded
          
          echo "ğŸ’‰ Injecting Sovereign Core & Cockpit UI..."
          mkdir -p ./CITADEL/workspace/decoded/assets/python
          echo "import os; print('ğŸ”± Sovereign Internal Engine: ONLINE')" > ./CITADEL/workspace/decoded/assets/python/internal_master.py
          
          mkdir -p ./CITADEL/workspace/decoded/res/layout
          echo '<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:layout_width="match_parent" android:layout_height="wrap_content" android:background="#AA000000" android:orientation="vertical"><TextView android:id="@+id/console_title" android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="CITADEL CONSOLE" android:textColor="#FF0000" android:layout_gravity="center"/></LinearLayout>' > ./CITADEL/workspace/decoded/res/layout/geass_cockpit.xml

          echo "ğŸ› ï¸ Patching AndroidManifest (Correct Position)..."
          # ÙˆØ¶Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø¨Ù„ ÙˆØ³Ù… <application> Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ù†Ø§Ø¡
          sed -i '' '/<application/i \
          <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' ./CITADEL/workspace/decoded/AndroidManifest.xml

          echo "ğŸ—ï¸ Rebuilding the Citadel Artifact..."
          apktool b ./CITADEL/workspace/decoded -o ./CITADEL/output/Citadel_Unsigned.apk
          
          echo "âœï¸ Signing with Uber-APK-Signer..."
          java -jar signer.jar --apks ./CITADEL/output/Citadel_Unsigned.apk --out ./CITADEL/output/
          
          # Ù†Ù‚Ù„ ÙˆØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ÙØ­Øµ
          cp ./CITADEL/output/Citadel_Unsigned-aligned-debugSigned.apk Geass_Internal_Citadel.apk
          echo "âœ… Master APK Created: Geass_Internal_Citadel.apk"

      - name: 3. REAL-DATA VALIDATION
        run: |
          echo "ğŸ” Running Deep Inspection..."
          unzip -l Geass_Internal_Citadel.apk | grep "assets/python/internal_master.py" && echo "âœ… Python Core: OK"
          unzip -l Geass_Internal_Citadel.apk | grep "res/layout/geass_cockpit.xml" && echo "âœ… UI Layout: OK"
          
          FILE_SIZE=$(stat -f%z "Geass_Internal_Citadel.apk")
          echo "ğŸ“¦ Size: $FILE_SIZE bytes"
          if [ $FILE_SIZE -lt 10000000 ]; then echo "âŒ Error: APK Corrupted"; exit 1; fi

      - name: 4. VIRTUAL FIELD TEST (Emulator)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          emulator-boot-timeout: 1200
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -memory 4096
          script: |
            adb wait-for-device
            echo "ğŸš€ Installing Geass Citadel..."
            adb install -r Geass_Internal_Citadel.apk
            echo "â±ï¸ Launching Game Process..."
            adb shell monkey -p com.dts.freefireth -c android.intent.category.LAUNCHER 1
            sleep 60
            adb logcat -d > field_report.log
            echo "ğŸ“Š Final Status Check..."
            adb shell "netstat -an | grep 1337" || echo "API Port Check Complete"

      - name: 5. ARCHIVE MASTER ARTIFACT
        uses: actions/upload-artifact@v4
        with:
          name: GEASS_FINAL_CITADEL_PACKAGE
          path: |
            Geass_Internal_Citadel.apk
            field_report.log