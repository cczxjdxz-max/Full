name: GEASS-MANIFEST-FIXER

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix_manifest:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          # ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ø§Ù„Ù…Ø´ÙØ±
          curl -L "https://github.com/REAndroid/APKEditor/releases/download/V1.4.1/APKEditor-1.4.1.jar" -o APKEditor.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. FETCH FUNCTIONAL APK
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o input.apk

      - name: 3. SURGICAL MANIFEST EDIT (AXML Injection)
        run: |
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø´ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
          # Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù€ Binary XML Ø¨Ø¯Ù‚Ø©
          java -jar APKEditor.jar m -i input.apk -o patched_manifest.apk --add-permission android.permission.SYSTEM_ALERT_WINDOW
          
          echo "ğŸ” FINAL V2/V3/V4 SIGNING..."
          java -jar signer.jar --apks patched_manifest.apk --out ./ --allowResign
          mv patched_manifest-aligned-debugSigned.apk Geass_Perfect_Master.apk

      - name: 4. PUBLISH PERFECT VERSION
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v8.0-perfect"
          name: "Geass Citadel - PERFECT MASTER"
          body: "Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ø§Ù„Ù…Ø´ÙØ± (AXML) Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ø¢Ù† Ø³ØªØ¸Ù‡Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ø­ØªÙ…Ø§Ù‹."
          files: Geass_Perfect_Master.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}