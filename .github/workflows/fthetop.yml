name: GEASS-FINAL-VERIFIED

on:
  workflow_dispatch:

jobs:
  build_and_verify:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP TOOLS & BASE
        run: |
          sudo apt-get update
          curl -L "https://github.com/REAndroid/APKEditor/releases/download/V1.4.1/APKEditor-1.4.1.jar" -o APKEditor.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar
          curl -L "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -o base.apk

      - name: 2. MANIFEST SURGERY
        run: |
          java -jar APKEditor.jar d -i base.apk -o temp_dir
          sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' temp_dir/AndroidManifest.xml
          java -jar APKEditor.jar b -i temp_dir -o intermediate.apk

      - name: 3. DIRECT ASSETS INJECTION
        run: |
          mkdir -p assets/python
          cat << 'EOF' > assets/python/internal_master.py
          import os
          print("ðŸ”± GEASS COCKPIT ONLINE: MODES 1,2,3,4 ACTIVE")
          class GeassEngine:
              def __init__(self): self.modes = [1,2,3,4]
          EOF
          # Ø§Ù„Ø­Ù‚Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„Ù€ APK Ø§Ù„Ù…Ø¨Ù†Ù‘ÙŠ
          zip -ur intermediate.apk assets/python/internal_master.py

      - name: 4. FINAL SIGNING
        run: |
          java -jar signer.jar --apks intermediate.apk --out ./ --allowResign
          mv intermediate-aligned-debugSigned.apk Geass_War_Final.apk

      - name: 5. COMPREHENSIVE INTEGRITY SCAN (INTERNAL)
        run: |
          echo "==== GEASS SCAN REPORT ====" > scan_report.txt
          echo "Timestamp: $(date)" >> scan_report.txt
          echo "File: Geass_War_Final.apk" >> scan_report.txt
          echo "Size: $(du -sh Geass_War_Final.apk)" >> scan_report.txt
          echo "---------------------------" >> scan_report.txt
          
          # ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª
          if unzip -l Geass_War_Final.apk | grep -q "assets/python/internal_master.py"; then
            echo "âœ… PYTHON ENGINE: FOUND (SUCCESS)" >> scan_report.txt
          else
            echo "âŒ PYTHON ENGINE: MISSING (FAILED)" >> scan_report.txt
          fi
          
          # ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
          if unzip -p Geass_War_Final.apk AndroidManifest.xml | grep -q "SYSTEM_ALERT_WINDOW"; then
            echo "âœ… OVERLAY PERMISSION: FOUND (SUCCESS)" >> scan_report.txt
          else
            echo "âŒ OVERLAY PERMISSION: MISSING (FAILED)" >> scan_report.txt
          fi
          echo "===========================" >> scan_report.txt

      - name: 6. UPLOAD REPORT AS ARTIFACT
        uses: actions/upload-artifact@v4
        with:
          name: Geass-Integrity-Report
          path: scan_report.txt

      - name: 7. RELEASE FINAL APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v20.3-verified"
          name: "Geass War - Verified Build"
          files: Geass_War_Final.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}