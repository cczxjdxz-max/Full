name: GEASS-LAB-VISUAL-CHECK

on:
  workflow_dispatch:

jobs:
  visual_audit:
    runs-on: ubuntu-latest # Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª Ø§Ù†ØªØ¸Ø§Ø± Ø·ÙˆÙŠÙ„
    steps:
      - name: 1. FETCH LATEST RELEASE
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          asset: 'Geass_Internal_Citadel.apk'
          target: './latest_citadel.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. QUICK STRUCTURAL AUDIT
        run: |
          echo "ðŸ” Checking Internal Files..."
          unzip -l latest_citadel.apk | grep "assets/python/internal_master.py" && echo "âœ… Python: INJECTED"
          unzip -l latest_citadel.apk | grep "res/layout/geass_cockpit.xml" && echo "âœ… UI: INJECTED"

      - name: 3. VIRTUAL BOOT & VISUAL SCREENSHOT
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -memory 3072
          script: |
            adb wait-for-device
            echo "ðŸš€ Emulator Ready. Installing..."
            adb install -r latest_citadel.apk
            
            echo "â±ï¸ Launching Game..."
            adb shell monkey -p com.dts.freefireth -c android.intent.category.LAUNCHER 1
            
            echo "â³ Waiting 60 seconds for engine initialization..."
            sleep 60
            
            echo "ðŸ“¸ Taking Screenshot..."
            adb shell screencap -p /sdcard/frame.png
            adb pull /sdcard/frame.png laboratory_result.png
            
            echo "ðŸ“œ Pulling Logs..."
            adb logcat -d > internal_logs.txt

      - name: 4. UPLOAD EVIDENCE
        uses: actions/upload-artifact@v4
        with:
          name: CITADEL_VISUAL_REPORT
          path: |
            laboratory_result.png
            internal_logs.txt