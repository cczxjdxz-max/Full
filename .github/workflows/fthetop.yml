name: GEASS-OFFSETS-EXTRACTOR

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: 1. PREPARE DUMPER TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y unzip curl
          # تحميل Il2CppDumper (النسخة المتوافقة مع أندرويد 64-بت)
          curl -L "https://github.com/Perfare/Il2CppDumper/releases/download/v6.7.40/Il2CppDumper-v6.7.40.zip" -o dumper.zip
          unzip dumper.zip -d dumper_tool

      - name: 2. GET THE RECENT APK
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o game.apk

      - name: 3. DISSECT GAME INTERNALS
        run: |
          # استخراج ملف الذاكرة (so) وملف البيانات (dat)
          unzip game.apk "lib/arm64-v8a/libil2cpp.so" -d extracted_files/
          unzip game.apk "assets/bin/Data/Managed/Metadata/global-metadata.dat" -d extracted_files/
          
          # نقل الملفات للمجلد المطلوب للتشغيل
          mv extracted_files/lib/arm64-v8a/libil2cpp.so ./libil2cpp.so
          mv extracted_files/assets/bin/Data/Managed/Metadata/global-metadata.dat ./global-metadata.dat

      - name: 4. EXECUTE DUMP (صناعة الكتالوج)
        run: |
          cd dumper_tool
          chmod +x Il2CppDumper
          # تشغيل الدامبر آلياً (وضع صامت)
          ./Il2CppDumper ../libil2cpp.so ../global-metadata.dat ../dump_output

      - name: 5. UPLOAD THE "HOLY GRAIL" (الملف الذهبي)
        uses: actions/upload-artifact@v4
        with:
          name: FULL_GAME_OFFSETS
          path: dump_output/dump.cs