name: Big APK Deep Extractor (Final Fix)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Download & Extract APK
        run: |
          echo "[+] Downloading APK..."
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          unzip -q game.apk -d base_dir
          
          # نقل الملفات للمجلد الرئيسي
          find base_dir -name "libil2cpp.so" -exec cp {} ./libil2cpp.so \;
          find base_dir -name "global-metadata.dat" -exec cp {} ./global-metadata.dat \;
          
          if [ -f "libil2cpp.so" ] && [ -f "global-metadata.dat" ]; then
             echo "[+] Files found."
          else
             echo "[-] Error: Essential files missing."
             exit 1
          fi

      - name: Build and Run Dumper (Unified Step)
        run: |
          # 1. بناء الأداة
          git clone --depth 1 https://github.com/Perfare/Il2CppDumper.git source_code
          cd source_code
          dotnet build -c Release -f net8.0
          
          # 2. تحديد موقع الـ DLL بدقة داخل نفس الخطوة
          DLL_PATH=$(find bin/Release/net8.0 -name "Il2CppDumper.dll" | head -n 1)
          echo "[+] Found DLL at: $DLL_PATH"
          
          # 3. تشغيل الأداة فوراً (نستخدم ../ للرجوع للمكان الموجود فيه libil2cpp.so)
          echo "1" | dotnet "$DLL_PATH" ../libil2cpp.so ../global-metadata.dat ../
          
          cd ..
          if [ -f "dump.cs" ]; then
             echo "[+] dump.cs created successfully!"
          else
             echo "[-] dump.cs not found. Checking if it's inside source_code folder..."
             [ -f "source_code/dump.cs" ] && cp source_code/dump.cs .
          fi

      - name: Final Python JSON Pack
        shell: python
        run: |
          import os, re, json
          output_file = "all_offsets.json"
          # البحث عن الملف في المجلد الحالي أو المجلد الفرعي
          target = "dump.cs" if os.path.exists("dump.cs") else "source_code/dump.cs"
          
          if os.path.exists(target):
              data = {}
              with open(target, "r", encoding="utf-8") as f:
                  content = f.read()
                  matches = re.finditer(r"// RVA: (0x[A-F0-9]+).*?\n\s+.*? ([\w_<>]+)\(", content)
                  for m in matches:
                      data[m.group(2)] = m.group(1)
              with open(output_file, "w") as jf:
                  json.dump(data, jf, indent=4)
              print(f"[+] Success! {len(data)} methods extracted.")
          else:
              # تقرير فشل ذكي
              with open(output_file, "w") as jf:
                  json.dump({"error": "dump.cs not found after execution", "files": os.listdir('.')}, jf)

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Full-Game-Offsets
          path: all_offsets.json