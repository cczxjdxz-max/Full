name: GEASS-ULTIMATE-AUDIT

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: 1. FETCH PERFECT APK
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          file: 'Geass_Perfect_Master.apk'
          target: './final_master.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. FINAL FORENSIC SCAN
        run: |
          sudo apt-get update && sudo apt-get install -y apksigner
          
          echo "--- SIGNATURE REPORT ---" > audit_report.txt
          apksigner verify --verbose final_master.apk >> audit_report.txt 2>&1
          
          echo -e "\n--- PERMISSION INTEGRITY ---" >> audit_report.txt
          unzip -p final_master.apk AndroidManifest.xml > m_dump
          # ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ
          strings m_dump | grep "SYSTEM_ALERT_WINDOW" >> audit_report.txt || echo "âŒ PERMISSION_NOT_FOUND" >> audit_report.txt
          
          echo -e "\n--- FUNCTIONAL ENGINE CHECK ---" >> audit_report.txt
          unzip -p final_master.apk assets/python/internal_master.py > engine_check.py
          if grep -q "class GameAPI" engine_check.py; then
            echo "âœ… Engine Logic: INTACT" >> audit_report.txt
          else
            echo "âŒ Engine Logic: DAMAGED" >> audit_report.txt
          fi

      - name: 3. FINAL VERDICT (Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
        run: |
          echo "### ðŸ”± GEASS PERFECT MASTER - FINAL STATUS ðŸ”±" >> $GITHUB_STEP_SUMMARY
          echo "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ÙØ­Øµ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ø§Ù„Ù…Ø¹ÙŠØ§Ø± | Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„Ù†ØªÙŠØ¬Ø© |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          # ÙØ­Øµ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
          if grep -q "Verified using v2 scheme: true" audit_report.txt; then
            echo "| Ù‚ÙˆØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ | âœ… V2/V3 Full | Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù‚ÙˆØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ | âš ï¸ V1 Only | Ù‚Ø¯ ÙŠØ¸Ù‡Ø± ØªØ­Ø°ÙŠØ± Ù…Ù† Ø¬ÙˆØ¬Ù„ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
          if grep -q "SYSTEM_ALERT_WINDOW" audit_report.txt; then
            echo "| Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© | âœ… Ù…ÙØ¹Ù„ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ | ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø³Ù… ÙÙˆÙ‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© | âŒ ÙØ´Ù„ Ø§Ù„Ø­Ù‚Ù† | Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ù„Ù… ÙŠØªØ¹Ø¯Ù„ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÙØ­Øµ Ø§Ù„Ù…Ø­Ø±Ùƒ
          if grep -q "Engine Logic: INTACT" audit_report.txt; then
            echo "| Ù…Ø­Ø±Ùƒ GameAPI | âœ… Ù†Ø´Ø· | Ù…Ù„Ù Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ÙˆØ¬ÙˆØ¯ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ù…Ø­Ø±Ùƒ GameAPI | âŒ Ù…ÙÙ‚ÙˆØ¯ | Ø§Ù„Ù…Ù„Ù ØªØ¶Ø±Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„ |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 4. ARCHIVE LOGS
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_MASTER_REPORT
          path: audit_report.txt