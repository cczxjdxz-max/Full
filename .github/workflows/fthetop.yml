name: GEASS-MANIFEST-FIXER-V2

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix_manifest:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://github.com/REAndroid/APKEditor/releases/download/V1.4.1/APKEditor-1.4.1.jar" -o APKEditor.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. FETCH LATEST APK
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o input.apk

      - name: 3. AXML SURGERY (Using Edit Mode)
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù†Øµ Ù„Ù‚Ø±Ø§Ø¡ØªÙ‡ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡
          java -jar APKEditor.jar d -i input.apk -o temp_dir
          
          # Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ (Ø£Ù…Ø± Ù…Ø¶Ù…ÙˆÙ† 100%)
          sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' temp_dir/AndroidManifest.xml
          
          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Ù‡Ù†Ø§ ØªÙ‚ÙˆÙ… Ø§Ù„Ø£Ø¯Ø§Ø© Ø¨ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù€ Binary XML Ø³Ù„ÙŠÙ…)
          java -jar APKEditor.jar b -i temp_dir -o patched_manifest.apk
          
          echo "ğŸ” FINAL V2/V3 SIGNING..."
          java -jar signer.jar --apks patched_manifest.apk --out ./ --allowResign
          mv patched_manifest-aligned-debugSigned.apk Geass_Perfect_Master.apk

      - name: 4. PUBLISH PERFECT VERSION
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v8.0-final-perfect"
          name: "Geass Citadel - PERFECT MASTER V2"
          files: Geass_Perfect_Master.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}