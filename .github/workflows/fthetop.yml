name: GEASS-QUICK-FIX

on:
  workflow_dispatch:

jobs:
  patch_latest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. FETCH BROKEN APK
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          file: 'Geass_Internal_Citadel.apk'
          target: './broken.apk'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. SURGICAL REPAIR (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·)
        run: |
          # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙ‚Ø·
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar
          
          echo "ğŸ› ï¸ Fix 1: Injecting missing Permissions..."
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³ØªØŒ ØªØ¹Ø¯ÙŠÙ„Ù‡ØŒ Ø«Ù… Ø¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù„Ù…Ù„Ù Ø¯ÙˆÙ† ÙÙƒ Ø§Ù„Ø¶ØºØ· Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ØªÙˆÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª
          unzip broken.apk AndroidManifest.xml
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ ÙˆØ³Ù… manifest Ù…Ø¨Ø§Ø´Ø±Ø©
          sed -i '/<manifest/a <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' AndroidManifest.xml
          zip -u broken.apk AndroidManifest.xml
          
          echo "ğŸ› ï¸ Fix 2: Global Re-Signing..."
          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù€ v2 Ùˆ v3 ÙˆÙ…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù…Ù„Ù (ZipAlign)
          java -jar signer.jar --apks broken.apk --out ./ --allowResign
          
          mv broken-aligned-debugSigned.apk Geass_Fixed_Citadel.apk

      - name: 3. FINAL VERIFICATION
        run: |
          echo "ğŸ” Checking if Fixes applied..."
          unzip -p Geass_Fixed_Citadel.apk AndroidManifest.xml | strings | grep "SYSTEM_ALERT_WINDOW" && echo "âœ… PERMISSION: FIXED"
          java -jar signer.jar --verify --apks Geass_Fixed_Citadel.apk && echo "âœ… SIGNATURE: FIXED"

      - name: 4. UPDATE RELEASE WITH FIXED VERSION
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v2.1-fixed"
          name: "Geass Citadel - Fully Repaired"
          body: "ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­."
          files: Geass_Fixed_Citadel.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}