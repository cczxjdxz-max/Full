name: GEASS-FINAL-FUSION

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fusion:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP SURGICAL TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. FETCH CURRENT APK
        run: |
          # Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù…Ù„Ù ØªÙ… Ø±ÙØ¹Ù‡ Ø¢Ù„ÙŠØ§Ù‹
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o current.apk

      - name: 3. INJECT MENU & FIX PERMISSIONS (Direct Edit)
        run: |
          # Ø£- Ø­Ù‚Ù† ÙƒÙˆØ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
          echo 'import os; print("ğŸ”± GEASS MENU ACTIVE"); os.system("msg * \"Menu Loaded\"")' > internal_master.py
          zip -u current.apk assets/python/internal_master.py || zip -g current.apk assets/python/internal_master.py
          
          # Ø¨- Ø¥Ø¬Ø¨Ø§Ø± Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª ØªÙØ´Ù„) Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù ÙƒÙ„ÙŠØ§Ù‹
          unzip current.apk AndroidManifest.xml
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
          sed -i '/<application/i <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' AndroidManifest.xml
          zip -u current.apk AndroidManifest.xml

      - name: 4. FINAL V2/V3 SIGNING
        run: |
          # Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù‡Ùˆ Ø§Ù„Ø®ØªÙ… Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙŠØ«Ù‚ Ø¨ÙƒÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø£Ø¹Ù„Ø§Ù‡
          java -jar signer.jar --apks current.apk --out ./ --allowResign
          mv current-aligned-debugSigned.apk Geass_Ultimate_Ready.apk

      - name: 5. RELEASE THE READY VERSION
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v5.0-ready"
          name: "Geass Citadel - ULTIMATE READY"
          body: "Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ù‚ÙˆÙ†Ø©ØŒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø«Ø¨ØªØ©ØŒ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙƒØ§Ù…Ù„."
          files: Geass_Ultimate_Ready.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}