name: TOTAL-REPAIR-V3

on:
  workflow_dispatch:

jobs:
  full_rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. FULL DECOMPILE & PATCH
        run: |
          # Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù "Ø§Ù„Ù…ÙƒØ³ÙˆØ±"
          curl -L "Ø±Ø§Ø¨Ø·_Ù…Ù„ÙÙƒ_Ø§Ù„Ù…Ø¨Ø§Ø´Ø±_Ø£Ùˆ_Ø§Ø³ØªØ®Ø¯Ø§Ù…_fetch_action" -o broken.apk || exit 1
          
          echo "ğŸ—ï¸ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚ (Deep Decompile)..."
          java -jar apktool.jar d broken.apk -o decoded_dir -f
          
          echo "ğŸ’‰ Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙÙƒÙˆÙƒ..."
          # Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ù„Ù Ù†ØµÙŠ ÙˆØ§Ø¶Ø­ØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠÙ†Ø¬Ø­ Ø­ØªÙ…Ø§Ù‹
          sed -i '/<application/i <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' decoded_dir/AndroidManifest.xml
          
          echo "ğŸ—ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„Ø©..."
          java -jar apktool.jar b decoded_dir -o repatched_unsigned.apk
          
          echo "ğŸ” Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ (V2/V3)..."
          java -jar signer.jar --apks repatched_unsigned.apk --out ./ --allowResign
          
          mv repatched_unsigned-aligned-debugSigned.apk Geass_Master_V3.apk

      - name: 3. SELF-AUDIT (Ø§Ù„ØªØ£ÙƒØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹)
        run: |
          unzip -p Geass_Master_V3.apk AndroidManifest.xml | strings | grep "SYSTEM_ALERT_WINDOW" && echo "FINAL_CHECK=PASSED" >> $GITHUB_ENV
          java -jar signer.jar --verify --apks Geass_Master_V3.apk >> verify_log.txt

      - name: 4. PUBLISH MASTER RELEASE
        if: env.FINAL_CHECK == 'PASSED'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v3.0-master"
          name: "Geass Citadel - FINAL MASTER"
          body: "Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„: Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ù‚ÙˆÙ†Ø© ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙƒØ§Ù…Ù„ V2/V3. Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„."
          files: Geass_Master_V3.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}