name: GEASS-FINAL-FIX

on:
  workflow_dispatch:

jobs:
  rebuild_and_inject:
    runs-on: ubuntu-latest
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update
          curl -L "https://github.com/REAndroid/APKEditor/releases/download/V1.4.1/APKEditor-1.4.1.jar" -o APKEditor.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar
          curl -L "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -o base.apk

      - name: 2. MANIFEST SURGERY
        run: |
          java -jar APKEditor.jar d -i base.apk -o temp_dir
          # Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª
          sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' temp_dir/AndroidManifest.xml
          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
          java -jar APKEditor.jar b -i temp_dir -o intermediate.apk

      - name: 3. DIRECT PYTHON INJECTION (The Missing Link)
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ù‚Ù…Ø±Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
          mkdir -p assets/python
          cat << 'EOF' > assets/python/internal_master.py
          import os
          print("ğŸ”± GEASS COCKPIT ONLINE: ALL MODES READY")
          class GeassEngine:
              def __init__(self): self.modes = [1,2,3,4]
          EOF
          # Ø­Ù‚Ù† Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ APK Ø¨Ø¹Ø¯ Ø¨Ù†Ø§Ø¦Ù‡ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø°ÙÙ‡
          zip -ur intermediate.apk assets/python/internal_master.py
          echo "âœ… Python Engine Injected Directly via Zip."

      - name: 4. SIGN & VERIFY
        run: |
          java -jar signer.jar --apks intermediate.apk --out ./ --allowResign
          mv intermediate-aligned-debugSigned.apk Geass_War_Final.apk
          
          # ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
          unzip -l Geass_War_Final.apk | grep "internal_master.py"

      - name: 5. RELEASE
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v20.2-final"
          name: "Geass War - Fixed & Injected"
          files: Geass_War_Final.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}