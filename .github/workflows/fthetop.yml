name: GEASS-INTEGRITY-CHECK

on:
  workflow_dispatch: # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ APK

jobs:
  verify_injection:
    runs-on: ubuntu-latest
    steps:
      - name: 1. GET THE APK
        run: |
          # Ø³Ø­Ø¨ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡Ø§ Ù…Ù† Ø§Ù„Ù€ Releases
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o target_game.apk
          echo "âœ… APK Downloaded for inspection."

      - name: 2. RUN COMPREHENSIVE INTEGRITY SCAN
        run: |
          python3 - << 'EOF'
          import zipfile
          import os

          apk_path = "target_game.apk"
          print(f"\n{'='*40}")
          print(f"ðŸ” GEASS INTEGRITY RADAR STARTING...")
          print(f"{'='*40}")
          
          if not os.path.exists(apk_path):
              print("âŒ ERROR: APK file not found!")
              exit(1)

          with zipfile.ZipFile(apk_path, 'r') as apk:
              files = apk.namelist()
              
              # Ø§Ù„ÙØ­Øµ 1: Ù‚Ù…Ø±Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Python Engine)
              py_engine = "assets/python/internal_master.py"
              if py_engine in files:
                  print(f"âœ… [PASS] Python Engine found: {py_engine}")
                  # Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
                  with apk.open(py_engine) as f:
                      content = f.read().decode('utf-8')
                      print(f"   ðŸ“œ Code Size: {len(content)} bytes")
              else:
                  print(f"âŒ [FAIL] Python Engine MISSING in assets!")

              # Ø§Ù„ÙØ­Øµ 2: Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø§Ø­ÙŠØ© (Manifest Check)
              # Ø³Ù†Ø¨Ø­Ø« Ø¹Ù† Ø¨ØµÙ…Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ
              try:
                  with apk.open("AndroidManifest.xml") as m:
                      manifest_data = m.read()
                      if b"SYSTEM_ALERT_WINDOW" in manifest_data:
                          print("âœ… [PASS] Overlay Permission (SYSTEM_ALERT_WINDOW) injected.")
                      else:
                          print("âŒ [FAIL] Overlay Permission NOT FOUND in Manifest.")
              except:
                  print("âš ï¸ [WARN] Could not parse Manifest binary directly.")

              # Ø§Ù„ÙØ­Øµ 3: Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ù…
              print(f"ðŸ“¦ Total files in APK: {len(files)}")
              print(f"ðŸ“Š Final File Size: {os.path.getsize(apk_path) / (1024*1024):.2f} MB")

          print(f"{'='*40}\nðŸ SCAN COMPLETE\n")
          EOF

      - name: 3. REPORT STATUS
        if: always()
        run: echo "Check finished. Review the logs above for [PASS] or [FAIL] status."