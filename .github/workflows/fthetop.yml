# .github/workflows/geass-sovereign-resilient-build.yml
name: GEASS-SOVEREIGN-RESILIENT-BUILD

on:
  workflow_dispatch:

jobs:
  forge_and_seal:
    runs-on: ubuntu-latest
    steps:
      - name: 1. MASTER_ENVIRONMENT_PREP
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk apksigner wget zip unzip g++-aarch64-linux-gnu
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          mkdir -p ./GEASS/payload/lib ./GEASS/final_apk ./GEASS/knowledge_base
          echo "âœ… Master Forge Initialized."

      - name: 2. FORGE_NEURAL_BRIDGE (NO-NDK-STUB)
        run: |
          echo "ðŸ”— Forging Bridge with Manual Linking..."
          JAVA_HOME_PATH="/usr/lib/jvm/java-17-openjdk-amd64"
          
          cat << 'EOF' > bridge.cpp
          #include <jni.h>
          extern "C" int __android_log_print(int prio, const char* tag, const char* fmt, ...);
          #define LOG_INFO 4

          extern "C" {
              JNIEXPORT void JNICALL
              Java_com_geass_overlay_NativeBridge_executePython(JNIEnv* env, jobject obj, jstring code) {
                  const char* pyCode = env->GetStringUTFChars(code, NULL);
                  __android_log_print(LOG_INFO, "GEASS_BRIDGE", "Input: %s", pyCode);
                  env->ReleaseStringUTFChars(code, pyCode);
              }
          }
          EOF

          aarch64-linux-gnu-g++ -shared -fPIC \
            -I"$JAVA_HOME_PATH/include" \
            -I"$JAVA_HOME_PATH/include/linux" \
            bridge.cpp -o ./GEASS/payload/lib/libgeass_bridge.so
          echo "âœ… Bridge Compiled."

      - name: 3. INTEGRATE_PYTHON_CORE (BYPASSING ERROR 8)
        run: |
          echo "ðŸ“¥ Fetching Python Core with No-Check Strategy..."
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙŠØ§Ø±Ø§Øª ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
          wget --no-check-certificate --quiet --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 --tries=3 \
          -O python_runtime.zip "https://github.com/beeware/python-android-support/releases/download/3.11/python-3.11-arm64-v8a.zip" || { echo "âŒ Critical: Download failed"; exit 1; }
          
          unzip -q python_runtime.zip -d python_core
          
          # Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¹Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ù‚Ù† Ø§Ù„ØµØ­ÙŠØ­
          find python_core -name "libpython3.11.so" -exec cp {} ./GEASS/payload/lib/libpython_geass.so \;
          
          if [ ! -f ./GEASS/payload/lib/libpython_geass.so ]; then
            echo "âŒ Critical: Library not found after unzip"; exit 1;
          fi
          
          # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
          echo '{"gravity": 9.81, "720p": true}' > ./GEASS/knowledge_base/physics.json
          echo -e 'class GameAPI:\n    @staticmethod\n    def start(): print("AI Active")' > ./GEASS/knowledge_base/sovereign.py
          echo "âœ… Core Assets Prepared."

      - name: 4. SURGICAL_REBUILD
        run: |
          echo "ðŸ—ï¸ Downloading Target Game Engine..."
          wget --no-check-certificate -q -O Target.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          java -jar apktool.jar d Target.apk -o decoded_source
          
          echo "ðŸ’‰ Injecting Sovereign Components..."
          mkdir -p decoded_source/lib/arm64-v8a/
          cp ./GEASS/payload/lib/*.so decoded_source/lib/arm64-v8a/
          
          # ØªØºÙŠÙŠØ± Ù‡ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ØµØ±ÙŠØ§Ù‹
          sed -i 's/>Free Fire</>GEASS SOVEREIGN</g' decoded_source/res/values/strings.xml
          
          echo "ðŸ—ï¸ Reassembling the Master APK..."
          java -jar apktool.jar b decoded_source -o ./GEASS/final_apk/Geass_Raw.apk

      - name: 5. SOVEREIGN_SIGNING
        run: |
          keytool -genkey -v -keystore geass.jks -alias geass -keyalg RSA -keysize 2048 -validity 10000 -storepass 123456 -keypass 123456 -dname "CN=GEASS"
          apksigner sign --ks geass.jks --ks-pass pass:123456 \
            --out ./GEASS/final_apk/Geass_Sovereign_V1.apk \
            ./GEASS/final_apk/Geass_Raw.apk
          echo "âœ… Sovereign Entity is Signed."

      - name: 6. UPLOAD_ARTIFACTS
        uses: actions/upload-artifact@v4
        with:
          name: GEASS_FINAL_SYSTEM
          path: |
            ./GEASS/final_apk/Geass_Sovereign_V1.apk
            ./GEASS/knowledge_base/