name: GEASS-CITADEL-FULL-SURGERY

on:
  workflow_dispatch:

jobs:
  forge_and_test:
    runs-on: macos-latest
    steps:
      - name: 1. PREPARE SURGICAL TOOLS
        run: |
          brew install apktool
          # ØªØ­Ù…ÙŠÙ„ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
          mkdir -p ./CITADEL/workspace ./CITADEL/output
          echo "âœ… Tools Ready."

      - name: 2. THE SURGICAL PROCESS (Download, Inject, Build)
        run: |
          echo "ğŸ“¥ Downloading Official Base APK..."
          curl -L "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -o ./CITADEL/workspace/base.apk
          
          echo "ğŸ—ï¸ Decompiling..."
          apktool d ./CITADEL/workspace/base.apk -o ./CITADEL/workspace/decoded
          
          echo "ğŸ’‰ Injecting Sovereign Core & Cockpit UI..."
          # Ø­Ù‚Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
          mkdir -p ./CITADEL/workspace/decoded/assets/python
          cat << 'EOF' > ./CITADEL/workspace/decoded/assets/python/internal_master.py
          import os
          print("ğŸ”± Sovereign Internal Engine: ONLINE")
          EOF
          
          # Ø­Ù‚Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (XML)
          mkdir -p ./CITADEL/workspace/decoded/res/layout
          cat << 'EOF' > ./CITADEL/workspace/decoded/res/layout/geass_cockpit.xml
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="wrap_content"
              android:background="#AA000000" android:orientation="vertical">
              <TextView android:text="CITADEL CONSOLE" android:textColor="#FF0000" android:layout_gravity="center"/>
          </LinearLayout>
          EOF

          echo "ğŸ› ï¸ Patching AndroidManifest for System Overlay..."
          # Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø³Ù… ÙÙˆÙ‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
          sed -i '' '/<application/a \
          <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' ./CITADEL/workspace/decoded/AndroidManifest.xml

          echo "ğŸ—ï¸ Rebuilding the Citadel Artifact..."
          apktool b ./CITADEL/workspace/decoded -o ./CITADEL/output/Citadel_Unsigned.apk
          
          echo "âœï¸ Signing with Master Key..."
          keytool -genkey -v -keystore citadel.jks -alias citadel -keyalg RSA -keysize 2048 -validity 10000 -storepass 123456 -keypass 123456 -dname "CN=CITADEL"
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… apksigner (Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ macOS runner)
          apksigner sign --ks citadel.jks --ks-pass pass:123456 --out Geass_Internal_Citadel.apk ./CITADEL/output/Citadel_Unsigned.apk

      - name: 3. REAL-DATA VALIDATION (No more 0-byte errors)
        run: |
          echo "ğŸ” Running Deep Inspection on Final APK..."
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ ÙˆØ£Ù†Ù‡ Ø¨ØµÙŠØºØ© ZIP ØµØ§Ù„Ø­Ø©
          unzip -l Geass_Internal_Citadel.apk | grep "assets/python/internal_master.py" && echo "âœ… Python Core: INJECTED"
          unzip -l Geass_Internal_Citadel.apk | grep "res/layout/geass_cockpit.xml" && echo "âœ… Cockpit UI: INJECTED"
          
          # ÙØ­Øµ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙØ¹Ù„ÙŠ
          FILE_SIZE=$(stat -f%z "Geass_Internal_Citadel.apk")
          echo "ğŸ“¦ Final APK Size: $FILE_SIZE bytes"
          if [ $FILE_SIZE -lt 1000000 ]; then echo "âŒ Error: APK too small!"; exit 1; fi

      - name: 4. VIRTUAL FIELD TEST (Optimized Emulator)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          emulator-boot-timeout: 1200
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -memory 4096
          script: |
            adb wait-for-device
            echo "ğŸš€ Installing Geass Citadel..."
            adb install -r Geass_Internal_Citadel.apk
            echo "â±ï¸ Launching Game Process..."
            adb shell monkey -p com.dts.freefireth -c android.intent.category.LAUNCHER 1
            sleep 60
            adb logcat -d > field_report.log
            echo "ğŸ“Š Finalizing Result..."
            adb shell "netstat -an | grep 1337" || echo "API Port not yet open"

      - name: 5. ARCHIVE MASTER ARTIFACT
        uses: actions/upload-artifact@v4
        with:
          name: GEASS_FINAL_CITADEL
          path: |
            Geass_Internal_Citadel.apk
            field_report.log