name: SMART-REPAIR-V4

on:
  workflow_dispatch:

jobs:
  repair:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. SETUP TOOLS
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-17-jdk curl zip unzip
          curl -L "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar" -o apktool.jar
          curl -L "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -o signer.jar

      - name: 2. AUTO-FETCH ANY APK (Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
        run: |
          # ÙƒÙˆØ¯ Ù„Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¢Ø®Ø± Ù…Ù„Ù APK Ù…Ø±ÙÙˆØ¹ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
          RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          APK_URL=$(echo "$RELEASE_JSON" | grep -oP '"browser_download_url": "\K[^"]+\.apk(?=")' | head -1)
          
          if [ -z "$APK_URL" ]; then echo "âŒ No APK found in latest release!"; exit 1; fi
          
          echo "ğŸ“¥ Downloading: $APK_URL"
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$APK_URL" -o target.apk

      - name: 3. DEEP SURGERY
        run: |
          java -jar apktool.jar d target.apk -o decoded -f
          
          # Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­
          sed -i '/<application/i \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>' decoded/AndroidManifest.xml
          
          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø´Ø§Ù…Ù„
          java -jar apktool.jar b decoded -o repatched.apk
          java -jar signer.jar --apks repatched.apk --out ./ --allowResign
          
          mv repatched-aligned-debugSigned.apk Geass_Master_Final.apk

      - name: 4. RELEASE FIXED VERSION
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v4.0-final"
          name: "Geass Citadel - FINAL REPAIR"
          files: Geass_Master_Final.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}