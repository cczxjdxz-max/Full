name: Auto APK Offset Extractor (Ultimate Fix)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up .NET & Python
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Download and Extract APK
        run: |
          echo "[+] Downloading APK..."
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          
          echo "[+] Extracting lib and metadata..."
          # استخراج الملفات بغض النظر عن المسار الداخلي
          unzip -o game.apk "lib/arm64-v8a/libil2cpp.so" "assets/bin/Data/Managed/Metadata/global-metadata.dat" -d out_files || unzip -o game.apk "lib/armeabi-v7a/libil2cpp.so" "assets/bin/Data/Managed/Metadata/global-metadata.dat" -d out_files
          
          # تجميع الملفات في المجلد الرئيسي
          find out_files -name "libil2cpp.so" -exec cp {} . \;
          find out_files -name "global-metadata.dat" -exec cp {} . \;
          
          if [ -f "libil2cpp.so" ] && [ -f "global-metadata.dat" ]; then
            echo "[+] Files ready."
          else
            echo "[-] Error: APK files not found."
            exit 1
          fi

      - name: Build & Run Il2CppDumper
        run: |
          git clone --depth 1 https://github.com/Perfare/Il2CppDumper.git source_code
          cd source_code
          dotnet publish -c Release -f net8.0 -r linux-x64 --self-contained true /p:PublishSingleFile=true
          
          # البحث عن الملف التنفيذي ونقله بغض النظر عن مساره
          find . -type f -executable -name "Il2CppDumper" -exec cp {} ../dumper \;
          cd ..
          
          if [ -f "./dumper" ]; then
            chmod +x dumper
            echo "1" | ./dumper libil2cpp.so global-metadata.dat . || true
          else
            echo "[!] Dumper build failed to find executable."
          fi

      - name: Run Cpp2IL (Strong Fallback)
        if: hashFiles('dump.cs') == ''
        run: |
          echo "[!] dump.cs missing. Running Cpp2IL..."
          wget -q https://github.com/SamboyCoding/Cpp2IL/releases/download/v2022.1.0-pre-release.10/Cpp2IL-Net8.0-Linux-x64 -O cpp2il
          chmod +x cpp2il
          # تشغيل Cpp2IL لاستخراج المعلومات كـ Dummy DLLs أو ملفات نصية
          ./cpp2il --game-path . --output-as-csv || true

      - name: Final Extraction to JSON
        shell: python
        run: |
          import os, re, json
          data = {}
          # محاولة الاستخراج من dump.cs (Il2CppDumper)
          if os.path.exists("dump.cs"):
              print("[+] Processing dump.cs...")
              with open("dump.cs", "r", encoding="utf-8") as f:
                  content = f.read()
                  matches = re.finditer(r"// RVA: (0x[A-F0-9]+).*?\n\s+.*? ([\w_<>]+)\(", content)
                  for m in matches: data[m.group(2)] = m.group(1)
          
          # محاولة الاستخراج من cpp2il_out.csv (Cpp2IL)
          elif os.path.exists("cpp2il_out.csv"):
              print("[+] Processing Cpp2IL CSV...")
              with open("cpp2il_out.csv", "r") as f:
                  for line in f:
                      p = line.split(',')
                      if len(p) >= 3: data[p[1]] = p[2]

          if data:
              with open("all_offsets.json", "w") as jf: json.dump(data, jf, indent=4)
              print(f"[+] Success! {len(data)} items found.")
          else:
              with open("all_offsets.json", "w") as jf:
                  json.dump({"error": "No data. File might be protected."}, jf)

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Final-Offsets-JSON
          path: all_offsets.json