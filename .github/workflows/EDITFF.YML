name: GIAS SURGICAL PATCHER 2026 (Final Stage)

on:
  workflow_dispatch:
    inputs:
      target_offset:
        description: 'ادخل العنوان (Offset) الذي وجدته في التقرير (مثال: 0xa23f10)'
        required: true
        default: '0x000000'

jobs:
  patch_and_rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. تجهيز الأدوات (بما في ذلك أدوات توقيع الـ APK)
      - name: 1. Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget zip p7zip-full openjdk-17-jdk-headless
          # تحميل أداة توقيع الـ APK
          wget https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar -O signer.jar

      # 2. تحميل اللعبة واستخراج الملفات
      - name: 2. Extract APK
        run: |
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O Game.apk
          7z x Game.apk -oextracted_files -y
          # تحديد مسار ملف المنطق 64-بت
          LIB_PATH=$(find extracted_files -name "libil2cpp.so" | grep "arm64-v8a" | head -n 1)
          cp "$LIB_PATH" ./libil2cpp.so

      # 3. سكريبت الباتش الذكي (بايثون)
      - name: 3. Apply Surgical Patch
        run: |
          python3 -c '
          import os, sys
          offset_str = "${{ github.event.inputs.target_offset }}"
          offset = int(offset_str, 16)
          
          # تعليمة RET لمعمارية ARM64 (تعيد القيمة فوراً وتمنع تنفيذ الدالة)
          patch = b"\xc0\x03\x5f\xd6"
          
          with open("libil2cpp.so", "r+b") as f:
              f.seek(offset)
              f.write(patch)
          print(f"Successfully patched at {offset_str}")
          '

      # 4. إعادة الملف المعدل للـ APK وبناء النسخة الجديدة
      - name: 4. Rebuild and Sign APK
        run: |
          # استبدال الملف القديم بالمعدل
          LIB_INTERNAL_PATH=$(find extracted_files -name "libil2cpp.so" | grep "arm64-v8a" | head -n 1)
          cp ./libil2cpp.so "$LIB_INTERNAL_PATH"
          
          # ضغط الملفات مرة أخرى (بدون توقيع أولاً)
          cd extracted_files && zip -r ../Modified_Unsigned.apk . && cd ..
          
          # توقيع الـ APK ليعمل على الهاتف
          java -jar signer.jar --apks Modified_Unsigned.apk
          mv Modified_Unsigned-aligned-debugSigned.apk FreeFire_Patched.apk

      # 5. رفع النسخة المعدلة والتقرير
      - name: 5. Release Patched APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: patched-v${{ github.run_number }}
          name: "FreeFire Modded Version v${{ github.run_number }}"
          body: |
            تم تطبيق الباتش بنجاح على العنوان: `${{ github.event.inputs.target_offset }}`.
            النسخة المرفقة جاهزة للتثبيت (موقعة).
          files: FreeFire_Patched.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}