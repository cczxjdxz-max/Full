name: GIAS Hybrid Pipeline V11 - Terminal Fix

on:
  workflow_dispatch:

jobs:
  prepare_essentials_for_mobile:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Prepare Environment
        run: |
          sudo apt-get update
          # تثبيت util-linux لتوفير أداة script إذا لم تكن موجودة
          sudo apt-get install -y unzip wget zip util-linux

      - name: 2. Download Game and AssetRipper
        run: |
          echo "--- Downloading Game Package (501 MB) ---"
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O GamePackage.apk
          
          echo "--- Downloading AssetRipper ---"
          wget "https://github.com/AssetRipper/AssetRipper/releases/download/0.3.0.6/AssetRipper_linux_x64.zip" -O assetripper.zip
          unzip assetripper.zip -d AssetRipper
          chmod +x ./AssetRipper/AssetRipper

      - name: 3. Full Asset Extraction (Terminal Emulation Mode)
        run: |
          echo "--- Starting extraction using Terminal Emulation ---"
          # أداة script تخدع البرنامج ليعتقد أنه يعمل داخل Terminal حقيقي لتجنب خطأ ReadKey
          # قمنا بإزالة الأعلام التي سببت أخطاء في التعرف على المسارات
          script -e -c "./AssetRipper/AssetRipper GamePackage.apk -o temp_full_extract" /dev/null
          echo "--- Extraction finished ---"

      - name: 4. Smart Filtering and Categorization
        run: |
          echo "--- Organizing files ---"
          mkdir -p GIAS_Essentials/1_Data GIAS_Essentials/2_Assets GIAS_Essentials/3_Logic
          
          # البحث في كامل المجلد المستخرج لضمان الوصول للملفات مهما كانت الهيكلية
          echo "--- Finding Data files ---"
          find temp_full_extract -type f \( -name "*.json" -o -name "*.xml" \) -exec cp {} GIAS_Essentials/1_Data/ \; || true
          
          echo "--- Finding Visual Assets ---"
          find temp_full_extract -type f \( -name "*.obj" -o -name "*.fbx" -o -name "*.png" \) -exec cp {} GIAS_Essentials/2_Assets/ \; || true
          
          echo "--- Finding Logic (libil2cpp.so) ---"
          find temp_full_extract -name "libil2cpp.so" -exec cp {} GIAS_Essentials/3_Logic/ \; || true

      - name: 5. Compress and Cleanup
        run: |
          zip -r GIAS_Essentials.zip GIAS_Essentials
          rm -rf temp_full_extract GamePackage.apk AssetRipper*
          echo "--- Final package info: ---"
          ls -lh GIAS_Essentials.zip

      - name: 6. Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: essentials-v${{ github.run_number }}
          name: "GIAS Essentials v${{ github.run_number }}"
          body: "Extracted using Terminal Emulation to bypass Console restrictions. Ready for dev."
          files: GIAS_Essentials.zip