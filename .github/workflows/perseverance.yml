name: GIAS_FINAL_WORKFLOW

on:
  workflow_dispatch:

jobs:
  build_and_release_assets:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # الخطوة 1: تجهيز البيئة وتثبيت الأدوات الأساسية
      - name: 1. Prepare Environment
        run: |
          sudo apt-get update && sudo apt-get install -y unzip wget zip
          echo "--- Environment is ready ---"

      # الخطوة 2: تنزيل ملف اللعبة
      - name: 2. Download Game Package
        run: |
          curl -L "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -o GamePackage.apk --progress-bar
          echo "--- Download Complete ---"

      # الخطوة 3: تنزيل وتجهيز أداة AssetRipper
      - name: 3. Download AssetRipper
        run: |
          wget "https://github.com/AssetRipper/AssetRipper/releases/download/0.3.0.6/AssetRipper_linux_x64.zip" -O assetripper.zip
          unzip assetripper.zip -d AssetRipper
          chmod +x ./AssetRipper/AssetRipper
          echo "--- AssetRipper is ready ---"

      # الخطوة 4: استخراج الأصول مع حل مشكلة الـ Console
      - name: 4. Export Assets
        run: |
          echo "--- Starting asset export ---"
          # استخدام echo لإرسال ضغطة Enter تلقائياً للبرنامج لمنع الانهيار
          # تم اختصار الأوامر للمسارات الأساسية فقط لضمان التوافق
          echo -e "\n" | ./AssetRipper/AssetRipper GamePackage.apk -o exported_assets
          echo "--- Asset Export Finished ---"

      # الخطوة 5: ضغط الملفات الناتجة وتنظيف البيئة
      - name: 5. Compress Assets
        run: |
          echo "--- Compressing files, please wait ---"
          zip -r Digital-Twin-Assets.zip ./exported_assets
          # حذف الملفات الكبيرة لتجنب امتلاء مساحة الـ Runner
          rm -rf ./exported_assets
          rm GamePackage.apk
          echo "--- Assets compressed and cleanup finished ---"

      # الخطوة 6: رفع الملفات إلى قسم Releases في GitHub
      - name: 6. Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: assets-v${{ github.run_number }}
          name: "Digital Twin Assets v${{ github.run_number }}"
          body: "Automated export of game assets for GIAS training. Build Number: ${{ github.run_number }}"
          files: Digital-Twin-Assets.zip