name: GIAS V14 - Analysis Engine

on:
  workflow_dispatch:

jobs:
  extract_and_analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # الخطوة 1: تجهيز البيئة (مع p7zip-full)
      - name: 1. Prepare Environment
        run: sudo apt-get update && sudo apt-get install -y unzip wget zip p7zip-full

      # الخطوة 2: تنزيل اللعبة والأدوات
      - name: 2. Download Game and Tools
        run: |
          echo "--- Downloading Game Package ---"
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O GamePackage.apk
          
          echo "--- Downloading Il2CppDumper ---"
          # تنزيل أحدث إصدار من Il2CppDumper
          wget "https://github.com/Perfare/Il2CppDumper/releases/latest/download/Il2CppDumper-linux-x64.zip" -O il2cppdumper.zip
          unzip il2cppdumper.zip -d Il2CppDumper
          chmod +x ./Il2CppDumper/Il2CppDumper

      # الخطوة 3: الاستخراج الخام للملفات
      - name: 3. Raw File Extraction
        run: |
          echo "--- Extracting all raw files from APK ---"
          mkdir temp_raw_extract
          7z x GamePackage.apk -otemp_raw_extract -y

      # الخطوة 4: البحث عن ملفات المنطق الأساسية
      - name: 4. Locate Core Logic Files
        run: |
          echo "--- Finding libil2cpp.so and global-metadata.dat ---"
          # البحث عن الملفات ونسخها إلى المجلد الرئيسي لسهولة الوصول
          find temp_raw_extract -name "libil2cpp.so" -exec cp {} . \;
          find temp_raw_extract -name "global-metadata.dat" -exec cp {} . \;
          
          # التحقق من وجود الملفات
          if [ ! -f "libil2cpp.so" ] || [ ! -f "global-metadata.dat" ]; then
            echo "::error::Core logic files not found! Cannot proceed with analysis."
            exit 1
          fi
          echo "--- Core logic files are ready for analysis ---"

      # الخطوة 5: تشغيل محرك التحليل (Il2CppDumper)
      - name: 5. Run Analysis Engine
        run: |
          echo "--- Running Il2CppDumper to generate analysis scripts ---"
          # تشغيل الأداة على الملفات التي وجدناها
          ./Il2CppDumper/Il2CppDumper libil2cpp.so global-metadata.dat
          # سيتم إنشاء مجلد مخرجات (عادة اسمه Dumper_out)
          echo "--- Analysis complete ---"

      # الخطوة 6: تجميع كل شيء في حزمة نهائية
      - name: 6. Organize Final Package
        run: |
          echo "--- Organizing all extracted and analyzed files ---"
          # إنشاء بنية المجلدات النهائية
          mkdir -p GIAS_Complete/1_Data GIAS_Complete/3_Logic GIAS_Complete/4_Analysis
          
          # نسخ ملفات البيانات الخام
          find temp_raw_extract -type f \( -name "*.dat" -o -name "*.bin" \) -exec cp {} GIAS_Complete/1_Data/ \; 2>/dev/null || true
          
          # نسخ ملفات المنطق الأصلية
          cp libil2cpp.so global-metadata.dat GIAS_Complete/3_Logic/
          
          # نقل مخرجات التحليل إلى المجلد الخاص بها
          mv Dumper_out/* GIAS_Complete/4_Analysis/
          
          echo "--- Final package organized ---"
          ls -R GIAS_Complete/

      # الخطوة 7: ضغط ورفع الحزمة الكاملة
      - name: 7. Compress and Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: analysis-v${{ github.run_number }}
          name: "GIAS Analysis Package v${{ github.run_number }}"
          body: |
            Complete package containing:
            - 1_Data: Raw game data files (.bin, .dat).
            - 3_Logic: Original core logic files.
            - 4_Analysis: Decompiled scripts and metadata from Il2CppDumper.
          files: |
            GIAS_Complete.zip
        run: |
          zip -r GIAS_Complete.zip GIAS_Complete