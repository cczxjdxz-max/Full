name: GIAS_AUTOMATED_ASSET_PIPELINE

on:
  workflow_dispatch: # يسمح بتشغيل الـ Workflow يدويًا

jobs:
  download_unpack_and_export:
    runs-on: ubuntu-latest

    steps:
      # الخطوة 1: تنزيل ملف XAPK الكامل تلقائيًا
      - name: 1. Download Full XAPK
        run: |
          echo "--- Starting download from APKPure server ---"
          # هذا هو الأمر السحري الذي اكتشفناه. سيقوم بتنزيل الملف الكامل.
          curl -L "https://d.apkpure.com/b/XAPK/com.dts.freefireth?version=latest" \
          -H "User-Agent: APKPure/3.19.72 (com.apkpure.aegon; 11197202) Android/11 (samsung; SM-G998B)" \
          -o FreeFire.xapk --progress-bar
          echo "\n--- Download Complete ---"
          ls -lh FreeFire.xapk # عرض حجم الملف للتأكد

      # الخطوة 2: تفكيك حزمة XAPK
      - name: 2. Unpack XAPK file
        run: |
          echo "--- Installing unzip utility ---"
          sudo apt-get update && sudo apt-get install -y unzip

          echo "--- Unpacking XAPK to access OBB and APK ---"
          mkdir game_files
          unzip FreeFire.xapk -d ./game_files
          echo "--- XAPK Unpacked ---"
          ls -l ./game_files # عرض المحتويات (يجب أن نرى APK و OBB)

      # الخطوة 3: تحديد موقع ملف OBB وتجهيزه للتحليل
      - name: 3. Locate OBB and Prepare for Analysis
        run: |
          # ملف OBB سيكون داخل مجلد Android/obb/com.dts.freefireth
          # سنقوم بنقله إلى مكان أسهل للوصول إليه
          mv ./game_files/Android/obb/com.dts.freefireth/*.obb ./main.obb
          echo "--- OBB file located and renamed to main.obb ---"
          ls -lh main.obb

      # الخطوة 4: تفكيك ملف OBB واستخراج الأصول
      - name: 4. Unpack OBB and Export Assets
        run: |
          echo "--- Downloading AssetStudioCLI ---"
          curl -L "https://github.com/Perfare/AssetStudio/releases/download/v0.17.25/AssetStudio.CLI_net6_linux-x64.zip" -o assetstudio.zip
          unzip assetstudio.zip -d AssetStudioCLI
          chmod +x ./AssetStudioCLI/AssetStudio.CLI

          echo "--- Starting automated asset export from OBB ---"
          mkdir exported_assets
          # استخدام AssetStudioCLI لتفكيك ملف main.obb
          ./AssetStudioCLI/AssetStudio.CLI main.obb ./exported_assets
          echo "--- Asset Export Finished ---"

      # الخطوة 5: رفع الأصول النهائية للتحميل
      - name: 5. Upload Final Assets as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GIAS-Extracted-Game-Assets
          path: ./exported_assets/

