name: GIAS Hybrid Pipeline V13 - Multi-Strategy

on:
  workflow_dispatch:

jobs:
  prepare_essentials_for_mobile:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Prepare Environment
        run: sudo apt-get update && sudo apt-get install -y unzip wget zip util-linux p7zip-full

      - name: 2. Download Tools and Game
        run: |
          echo "--- Downloading Free Fire APK ---"
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O GamePackage.apk
          
          echo "--- Downloading AssetRipper ---"
          wget "https://github.com/AssetRipper/AssetRipper/releases/download/0.3.0.6/AssetRipper_linux_x64.zip" -O assetripper.zip
          unzip assetripper.zip -d AssetRipper
          chmod +x ./AssetRipper/AssetRipper

      - name: 3. Extraction Strategy A (AssetRipper)
        run: |
          echo "--- Attempting AssetRipper Extraction ---"
          script -e -c "./AssetRipper/AssetRipper GamePackage.apk -o temp_extract_ripper" /dev/null || true

      - name: 4. Extraction Strategy B (Manual Unzip)
        run: |
          echo "--- Extracting Raw Files as Backup ---"
          mkdir -p temp_raw_extract
          7z x GamePackage.apk -otemp_raw_extract -y

      - name: 5. Smart Filtering (Collecting from all sources)
        run: |
          mkdir -p GIAS_Essentials/1_Data GIAS_Essentials/2_Assets GIAS_Essentials/3_Logic
          
          # البحث في كل المجلدات المستخرجة (الريبر واليدوي)
          echo "--- Collecting Data (.json, .xml, .dat) ---"
          find . -type f \( -name "*.json" -o -name "*.xml" -o -name "*.dat" -o -name "*.bin" \) -exec cp {} GIAS_Essentials/1_Data/ \; 2>/dev/null || true
          
          echo "--- Collecting Visuals (.png, .jpg, .obj, .fbx) ---"
          find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.obj" -o -name "*.fbx" \) -exec cp {} GIAS_Essentials/2_Assets/ \; 2>/dev/null || true
          
          echo "--- Collecting Logic (libil2cpp.so, metadata) ---"
          find . -name "libil2cpp.so" -exec cp {} GIAS_Essentials/3_Logic/ \; 2>/dev/null || true
          find . -name "global-metadata.dat" -exec cp {} GIAS_Essentials/3_Logic/ \; 2>/dev/null || true

      - name: 6. Integrity Check
        run: |
          echo "--- Checking Captured Files ---"
          ls -R GIAS_Essentials/
          du -sh GIAS_Essentials/

      - name: 7. Compress and Release
        run: |
          zip -r GIAS_Essentials.zip GIAS_Essentials
          
      - name: 8. Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "GIAS Essentials v${{ github.run_number }}"
          files: GIAS_Essentials.zip