name: GIAS TRAINING ARENA (V1 - Setup)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'ادخل الـ Tag الخاص بالإصدار المعدل (مثال: patched-v123)'
        required: true

jobs:
  setup_training_environment:
    runs-on: ubuntu-latest

    steps:
      # 1. تجهيز البيئة وتفعيل المحاكاة الافتراضية
      - name: 1. Enable KVM for Android Emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666"' | sudo tee /etc/udev/rules.d/99-kvm.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils cpu-checker

      # 2. تنزيل وتثبيت أدوات سطر أوامر أندرويد
      - name: 2. Install Android SDK Command-Line Tools
        run: |
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          mkdir -p android-sdk
          unzip cmdline-tools.zip -d android-sdk
          mv android-sdk/cmdline-tools android-sdk/latest
          mkdir -p android-sdk/cmdline-tools
          mv android-sdk/latest android-sdk/cmdline-tools/
          # قبول التراخيص وتثبيت صورة النظام والمحاكي
          yes | sdkmanager --sdk_root=./android-sdk "platform-tools" "platforms;android-30" "system-images;android-30;google_apis;x86_64" "emulator"
          # إضافة أدوات SDK إلى مسار النظام
          echo "$PWD/android-sdk/platform-tools" >> $GITHUB_PATH
          echo "$PWD/android-sdk/emulator" >> $GITHUB_PATH
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        env:
          ANDROID_SDK_ROOT: ./android-sdk

      # 3. إنشاء وتشغيل المحاكي
      - name: 3. Create and Run Emulator
        run: |
          # إنشاء جهاز افتراضي
          echo "no" | avdmanager create avd -n test_avd -k "system-images;android-30;google_apis;x86_64"
          # تشغيل المحاكي في الخلفية بدون واجهة رسومية
          emulator -avd test_avd -no-window -no-audio -no-boot-anim &
          # انتظار المحاكي حتى يعمل بالكامل
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done; input keyevent 82'
          adb devices
          echo "Emulator is up and running."

      # 4. تنزيل وتثبيت اللعبة المعدلة
      - name: 4. Download and Install Patched APK
        run: |
          # تنزيل الـ APK من الـ Release الذي حددته
          gh release download ${{ github.event.inputs.release_tag }} --pattern 'FreeFire_Patched.apk'
          # تثبيت الـ APK على المحاكي
          adb install FreeFire_Patched.apk
          echo "Patched APK installed successfully."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. (اختياري) أخذ لقطة شاشة للتأكد
      - name: 5. Take a Verification Screenshot
        run: |
          adb exec-out screencap -p > screen.png
          echo "Screenshot taken."

      # 6. رفع لقطة الشاشة كدليل
      - name: 6. Upload Screenshot
        uses: actions/upload-artifact@v4
        with:
          name: verification-screenshot
          path: screen.png