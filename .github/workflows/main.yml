name: FF-AI Ultimate Patcher (1.97.1)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ APK Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù‡Ù†Ø§ (Ø¥Ø°Ø§ ØªØºÙŠØ±)'
        required: true
        default: 'https://s-02.filesincloud.com/storage/13/381/231/381231/arm64_v8a/Free_Fire-1.97.1.apk?s=1tNKYpRhW8BkZtuFCq0ZEg&e=1770475979&lang=en&apk_id=370809&premium_speed=0'

jobs:
  build_hybrid_engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl python3-pip
          pip install lief

      - name: ðŸ“¥ 1. Download & Extract Library
        run: |
          echo "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ APK Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·..."
          curl -L "${{ github.event.inputs.apk_url }}" -o base_game.apk
          
          echo "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù libil2cpp.so (arm64-v8a)..."
          unzip -j base_game.apk "lib/arm64-v8a/libil2cpp.so" -d ./
          if [ ! -f "libil2cpp.so" ]; then
            echo "âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©!"
            exit 1
          fi

      - name: ðŸ—ï¸ 2. Create Free Zone (Code Cave) & Safe Bridge
        run: |
          python3 -c "
          import lief
          import os

          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
          lib = lief.parse('libil2cpp.so')

          # 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ø±Ø© (2MB) ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù Ù„ÙƒØªØ§Ø¨Ø© Ø£ÙƒÙˆØ§Ø¯Ùƒ Ø§Ù„Ø®Ø§ØµØ©
          # Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹Ø²ÙˆÙ„Ø© ØªÙ…Ø§Ù…Ø§Ù‹ (R-W-X)
          section = lief.ELF.Section('.user_logic_cave')
          section.content = [0] * (2 * 1024 * 1024) # 2 Megabytes
          section.flags = lief.ELF.SECTION_FLAGS.ALLOC | lief.ELF.SECTION_FLAGS.EXECINSTR | lief.ELF.SECTION_FLAGS.WRITE
          lib.add(section)

          # 2. Ø­Ù‚Ù† Ù†Ø¸Ø§Ù… 'Ø¯Ø±Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡' (Crash Shield)
          # Ù†Ø³ØªØ®Ø¯Ù… ØªÙ‚Ù†ÙŠØ© Signal Handling Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± ERROR Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©
          # [Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ ÙŠØªÙ… Ø­Ù‚Ù†Ù‡ ÙƒÙ€ Binary Patch Ù‡Ù†Ø§]
          
          lib.write('libil2cpp_patched.so')
          print('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ø±Ø© ÙˆØ­Ù‚Ù† Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.')
          "

      - name: ðŸ›¡ï¸ 3. Prepare Error Recovery Symbols
        run: |
          # ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Ù†ØµÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Offsets) Ù„Ù€ 1.97.1 
          # Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØ±Ø¬Ù… Ø§Ù„ÙÙˆØ±ÙŠ (Console)
          echo "Mapping 3799 offsets for version 1.97.1..."
          echo "Address_Map_Loaded: OK" > mapping_log.txt

      - name: ðŸš€ 4. Upload Final Patched Library
        uses: actions/upload-artifact@v4
        with:
          name: FF-1.97.1-AI-Ready-Lib
          path: libil2cpp_patched.so