name: Global Hex Scanner (Deep Search)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  hunt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare 166MB Library
        run: |
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          unzip -q game.apk -d base_dir
          find base_dir -name "libil2cpp.so" -exec cp {} ./lib.so \;

      - name: Multi-Pattern Hex Analysis
        shell: python
        run: |
          import os, json

          def deep_hunt():
              lib_path = "lib.so"
              if not os.path.exists(lib_path): return {"error": "Lib not found"}
              
              with open(lib_path, "rb") as f:
                  data = f.read()

              # قائمة بأنماط بدايات الدوال المختلفة في معالجات ARM64
              patterns = {
                  "Standard_A64": b'\xFD\x7B\xBF\xA9', 
                  "Varied_A64": b'\xFF\x43\x00\xD1',
                  "Alt_Prologue": b'\xF4\x4F\xBE\xA9',
                  "Simple_Push": b'\xFE\x0F\x1F\xF8'
              }
              
              results = {}
              all_found = []

              for p_name, p_hex in patterns.items():
                  count = 0
                  pos = data.find(p_hex)
                  while pos != -1 and count < 1000:
                      all_found.append({"type": p_name, "offset": hex(pos)})
                      pos = data.find(p_hex, pos + 1)
                      count += 1
              
              return {
                  "Total_Matches": len(all_found),
                  "Offsets": all_found[:200], # أول 200 نتيجة
                  "Library_Size": len(data),
                  "Advice": "If Total is 0, the library is heavily packed or encrypted with a custom loader."
              }

          output = deep_hunt()
          with open("all_offsets.json", "w") as jf:
              json.dump(output, jf, indent=4)

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Deep-Scan-Results
          path: all_offsets.json