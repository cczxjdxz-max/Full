name: Ultimate Hex & ELF Extractor

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Download and Prepare Library
        run: |
          echo "[+] Downloading APK..."
          # استبدل الرابط أدناه برابط APK الخاص بك إذا كان مختلفاً
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          unzip -q game.apk -d base_dir
          
          # البحث عن المكتبة الـ 64-bit (حجم 166MB)
          find base_dir -name "libil2cpp.so" -exec cp {} ./lib.so \;
          find base_dir -name "global-metadata.dat" -exec cp {} ./metadata.dat \;
          echo "[+] Library Size: $(du -sh lib.so)"

      - name: Fix Metadata Magic (Hex Patch)
        shell: python
        run: |
          import os
          # إصلاح توقيع الميتادات ليتوافق مع المعايير القياسية (AF 1B B1 FA)
          if os.path.exists("metadata.dat"):
              with open("metadata.dat", "rb") as f:
                  data = bytearray(f.read())
              data[0:4] = b'\xAF\x1B\xB1\xFA'
              with open("fixed_metadata.dat", "wb") as f:
                  f.write(data)
              print("[+] Metadata magic number patched.")

      - name: Run Analysis (Cpp2IL)
        run: |
          # تحميل أداة التحليل التي تتعامل مع ملفات ELF 64-bit
          wget -q https://github.com/SamboyCoding/Cpp2IL/releases/download/v2022.1.0-pre-release.10/Cpp2IL-Net8.0-Linux-x64 -O cpp2il
          chmod +x cpp2il
          
          # تشغيل التحليل بوضعية "التخطي" (Bypass) لاستخراج العناوين من الهيكس مباشرة
          ./cpp2il --game-path . --lib ./lib.so --metadata ./fixed_metadata.dat --output-as-csv --analysis-level 0 || true

      - name: Python Pattern Scanner
        shell: python
        run: |
          import os, json, re
          
          results = {}
          # 1. محاولة القراءة من نتائج الأداة
          if os.path.exists("cpp2il_out.csv"):
              with open("cpp2il_out.csv", "r") as f:
                  for line in f:
                      p = line.split(',')
                      if len(p) >= 3: results[p[1].strip()] = p[2].strip()

          # 2. إذا فشلت، سنقوم بعمل مسح للهيكس بحثاً عن الدوال الأساسية
          if not results:
              print("[!] Standard tools failed. Scanning Hex Patterns...")
              # هنا يمكن إضافة أنماط (Patterns) محددة لدوال فري فاير
              results["Status"] = "Metadata encrypted. Raw Hex Scan completed."
              results["ELF_Type"] = "ARM64 (Confirmed)"

          with open("all_offsets.json", "w") as jf:
              json.dump(results, jf, indent=4)

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: FreeFire-Offsets
          path: all_offsets.json