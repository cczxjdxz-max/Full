name: Hex Hunter (The Final Stand)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  hunt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare 166MB Library
        run: |
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          unzip -q game.apk -d base_dir
          find base_dir -name "libil2cpp.so" -exec cp {} ./lib.so \;
          echo "[+] Lib Ready: $(ls -lh lib.so)"

      - name: Internal Hex Analysis
        shell: python
        run: |
          import os, json, struct

          def hunt_offsets():
              lib_path = "lib.so"
              if not os.path.exists(lib_path): return {"error": "Lib not found"}
              
              results = {}
              with open(lib_path, "rb") as f:
                  # قراءة رأس ELF (الذي أرسلته سابقاً)
                  header = f.read(64)
                  # التحقق من بصمة ELF 64-bit
                  if header[:4] != b'\x7fELF': return {"error": "Not a valid ELF"}
                  
                  f.seek(0)
                  data = f.read() # قراءة الـ 166 ميجا كاملة في الذاكرة

                  # البحث عن أنماط الدوال الشائعة (Function Prologues) لـ ARM64
                  # نمط: STP X29, X30, [SP, #-0x10]! (توقيع بداية معظم الدوال)
                  pattern = b'\xFD\x7B\xBF\xA9'
                  
                  count = 0
                  offsets = []
                  pos = data.find(pattern)
                  while pos != -1 and count < 5000: # استخراج أول 5000 دالة
                      offsets.append(hex(pos))
                      pos = data.find(pattern, pos + 1)
                      count += 1
                  
                  return {
                      "Total_Functions_Found": len(offsets),
                      "Sample_Offsets": offsets[:100], # سنأخذ أول 100 عينة كبداية
                      "Architecture": "ARM64",
                      "Message": "Raw Hex Scan Success (Metadata Ignored)"
                  }

          output_data = hunt_offsets()
          with open("all_offsets.json", "w") as jf:
              json.dump(output_data, jf, indent=4)

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: Hex-Hunter-Results
          path: all_offsets.json