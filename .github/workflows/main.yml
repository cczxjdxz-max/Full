name: Build Dumper from Source & Full Map

on:
  workflow_dispatch:

jobs:
  build_and_dump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' # Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ø¯Ø§Ø©

      - name: Download & Build Il2CppDumper Source
        run: |
          echo "ğŸ”¨ Cloning Il2CppDumper source code..."
          git clone https://github.com/Perfare/Il2CppDumper.git
          cd Il2CppDumper
          echo "ğŸš€ Building the tool from source..."
          dotnet build -c Release
          echo "âœ… Build successful."
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          cp -r bin/Release/net6.0/* ../
          cd ..

      - name: Download Free Fire & Extract
        run: |
          echo "ğŸ“¥ Downloading APK..."
          curl -L "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -o FreeFire.apk
          echo "ğŸ“¦ Extracting core files..."
          unzip -j FreeFire.apk "lib/arm64-v8a/libil2cpp.so" -d ./
          unzip -j FreeFire.apk "assets/bin/Data/Managed/Metadata/global-metadata.dat" -d ./

      - name: Execute Custom Dump
        run: |
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„ØªÙŠ Ø¨Ù†ÙŠÙ†Ø§Ù‡Ø§ Ù„Ù„ØªÙˆ
          # Ù†Ø³ØªØ®Ø¯Ù… echo Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ø£Ø¯Ø§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          ./Il2CppDumper ./libil2cpp.so ./global-metadata.dat ./Output_Data

      - name: Generate Final Classified Dictionary
        shell: python
        run: |
          import os
          import re

          dump_path = "./Output_Data/dump.cs"
          if not os.path.exists(dump_path):
              print("âŒ Error: dump.cs was not generated!")
              exit(1)

          with open(dump_path, "r", encoding="utf-8") as f:
              data = f.read()

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„: Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„ÙƒÙ„Ø§Ø³ØŒ ÙˆØ§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù…Ø· // RVA: 0x... Ø«Ù… Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ÙŠÙ„ÙŠÙ‡
          pattern = r"// RVA: (0x[0-9A-F]+).*?\n\s+(?:public|private|protected|internal).*?\s+(\w+)\("
          matches = re.findall(pattern, data, re.MULTILINE)

          with open("FULL_SOURCE_DUMP_2026.txt", "w", encoding="utf-8") as out:
              out.write("--- FREE FIRE 2026: SOURCE-BUILT DICTIONARY ---\n")
              out.write(f"Total Functions Mapped: {len(matches)}\n")
              out.write("-" * 50 + "\n\n")
              
              for rva, name in matches:
                  # ØªØµÙ†ÙŠÙ Ø°ÙƒÙŠ Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                  info = ""
                  if any(x in name.lower() for x in ["speed", "move", "walk"]): info = " [Ø³Ø±Ø¹Ø©/Ø­Ø±ÙƒØ©]"
                  elif any(x in name.lower() for x in ["recoil", "shake", "spread"]): info = " [Ø«Ø¨Ø§Øª Ø³Ù„Ø§Ø­]"
                  elif any(x in name.lower() for x in ["damage", "hit", "attack"]): info = " [Ø¶Ø±Ø±/Ø·Ù„Ù‚Ø©]"
                  elif any(x in name.lower() for x in ["aim", "target", "lookat"]): info = " [ØªÙˆØ¬ÙŠÙ‡/Ø¢ÙŠÙ…]"
                  elif any(x in name.lower() for x in ["jump", "gravity", "fly"]): info = " [Ù‚ÙØ²/Ø·ÙŠØ±Ø§Ù†]"
                  
                  out.write(f"Address: {rva} | Function: {name}{info}\n")

      - name: Upload Everything
        uses: actions/upload-artifact@v4
        with:
          name: Full-Source-Built-Data
          path: |
            FULL_SOURCE_DUMP_2026.txt
            Output_Data/script.py