name: GIAS_Nirvana_Final_Fix
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù (Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…) ---
      - name: 2. Cache Build Progress
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-gias-v2-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-gias-v2-

      - name: 3. Install Requirements & Render Video
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsm6 libxext6 build-essential
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡Ø§
          pip install --upgrade pip
          pip install opencv-python-headless numpy Cython==0.29.33 buildozer
          
          # Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (720P) ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ cv2
          python3 -c "import cv2, numpy as np; out = cv2.VideoWriter('gameplay_720p.mp4', cv2.VideoWriter_fourcc(*'mp4v'), 30.0, (1280, 720)); [out.write(np.zeros((720, 1280, 3), np.uint8)) for _ in range(100)]; out.release()"
          echo "âœ… ØªÙ… Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­ @ 720P"

      - name: 4. Build Setup (Persistent Spec)
        run: |
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi
          # Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy,numpy,opencv,android/' buildozer.spec
          sed -i 's/#android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec
          sed -i 's/#android.permissions = INTERNET/android.permissions = INTERNET,RECORD_AUDIO,WRITE_EXTERNAL_STORAGE/' buildozer.spec

      - name: 5. Start/Resume Android Build
        run: |
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ØŒ ÙˆØ¥Ø°Ø§ ÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ÙˆÙ‚ØªØŒ Ø§Ù„ØªÙ‚Ø¯Ù… Ø³ÙŠÙƒÙˆÙ† Ù…Ø­ÙÙˆØ¸Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
          yes | buildozer android debug || (echo "â° Ù†ÙØ§Ø° Ø§Ù„ÙˆÙ‚Øª! Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©" && exit 1)

      - name: 6. Release Results
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v20.0-Stable
          name: "G.I.A.S Nirvana (Checkpoint Active)"
          body: |
            ğŸ”± **Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø±** ğŸ”±
            - ØªÙ… Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© `ModuleNotFoundError: cv2`.
            - ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¢Ù„ÙŠ.
            - Ø¬ÙˆØ¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: **720P**.
          files: |
            bin/*.apk
            gameplay_720p.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}