name: GIAS_Final_Sovereign_Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Smart Cache (Speed Boost)
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}

      - name: 3. Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 4. Auto-Accept Android Licenses
        run: |
          mkdir -p ~/.android
          touch ~/.android/repositories.cfg
          yes | sdkmanager --licenses || true

      - name: 5. Create main.py (Blinking & 5-Min Anger)
        run: |
          cat << 'EOF' > main.py
          from kivy.app import App
          from kivy.uix.floatlayout import FloatLayout
          from kivy.uix.image import Image
          from kivy.animation import Animation
          from kivy.clock import Clock
          from kivy.core.window import Window
          import os

          class GiasEye(FloatLayout):
              def __init__(self, is_left=True, **kwargs):
                  super().__init__(**kwargs)
                  self.size_hint = (0.45, 0.45)
                  self.pos_hint = {'center_x': 0.28 if is_left else 0.72, 'center_y': 0.82}
                  
                  def get_p(name):
                      path = os.path.join("build", f"{name}.png")
                      return path if os.path.exists(path) else f"{name}.png"

                  self.states = {
                      "frame": get_p("GFN"),
                      "talk": get_p("SPEAK"),
                      "angry": get_p("ANGRY")
                  }

                  self.pupil = Image(source=self.states["talk"], size_hint=(0.75, 0.75), 
                                   pos_hint={'center_x': 0.5, 'center_y': 0.5}, opacity=0.4)
                  self.frame = Image(source=self.states["frame"], size_hint=(1, 1), 
                                   pos_hint={'center_x': 0.5, 'center_y': 0.5}, opacity=0.6)
                  
                  self.add_widget(self.pupil)
                  self.add_widget(self.frame)
                  self.disabled = True 

              def blink(self, *args):
                  # إغلاق لنصف ثانية كل 3 ثواني
                  close_eye = Animation(opacity=0, duration=0.1)
                  open_eye = Animation(opacity=0.4, duration=0.1)
                  (close_eye + Animation(duration=0.5) + open_eye).start(self.pupil)

              def set_angry(self, *args):
                  self.pupil.source = self.states["angry"]
                  self.pupil.opacity = 0.6 # زيادة الحدة عند الغضب

          class BlinkingNirvana(FloatLayout):
              def __init__(self, **kwargs):
                  super().__init__(**kwargs)
                  self.left_eye = GiasEye(is_left=True)
                  self.right_eye = GiasEye(is_left=False)
                  self.add_widget(self.left_eye)
                  self.add_widget(self.right_eye)
                  
                  # رمش العيون كل 3 ثواني
                  Clock.schedule_interval(self.trigger_blink, 3.5)
                  
                  # التحول للغضب (ANGRY) بعد 5 دقائق (300 ثانية)
                  Clock.schedule_once(self.go_angry, 300)

              def trigger_blink(self, dt):
                  self.left_eye.blink()
                  self.right_eye.blink()

              def go_angry(self, dt):
                  self.left_eye.set_angry()
                  self.right_eye.set_angry()

          class GIAS_Sovereign(App):
              def build(self): return BlinkingNirvana()

          if __name__ == "__main__": GIAS_Sovereign().run()
          EOF

      - name: 6. Build APK (Set Icon & Fast Mode)
        run: |
          pip install buildozer Cython==0.29.33
          [ ! -f buildozer.spec ] && buildozer init
          # تعيين أيقونة التطبيق (LAUNCHER.jpeg)
          sed -i 's/#icon.filename = %(source.dir)s\/data\/icon.png/icon.filename = build\/LAUNCHER.jpeg/' buildozer.spec
          # إعدادات الشاشة والظهور فوق التطبيقات
          sed -i 's/orientation = landscape/orientation = portrait/' buildozer.spec
          sed -i 's/^presplash.filename = .*/presplash.filename = /' buildozer.spec
          sed -i 's/#android.permissions = android.permission.INTERNET/android.permissions = INTERNET,SYSTEM_ALERT_WINDOW/' buildozer.spec
          sed -i 's/#source.include_patterns = assets/source.include_patterns = build\/*.png,build\/*.jpeg,*.png,*.jpeg/' buildozer.spec
          
          yes | buildozer android debug

      - name: 7. Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: GIAS-Final-Icon-APK
          path: bin/*.apk