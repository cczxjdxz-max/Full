name: GIAS_Final_Stable_Build
on: [push, workflow_dispatch]

jobs:
  build:
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… 22.04 Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ libtool
    runs-on: ubuntu-22.04 
    permissions: write-all
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù ---
      - name: 2. Cache Buildozer & Pip
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-buildozer-stable-${{ hashFiles('**/buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-stable-

      - name: 3. Install System Dependencies (The Fix)
        run: |
          sudo apt-get update
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø§Ù„ØªÙŠ ØªØ³Ø¨Ø¨Øª ÙÙŠ Ø®Ø·Ø£ LT_SYS_SYMBOL_USCORE
          sudo apt-get install -y build-essential libltdl-dev libtool autoconf automake \
          pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo-dev \
          libsqlite3-dev tk-dev uuid-dev libgdbm-dev libc6-dev libbz2-dev \
          libffi-dev libssl-dev ffmpeg
          
          # ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø¨Ø§ÙŠØ«ÙˆÙ† Ø¨Ù†Ø³Ø® Ù…ØªÙˆØ§ÙÙ‚Ø©
          pip install --upgrade pip
          pip install Cython==0.29.33 numpy ultralytics buildozer requests opencv-python

      - name: 4. Auto-Fetch Experience (From Releases)
        run: |
          REPO="${{ github.repository }}"
          URL=$(curl -s https://api.github.com/repos/$REPO/releases/latest | grep "browser_download_url" | grep ".gias" | cut -d '"' -f 4)
          if [ -n "$URL" ]; then
            curl -L -o Nirvana_Experience.gias $URL
            echo "âœ… Experience matrix synced from release."
          else
            echo "âš ï¸ No release found, generating base matrix..."
            python3 -c "import numpy as np; np.zeros(1024).tofile('Nirvana_Experience.gias')"
          fi

      - name: 5. Create Enhanced main.py (720P & Media Audio)
        run: |
          cat << 'EOF' > main.py
          import os
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.label import Label
          from kivy.uix.button import Button
          from kivy.core.window import Window
          from kivy.utils import get_color_from_hex

          Window.clearcolor = get_color_from_hex('#050505')

          class GIAS_UI(BoxLayout):
              def __init__(self, **kwargs):
                  super().__init__(orientation='vertical', padding=40, spacing=20)
                  self.add_widget(Label(text="G.I.A.S NIRVANA", font_size='32sp', color=get_color_from_hex('#00FF41'), markup=True))
                  self.status = Label(text="REC: 720P | AUDIO: MEDIA", color=(0.6, 0.6, 0.6, 1))
                  self.add_widget(self.status)
                  
                  self.btn = Button(text="ACTIVATE 6T ENGINE", background_color=get_color_from_hex('#004D40'), bold=True)
                  self.btn.bind(on_press=self.start)
                  self.add_widget(self.btn)

              def start(self, instance):
                  if os.path.exists("Nirvana_Experience.gias"):
                      self.status.text = "[color=00FF41]NIRVANA ONLINE âœ…[/color]"
                      self.status.markup = True
          
          class GIASApp(App):
              def build(self): return GIAS_UI()
          
          if __name__ == "__main__": GIASApp().run()
          EOF

      - name: 6. Render Gameplay Simulation (720P)
        run: |
          python3 -c "
          import cv2, numpy as np
          out = cv2.VideoWriter('preview_720p.mp4', cv2.VideoWriter_fourcc(*'mp4v'), 30.0, (1280, 720))
          for i in range(150):
              frame = np.zeros((720, 1280, 3), dtype=np.uint8)
              cv2.putText(frame, 'G.I.A.S SIMULATION: 720P', (400, 360), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 65), 2)
              out.write(frame)
          out.release()
          "
          # Ø¥Ø¶Ø§ÙØ© Ù…Ù…Ø± ØµÙˆØªÙŠ ÙˆÙ‡Ù…ÙŠ Ù„ØªÙ…Ø«ÙŠÙ„ "ØµÙˆØª Ø§Ù„ÙˆØ³Ø§Ø¦Ø·"
          ffmpeg -i preview_720p.mp4 -f lavfi -i anullsrc -c:v copy -c:a aac -shortest gameplay_final.mp4

      - name: 7. Build Professional APK
        run: |
          rm -f buildozer.spec
          buildozer init
          sed -i 's/package.name = myapp/package.name = gias_nirvana_v18/' buildozer.spec
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy,numpy,ultralytics,requests,opencv-python/' buildozer.spec
          sed -i 's/source.include_exts = py,png,jpg,kv,atlas/source.include_exts = py,png,jpg,kv,atlas,gias,so/' buildozer.spec
          sed -i 's/#android.permissions = INTERNET/android.permissions = INTERNET,RECORD_AUDIO,WRITE_EXTERNAL_STORAGE,SYSTEM_ALERT_WINDOW/' buildozer.spec
          yes | buildozer android debug

      - name: 8. Release Final Package
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v19.0-Stable-Final
          name: "G.I.A.S Nirvana Ultimate (All Fixes)"
          body: |
            ğŸ”± **Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ø±** ğŸ”±
            - ØªÙ… Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© `LT_SYS_SYMBOL_USCORE`.
            - ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… (Cache).
            - Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¯Ù…Ø¬ Ø¨Ø¬ÙˆØ¯Ø© **720P** ÙˆØµÙˆØª **Ø§Ù„ÙˆØ³Ø§Ø¦Ø·**.
          files: |
            bin/*.apk
            gameplay_final.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}