name: GIAS_Nirvana_Living_Entity
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 3. Download GIAS Eye Image
        run: |
          # تحميل صورة العين المرعبة والواقعية التي اخترناها
          curl -L -o gias_eye.png "[attachment_0](attachment)"

      - name: 4. Create Main.py (The Entity Code)
        run: |
          cat << 'EOF' > main.py
          from kivy.app import App
          from kivy.uix.floatlayout import FloatLayout
          from kivy.uix.image import Image
          from kivy.animation import Animation
          from kivy.uix.textinput import TextInput
          from kivy.clock import Clock
          from kivy.core.window import Window
          from kivy.utils import get_color_from_hex

          class GiasEye(Image):
              def __init__(self, **kwargs):
                  super().__init__(**kwargs)
                  self.source = 'gias_eye.png'
                  self.size_hint = (None, None)
                  self.size = (0, 0)
                  self.pos_hint = {'center_x': 0.5, 'center_y': 0.5}
                  self.opacity = 0

              def awaken(self):
                  # تأثير الاستيقاظ المرعب: تملأ الشاشة ثم تتقلص للزاوية
                  anim = Animation(opacity=1, size=(Window.width * 1.3, Window.height * 0.7), duration=1.2, t='out_expo')
                  anim += Animation(size=(200, 150), pos_hint={'center_x': 0.85, 'center_y': 0.9}, duration=1.5, t='in_out_quad')
                  anim.start(self)

          class NirvanaCore(FloatLayout):
              def __init__(self, **kwargs):
                  super().__init__(**kwargs)
                  Window.clearcolor = get_color_from_hex('#000000')
                  self.eye = GiasEye()
                  self.add_widget(self.eye)
                  
                  self.chat_input = TextInput(
                      hint_text='GIAS Listening...',
                      size_hint=(0.8, 0.08), pos_hint={'center_x': 0.5, 'center_y': -0.1},
                      background_color=(0, 0, 0, 0.8), foreground_color=(0, 1, 0, 1),
                      font_size='18sp', multiline=False
                  )
                  self.add_widget(self.chat_input)
                  self.press_time = 0

                  # محاكاة الاستيقاظ بعد 3 ثواني (جياس!)
                  Clock.schedule_once(lambda dt: self.eye.awaken(), 3)

              def on_touch_down(self, touch):
                  self.press_time = Clock.get_time()
                  Clock.schedule_once(self.open_chat, 6) # عداد الـ 6 ثواني
                  return super().on_touch_down(touch)

              def on_touch_up(self, touch):
                  self.press_time = 0
                  return super().on_touch_up(touch)

              def open_chat(self, dt):
                  if self.press_time > 0:
                      anim = Animation(pos_hint={'center_x': 0.5, 'center_y': 0.2}, duration=0.6)
                      anim.start(self.chat_input)

          class GIAS_Sovereign(App):
              def build(self):
                  return NirvanaCore()

          if __name__ == "__main__":
              GIAS_Sovereign().run()
          EOF

      - name: 5. Build APK
        run: |
          pip install --upgrade pip
          pip install buildozer Cython==0.29.33
          [ ! -f buildozer.spec ] && buildozer init
          sed -i 's/title = My Application/title = GIAS Sovereign/' buildozer.spec
          sed -i 's/package.name = myapp/package.name = gias.sovereign.v1/' buildozer.spec
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy,numpy/' buildozer.spec
          sed -i 's/#android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec
          sed -i 's/#android.permissions = INTERNET/android.permissions = INTERNET,RECORD_AUDIO,VIBRATE/' buildozer.spec
          
          yes | buildozer android debug

      - name: 6. Upload Final Entity
        uses: actions/upload-artifact@v4
        with:
          name: GIAS-Sovereign-Eye
          path: bin/*.apk