name: GIAS_Fast_Incremental_Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Cache Buildozer Core (The Speed Secret)
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          # مفتاح الذاكرة يعتمد على ملف المواصفات لضمان عدم إعادة البناء إلا عند التغيير الجذري
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      - name: 3. Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 4. Create main.py (The Sovereign Logic)
        run: |
          cat << 'EOF' > main.py
          from kivy.app import App
          from kivy.uix.floatlayout import FloatLayout
          from kivy.uix.image import Image
          from kivy.animation import Animation
          from kivy.clock import Clock
          from kivy.core.window import Window

          class GiasEye(FloatLayout):
              def __init__(self, is_left=True, **kwargs):
                  super().__init__(**kwargs)
                  self.size_hint = (0.5, 0.5)
                  self.pos_hint = {'center_x': 0.25 if is_left else 0.75, 'center_y': 0.7}
                  
                  self.states = {
                      "frame": "build/1000301700.png",
                      "talk": "build/1000301710.png",
                      "angry": "build/1000301712.png",
                      "learn": "build/1000301713.png",
                      "predator": "build/1000301709.png",
                      "arrogant": "build/1000301714.png"
                  }

                  self.pupil = Image(source=self.states["talk"], size_hint=(0.7, 0.7), pos_hint={'center_x': 0.5, 'center_y': 0.5}, opacity=0.4)
                  self.frame = Image(source=self.states["frame"], size_hint=(1, 1), pos_hint={'center_x': 0.5, 'center_y': 0.5}, opacity=0.5)
                  self.add_widget(self.pupil)
                  self.add_widget(self.frame)
                  self.disabled = True 

              def change_mood(self, mood):
                  if mood in self.states: self.pupil.source = self.states[mood]

          class NirvanaCore(FloatLayout):
              def __init__(self, **kwargs):
                  super().__init__(**kwargs)
                  Window.clearcolor = (0, 0, 0, 1)
                  self.left_eye = GiasEye(is_left=True)
                  self.right_eye = GiasEye(is_left=False)
                  self.add_widget(self.left_eye)
                  self.add_widget(self.right_eye)
                  anim = Animation(opacity=0.7, duration=2) + Animation(opacity=0.3, duration=2)
                  anim.repeat = True
                  anim.start(self.left_eye)
                  anim.start(self.right_eye)
                  Clock.schedule_once(lambda dt: self.set_mood("predator"), 8)

              def set_mood(self, mood):
                  self.left_eye.change_mood(mood)
                  self.right_eye.change_mood(mood)

          class GIAS_Sovereign(App):
              def build(self): return NirvanaCore()

          if __name__ == "__main__": GIAS_Sovereign().run()
          EOF

      - name: 5. Smart Build (No Redo Spec)
        run: |
          pip install --upgrade pip
          pip install buildozer Cython==0.29.33
          # إذا لم يكن الملف موجوداً سينشئه مرة واحدة فقط
          [ ! -f buildozer.spec ] && buildozer init
          
          # تعديل طفيف للمسارات دون المساس بباقي الإعدادات
          sed -i 's/#source.include_patterns = assets/*,build\/*.png/' buildozer.spec
          sed -i 's/source.include_exts = py,png,jpg,kv,atlas/source.include_exts = py,png,jpg,kv,atlas/' buildozer.spec
          
          # البناء بصيغة "التحديث" فقط
          buildozer android debug
          
      - name: 6. Export Final APK
        uses: actions/upload-artifact@v4
        with:
          name: GIAS-Ghost-APK
          path: bin/*.apk