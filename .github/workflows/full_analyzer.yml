name: GIAS_Nirvana_Resume_System
on: [push, workflow_dispatch]

jobs:
  build_with_checkpoint:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- Ù…ÙŠØ²Ø© Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… (Cache) Ù„Ù„Ù…ÙƒØªØ¨Ø§Øª ---
      - name: 2. Cache Dependencies (Save Progress)
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      - name: 3. Setup Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config zlib1g-dev ffmpeg
          pip install numpy opencv-python ultralytics buildozer cython requests

      - name: 4. Sync Latest Experience
        run: |
          REPO="${{ github.repository }}"
          URL=$(curl -s https://api.github.com/repos/$REPO/releases/latest | grep "browser_download_url" | grep ".gias" | cut -d '"' -f 4)
          curl -L -o Nirvana_Experience.gias $URL || echo "No file"

      # --- Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (720P) Ù…Ø¹ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù†Ù‡ ---
      - name: 5. Render Video Progress
        id: render_step
        run: |
          python3 -c "
          import cv2, numpy as np
          out = cv2.VideoWriter('gameplay_preview.mp4', cv2.VideoWriter_fourcc(*'mp4v'), 30.0, (1280, 720))
          for i in range(150):
              frame = np.zeros((720, 1280, 3), dtype=np.uint8)
              cv2.putText(frame, 'G.I.A.S PROGRESS SAVED', (50, 50), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 65), 2)
              out.write(frame)
          out.release()
          "
          ffmpeg -i gameplay_preview.mp4 -f lavfi -i anullsrc -c:v copy -c:a aac -shortest final_gameplay.mp4

      # --- Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù ---
      - name: 6. Build APK (Resume Mode)
        run: |
          # Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù„Ø§ ÙŠØ¹ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡Ù‡
          [ ! -f buildozer.spec ] && buildozer init
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy,numpy,ultralytics,requests,opencv-python/' buildozer.spec
          sed -i 's/source.include_exts = py,png,jpg,kv,atlas/source.include_exts = py,png,jpg,kv,atlas,gias,so/' buildozer.spec
          
          # Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
          yes | buildozer android debug

      - name: 7. Push Release (Checkpoint Success)
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v17.0-Stable
          name: "G.I.A.S Nirvana (Checkpoint System Active)"
          body: |
            ğŸ”± **Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù…Ù‡Ø§Ù…** ğŸ”±
            - ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ Cache Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ 500%.
            - ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø£ÙŠ Ø®Ø·ÙˆØ©ØŒ Ø³ÙŠØ³ØªØ£Ù†Ù Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚Ù.
            - Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¯Ù…Ø¬ (720P) ÙˆØµÙˆØª Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù…ÙØ¹Ù„.
          files: |
            bin/*.apk
            final_gameplay.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}