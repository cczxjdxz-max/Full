name: GIAS_Nirvana_Final_Success
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- تفعيل الاستئناف: حفظ واسترجاع الملفات الضخمة ---
      - name: 2. Cache Buildozer & Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-gias-v7-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-gias-v7-

      - name: 3. Install System Fixes & Java 17
        run: |
          sudo apt-get update
          # تثبيت مكتبات النظام الضرورية لـ OpenCV والذكاء الاصطناعي
          sudo apt-get install -y libsm6 libxext6 libxrender-dev ffmpeg \
          build-essential libltdl-dev libtool autoconf automake \
          pkg-config zlib1g-dev libffi-dev libssl-dev
          
          # إعداد الجافا لضمان استئناف Gradle بنجاح
          echo "JAVA_HOME=$(echo /usr/lib/jvm/temurin-17-jdk-amd64)" >> $GITHUB_ENV

      - name: 4. Python Setup & 720P Video Render
        run: |
          pip install --upgrade pip
          # تثبيت نسخة headless لأنها تعمل على السيرفرات بدون أخطاء
          pip install opencv-python-headless numpy Cython==0.29.33 buildozer
          
          # إنتاج الفيديو بجودة 720P وصوت مدمج
          python3 -c "
          import cv2, numpy as np
          out = cv2.VideoWriter('raw_video.mp4', cv2.VideoWriter_fourcc(*'mp4v'), 30.0, (1280, 720))
          for _ in range(90):
              frame = np.zeros((720, 1280, 3), dtype=np.uint8)
              cv2.putText(frame, 'GIAS NIRVANA 720P', (400, 360), cv2.FONT_HERSHEY_SIMPLEX, 1.2, (0, 255, 65), 3)
              out.write(frame)
          out.release()
          "
          # إضافة صوت الوسائط (صمت) للفيديو لضمان التوافق
          ffmpeg -i raw_video.mp4 -f lavfi -i anullsrc -c:v copy -c:a aac -shortest final_720p.mp4

      - name: 5. Start/Resume Buildozer
        run: |
          [ ! -f buildozer.spec ] && buildozer init
          # ضبط المواصفات بدقة
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy,numpy,opencv-python-headless/' buildozer.spec
          sed -i 's/#android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec
          
          # محاولة البناء - إذا فشل بسبب الوقت، التقدم محفوظ في الكاش
          yes | buildozer android debug || (echo "TIMEOUT: Progress Saved. Re-run to continue." && exit 1)

      - name: 6. Deploy Result
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v22.0-Checkpoint
          name: "G.I.A.S Nirvana (Build Success)"
          files: |
            bin/*.apk
            final_720p.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}