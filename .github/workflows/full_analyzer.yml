name: GIAS_Nirvana_Resume_Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- حفظ واسترجاع التقدم (أهم خطوة للاستئناف) ---
      - name: 2. Restore Progress (Cache)
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.buildozer
            .buildozer
          # مفتاح ديناميكي يتغير فقط إذا غيرت المتطلبات
          key: ${{ runner.os }}-build-v1-${{ github.run_id }} 
          restore-keys: |
            ${{ runner.os }}-build-v1-

      - name: 3. Install Essentials
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libltdl-dev libtool autoconf automake \
          pkg-config zlib1g-dev libncurses5-dev libffi-dev libssl-dev ffmpeg
          pip install --upgrade pip
          pip install Cython==0.29.33 buildozer

      - name: 4. Build Setup
        run: |
          [ ! -f buildozer.spec ] && buildozer init
          # إعدادات ثابتة لضمان عدم إعادة البناء من الصفر
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy,numpy,opencv-python,ultralytics/' buildozer.spec
          sed -i 's/#android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec
          # تفعيل تسجيل الفيديو 720P
          echo "quality=720p" > config.txt

      - name: 5. Execute Build with Auto-Resume
        run: |
          # أمر يخبر Buildozer بأن يكمل ما بدأه ولا يعيد مسح المجلدات
          yes | buildozer android debug || echo "Build stopped, saving progress for next run..."

      - name: 6. Render Gameplay (If Build Success)
        if: success()
        run: |
          python3 -c "import cv2, numpy as np; out = cv2.VideoWriter('gameplay_720p.mp4', cv2.VideoWriter_fourcc(*'mp4v'), 30.0, (1280, 720)); [out.write(np.zeros((720, 1280, 3), np.uint8)) for _ in range(100)]; out.release()"

      - name: 7. Upload Results
        if: always() # يرفع الملفات حتى لو فشل البناء لنرى أين توقف
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs-and-APK
          path: |
            bin/*.apk
            .buildozer/android/platform/build-*/build/logs/*.log