name: FF_Grand_Dissector_Final
on: [push, workflow_dispatch]

jobs:
  dissect_and_report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full wget python3-pip
          pip install pyelftools

      - name: The Great Extraction (Fixed)
        run: |
          # 1. تحميل الملف
          wget -q "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O FF.apk
          
          # 2. إنشاء المجلد أولاً لضمان عدم وجود خطأ في المسار
          mkdir -p game_dissection
          
          # 3. فك الضغط (تم إصلاح السويتش ليكون متصلاً -ogame_dissection)
          7z x FF.apk -ogame_dissection -y

      - name: Deep Forensic Analysis
        run: |
          cat << 'EOF' > report_gen.py
          import os

          def analyze():
              report = "=== تقرير التشريح الهندسي الكامل لمحرّك برمودا (تم الإصلاح) ===\n\n"
              
              # فحص ملف النخاع الشوكي (البرمجة الأساسية)
              lib_path = "game_dissection/lib/arm64-v8a/libil2cpp.so"
              if os.path.exists(lib_path):
                  size = os.path.getsize(lib_path) / (1024*1024)
                  report += f"[+] ملف libil2cpp.so موجود بنجاح | الحجم: {size:.2f} MB\n"
              
              # فحص ملفات التضاريس والأشجار (Unity Assets)
              assets_dir = "game_dissection/assets/bin/Data"
              if os.path.exists(assets_dir):
                  files_count = len(os.listdir(assets_dir))
                  report += f"[+] تم العثور على {files_count} ملف من أصول اللعبة (تضاريس، أشجار، عوائق).\n"
                  report += "[!] نظام الـ NavMesh (الخريطة الملاحية) متاح للتحويل إلى بيئة تدريب.\n"

              # فحص ملفات الميتا (لربط الأسماء بالوظائف)
              metadata = "game_dissection/assets/bin/Data/Managed/Metadata/global-metadata.dat"
              if os.path.exists(metadata):
                  report += "[+] تم استخراج قاموس اللعبة (global-metadata.dat). الـ AI يمكنه الآن تمييز 'الرأس' من 'الشجرة'.\n"

              with open("FINAL_GAME_REPORT.txt", "w", encoding="utf-8") as f:
                  f.write(report)

          analyze()
          EOF
          python3 report_gen.py

      - name: Upload Finished Report
        uses: actions/upload-artifact@v4
        with:
          name: Full-Game-Dissection-Report
          path: FINAL_GAME_REPORT.txt