name: GIAS AUTO-AI-ENVIRONMENT-BUILDER

on:
  workflow_dispatch:

jobs:
  build_env:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      # 1. تجهيز بيئة العمل والأدوات
      - name: 1. Setup Environment
        run: |
          sudo apt-get update && sudo apt-get install -y p7zip-full wget python3
          # تجهيز الدوت نت لتشغيل أداة استخراج العناوين
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: '8.0.x'

      # 2. تحميل اللعبة وأداة الـ Dumper
      - name: 2. Fetch Assets
        run: |
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O Game.apk
          7z x Game.apk -oextracted_files -y
          git clone --depth=1 https://github.com/Perfare/Il2CppDumper.git
          # بناء الأداة (بشكل مختصر)
          dotnet publish Il2CppDumper/Il2CppDumper/Il2CppDumper.csproj -c Release -r linux-x64 --self-contained true /p:PublishSingleFile=true -o ./dumper_bin

      # 3. استخراج العناوين وحقن الباتشات (المرحلة الذكية)
      - name: 3. Smart Auto-Patching
        run: |
          python3 -c '
          import os, re, subprocess

          # البحث عن ملفات اللعبة
          lib_path = ""
          meta_path = ""
          for root, dirs, files in os.walk("extracted_files"):
              if "libil2cpp.so" in files and "arm64" in root: lib_path = os.path.join(root, "libil2cpp.so")
              if "global-metadata.dat" in files: meta_path = os.path.join(root, "global-metadata.dat")

          if not lib_path or not meta_path:
              print("Critical Error: Files not found!")
              exit(1)

          # تشغيل الـ Dumper لاستخراج العناوين
          subprocess.run(["./dumper_bin/Il2CppDumper", lib_path, meta_path, "./DummyOutput"])

          # البحث داخل ملف العناوين المولد (dump.cs)
          offsets = {}
          targets = {
              "render": "UnityEngine.Canvas::set_enabled",
              "network": "UnityServices::Initialize",
              "ads": "AdsService::ShowAd" # مثال لتعطيل الإعلانات أيضاً
          }

          with open("./DummyOutput/dump.cs", "r") as f:
              content = f.read()
              for key, pattern in targets.items():
                  match = re.search(r"// RVA: (0x[0-9A-Fa-f]+).*?" + re.escape(pattern), content)
                  if match:
                      offsets[key] = int(match.group(1), 16)
                      print(f"FOUND {key} at {match.group(1)}")

          # تنفيذ الباتشات (التحويل لنمط بياني وأوفلاين)
          # MOV W0, #0 (للرندرة) و MOV W0, #1 (للنت) + RET
          with open(lib_path, "r+b") as f:
              if "render" in offsets:
                  f.seek(offsets["render"])
                  f.write(bytes.fromhex("00008052c0035fd6")) # Disable Render
              if "network" in offsets:
                  f.seek(offsets["network"])
                  f.write(bytes.fromhex("20008052c0035fd6")) # Force Offline-On
          
          print("Environment is now Ready: Headless & Offline.")
          '

      # 4. حفظ النسخة النهائية "البيانية" لتدريب الذكاء الاصطناعي
      - name: 4. Upload Training Environment
        uses: actions/upload-artifact@v4
        with:
          name: Headless_Training_Lib
          path: extracted_files/lib/arm64-v8a/libil2cpp.so