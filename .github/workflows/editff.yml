name: GIAS AUTO-AI-ENVIRONMENT-BUILDER

on:
  workflow_dispatch:

jobs:
  build_env:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      # 1. تحديث النظام وتجهيز الأدوات
      - name: 1. Setup Linux Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full wget python3

      # 2. تثبيت الدوت نت 8 (لبناء أداة التحليل)
      - name: 2. Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3. تحميل اللعبة وبناء المحلل من المصدر
      - name: 3. Fetch Game and Build Dumper
        run: |
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O Game.apk
          7z x Game.apk -oextracted_files -y
          
          git clone --depth=1 https://github.com/Perfare/Il2CppDumper.git
          # بناء الأداة من المصدر لضمان التوافق دائمًا
          dotnet publish Il2CppDumper/Il2CppDumper/Il2CppDumper.csproj -c Release -r linux-x64 -f net8.0 --self-contained true /p:PublishSingleFile=true -o ./dumper_bin

      # 4. البحث التلقائي عن العناوين وتطبيق الباتشات (المخ الجراحي)
      - name: 4. Auto-Discovery & Surgical Patching
        run: |
          python3 -c '
          import os, re, subprocess

          # --- الخطوة أ: تحديد مسارات الملفات الحيوية ---
          lib_path = ""
          meta_path = ""
          for root, dirs, files in os.walk("extracted_files"):
              if "libil2cpp.so" in files and "arm64" in root: 
                  lib_path = os.path.join(root, "libil2cpp.so")
              if "global-metadata.dat" in files: 
                  meta_path = os.path.join(root, "global-metadata.dat")

          if not lib_path or not meta_path:
              print("Critical Error: Core game files are missing!"); exit(1)

          # --- الخطوة ب: تشغيل المحلل للحصول على خريطة الكود ---
          os.chmod("./dumper_bin/Il2CppDumper", 0o755)
          subprocess.run(["./dumper_bin/Il2CppDumper", lib_path, meta_path, "./DummyOutput"], input="\n\n", text=True)

          # --- الخطوة ج: البحث الذكي عن عناوين الأهداف ---
          offsets = {}
          # هذه هي الأهداف التي نريد تعطيلها
          targets = {
              "render": "Canvas::set_enabled",   # لتعطيل الرسوميات
              "network": "UnityServices::Initialize" # لخداع فحص الإنترنت
          }
          
          dump_file = "./DummyOutput/dump.cs"
          if os.path.exists(dump_file):
              with open(dump_file, "r", errors="ignore") as f:
                  content = f.read()
                  for key, pattern in targets.items():
                      # البحث عن عنوان الذاكرة (RVA) المرتبط بالدالة
                      match = re.search(r"// RVA: (0x[0-9A-Fa-f]+).*?" + re.escape(pattern), content)
                      if match:
                          offsets[key] = int(match.group(1), 16)
                          print(f"SUCCESS: Found target ''{key}'' at address {match.group(1)}")

          # --- الخطوة د: تطبيق "الجراحة الرقمية" على الملف ---
          if len(offsets) == 2:
              with open(lib_path, "r+b") as f:
                  # 1. باتش تعطيل الرسوميات (Headless)
                  f.seek(offsets["render"])
                  f.write(bytes.fromhex("00008052c0035fd6")) # ARM64: MOV W0, #0 ; RET
                  
                  # 2. باتش تعطيل فحص الإنترنت (Offline)
                  f.seek(offsets["network"])
                  f.write(bytes.fromhex("20008052c0035fd6")) # ARM64: MOV W0, #1 ; RET
              print("SUCCESS: Patches applied. The library is now a headless training environment.")
          else:
              print("CRITICAL ERROR: Could not find all necessary offsets to patch.")
              exit(1)
          '

      # 5. استخراج الملف المعدل (المنتج النهائي لهذه المرحلة)
      - name: 5. Export AI Training Environment
        uses: actions/upload-artifact@v4
        with:
          name: AI_Data_Ready_Lib
          # تحديد المسار الدقيق للملف المعدل داخل مجلد اللعبة المستخرج
          path: extracted_files/lib/arm64-v8a/libil2cpp.so