name: GIAS AUTO-AI-ENVIRONMENT-BUILDER

on:
  workflow_dispatch:

jobs:
  build_env:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      # 1. تحديث النظام وتجهيز الأدوات
      - name: 1. Setup Linux Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full wget python3

      # 2. تثبيت الدوت نت 8
      - name: 2. Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3. تحميل اللعبة وبناء المحلل (تم إصلاح أمر البناء هنا)
      - name: 3. Fetch Game and Build Dumper
        run: |
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O Game.apk
          7z x Game.apk -oextracted_files -y
          
          git clone --depth=1 https://github.com/Perfare/Il2CppDumper.git
          # التعديل: تحديد Framework net8.0 لمنع الخطأ السابق
          dotnet publish Il2CppDumper/Il2CppDumper/Il2CppDumper.csproj -c Release -r linux-x64 -f net8.0 --self-contained true /p:PublishSingleFile=true -o ./dumper_bin

      # 4. البحث التلقائي عن العناوين والحقن (المخ الرياضي)
      - name: 4. Auto-Discovery & Patching
        run: |
          python3 -c '
          import os, re, subprocess

          # تحديد مسارات الملفات
          lib_path = ""
          meta_path = ""
          for root, dirs, files in os.walk("extracted_files"):
              if "libil2cpp.so" in files and "arm64" in root: 
                  lib_path = os.path.join(root, "libil2cpp.so")
              if "global-metadata.dat" in files: 
                  meta_path = os.path.join(root, "global-metadata.dat")

          if not lib_path or not meta_path:
              print("Critical Error: Core files missing!"); exit(1)

          # تشغيل المحلل آلياً
          # نستخدم subprocess لتنفيذ المحلل الذي قمنا ببنائه
          os.chmod("./dumper_bin/Il2CppDumper", 0o755)
          subprocess.run(["./dumper_bin/Il2CppDumper", lib_path, meta_path, "./DummyOutput"], input="\n\n", text=True)

          # البحث عن العناوين المطلوبة للبيئة البيانية
          offsets = {}
          targets = {
              "render": "Canvas::set_enabled", 
              "network": "UnityServices::Initialize"
          }
          
          dump_file = "./DummyOutput/dump.cs"
          if os.path.exists(dump_file):
              with open(dump_file, "r") as f:
                  content = f.read()
                  for key, pattern in targets.items():
                      # البحث عن RVA المرتبط بالدالة
                      match = re.search(r"// RVA: (0x[0-9A-Fa-f]+).*?" + re.escape(pattern), content)
                      if match:
                          offsets[key] = int(match.group(1), 16)
                          print(f"DONE: FOUND {key} at {match.group(1)}")

          # تطبيق "الجراحة الرقمية" لتحويلها لبيئة تدريب (Offline + Headless)
          if offsets:
              with open(lib_path, "r+b") as f:
                  if "render" in offsets:
                      f.seek(offsets["render"])
                      f.write(bytes.fromhex("00008052c0035fd6")) # MOV W0, #0 ; RET
                  if "network" in offsets:
                      f.seek(offsets["network"])
                      f.write(bytes.fromhex("20008052c0035fd6")) # MOV W0, #1 ; RET
              print("Patches applied successfully!")
          else:
              print("Error: No offsets found to patch.")
          '

      # 5. استخراج الملف المعدل (بيئة التدريب البيانية)
      - name: 5. Export AI Environment
        uses: actions/upload-artifact@v4
        with:
          name: AI_Data_Ready_Lib
          path: extracted_files/lib/arm64-v8a/libil2cpp.so