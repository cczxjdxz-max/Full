name: GIAS AI-TRAINING-ENV (OFFLINE & HEADLESS)

on:
  workflow_dispatch:
    inputs:
      offset_network:
        description: 'عنوان تعطيل فحص الإنترنت'
        required: true
        default: '0x1A2B3C' # مثال: يتم استبداله بالعنوان الحقيقي من التقرير
      offset_render:
        description: 'عنوان تعطيل الرسوميات'
        required: true
        default: '0x4D5E6F' # مثال: يتم استبداله بالعنوان الحقيقي من التقرير

jobs:
  build_env:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup & Tools
        run: sudo apt-get update && sudo apt-get install -y unzip wget zip p7zip-full

      - name: 2. Download and Extract Game
        run: |
          wget "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk" -O Game.apk
          7z x Game.apk -oextracted_files -y
          LIB_PATH=$(find extracted_files -name "libil2cpp.so" | grep "arm64-v8a" | head -n 1)
          cp "$LIB_PATH" ./libil2cpp.so

      - name: 3. Surgical Patching (Offline + Headless)
        run: |
          python3 -c '
          import os
          
          def apply_patch(filename, offset, hex_bytes):
              with open(filename, "r+b") as f:
                  f.seek(int(offset, 16))
                  f.write(bytes.fromhex(hex_bytes))
          
          # 1. باتش الأوفلاين: إجبار الدالة على إرجاع True (متصل دائماً)
          # نستخدم MOV W0, #1 ثم RET
          apply_patch("libil2cpp.so", "${{ github.event.inputs.offset_network }}", "20008052c0035fd6")
          
          # 2. باتش النمط البياني: تعطيل الرسوميات (Renderer Disable)
          # نستخدم MOV W0, #0 ثم RET
          apply_patch("libil2cpp.so", "${{ github.event.inputs.offset_render }}", "00008052c0035fd6")
          
          print("Patches applied successfully: Environment is now Offline and Headless.")
          '

      - name: 4. Export Training Environment
        uses: actions/upload-artifact@v4
        with:
          name: AI_Training_Lib
          path: libil2cpp.so