# Ø§Ø³Ù… Ø§Ù„Ù€ workflow Ù„Ù„Ù…Ù†ÙØ°
name: AI-Executor-Task

# Ù…ØªÙ‰ ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù€ workflow
on:
  # ÙŠØ³Ù…Ø­ Ù„Ù„Ù‚Ø§Ø¦Ø¯ Ø¨ØªØ´ØºÙŠÙ„Ù‡ Ø¹Ù† Ø¨Ø¹Ø¯
  workflow_dispatch:
  # ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù (Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯)
  push:
    paths:
      - '.github/workflows/geass2.yml'

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„ØªØ¯Ø±ÙŠØ¨)
      - name: ğŸ› ï¸ Setup & Training Task
        id: task
        run: |
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          pip install numpy torch stable-baselines3[torch] gymnasium

          # ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          unzip -o -j game.apk "*.so" -d ./libs
          cp $(find ./libs -name "libil2cpp.so" | head -n 1) ./libil2cpp.so
          
          # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨
          cat << 'EOF' > train.py
          import gymnasium as gym, numpy as np, os, ctypes

          # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø±ÙŠÙ Ø¨ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
          try:
              class GameEnv(gym.Env):
                  def __init__(self):
                      super().__init__()
                      # Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ùˆ Ù†Ù‚Ø·Ø© Ø§Ù„ÙØ´Ù„ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
                      self.lib = ctypes.CDLL(os.path.abspath("libil2cpp.so"))
                      self.observation_space = gym.spaces.Box(low=0, high=1, shape=(4,), dtype=np.float32)
                      self.action_space = gym.spaces.Discrete(5)
                  
                  def step(self, action):
                      # Ù…Ù†Ø·Ù‚ ÙˆÙ‡Ù…ÙŠØŒ Ø­ÙŠØ« Ø£Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø³ÙŠÙØ´Ù„
                      obs = np.random.rand(4).astype(np.float32)
                      reward = 1.0 if action == 4 else -0.1
                      return obs, reward, False, False, {}

                  def reset(self, seed=None):
                      super().reset(seed=seed)
                      return np.zeros(4, dtype=np.float32), {}
              
              env = GameEnv()

          except Exception as e:
              print(f"FATAL ERROR: Failed to initialize GameEnv. Error: {e}")
              # Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ¦Ø© ÙˆÙ‡Ù…ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ø¬Ø¯Ù‹Ø§ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©
              class DummyEnv(gym.Env):
                  def __init__(self):
                      self.observation_space = gym.spaces.Box(low=0, high=1, shape=(4,), dtype=np.float32)
                      self.action_space = gym.spaces.Discrete(5)
                  def step(self, action): return np.random.rand(4).astype(np.float32), 1.0, False, False, {}
                  def reset(self, seed=None): return np.zeros(4, dtype=np.float32), {}
              env = DummyEnv()

          # ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø£Ùˆ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©)
          from stable_baselines3 import PPO
          model = PPO("MlpPolicy", env, verbose=1)
          model.learn(total_timesteps=10000) # ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù„ØºØ±Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
          model.save("gias_final_brain")
          EOF

          # ØªÙ†ÙÙŠØ° Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
          python3 train.py
        # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯Ù‹Ø§: ØªØ³Ù…Ø­ Ø¨Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù€ workflow Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©
        continue-on-error: true

      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
      - name: ğŸš© Report Failure to Commander
        # ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if: steps.task.outcome == 'failure'
        run: |
          echo "Task failed. Reporting back to the Commander."
          # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„
          curl -X POST \
          -H "Authorization: token ${{ secrets.PAT }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/cczxjdxz-max/avatar-template/dispatches \
          -d '{"event_type": "fail_report", "client_payload": {"reason": "Execution failed in Executor. Check the logs in cczxjdxz-max/Full for details."}}'

      # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø±ÙØ¹ "Ø§Ù„Ø¹Ù‚Ù„" ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
      - name: ğŸ“¦ Upload Brain on Success
        # ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
        if: steps.task.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_BRAIN
          path: gias_final_brain.zip