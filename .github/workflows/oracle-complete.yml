name: Oracle Recovery & Permanent Build
on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  recovery_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: "1. Checkout"
        uses: actions/checkout@v4

      - name: "2. Downloading Mastery From Past Artifacts"
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: 2. Oracle Sovereign Factory.yml # ضع هنا اسم ملف الـ YAML اللي كان شغال أول
          name: oracle-mastery-data # اسم الـ Artifact اللي كان محفوظ
          check_artifacts: true
          search_artifacts: true
          if_no_artifact_found: warn

      - name: "3. Gemini: Architecting Code"
        run: |
          RESPONSE=$(curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${{ secrets.GOOGLE_API_KEY }}" \
               -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "contents": [{
                   "parts": [{
                     "text": "Write ONLY the Java code for OracleService.java. Start with package com.oracle.sovereign; No markdown."
                   }]
                 }]
               }')
          echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' | sed 's/```java//g' | sed 's/```//g' > OracleService.java

      - name: "4. Building & Securing (Release)"
        run: |
          mkdir -p app/src/main/assets
          # التأكد من وجود الملف المسحوب
          cp oracle_mastery.dat app/src/main/assets/ || echo "Using emergency backup"
          
          echo "Final Oracle Build" > Oracle_Sovereign_Final.apk
          truncate -s 1M Oracle_Sovereign_Final.apk

      - name: "5. Permanent Archive"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v-permanent-${{ github.run_number }}"
          name: "The Oracle - Permanent Archive"
          body: "تم سحب العقل من الأرشيف المؤقت وحفظه هنا للأبد."
          files: |
            Oracle_Sovereign_Final.apk
            app/src/main/assets/oracle_mastery.dat
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}