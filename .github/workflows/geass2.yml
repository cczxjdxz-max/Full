name: GIAS-FINAL-SURGICAL-EXTRACTOR
on:
  workflow_dispatch:

jobs:
  surgical_extraction:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Environment & Tools
        run: pip install UnityPy

      - name: 2. APK Acquisition
        run: |
          wget -q -O game.apk "https://dl.cdn.freefiremobile.com/live/package/FreeFire.apk"
          unzip -o game.apk -d game_files

      - name: 3. Master Execution (The Intelligence Engine)
        id: engine
        run: |
          cat << 'EOF' > final_processor.py
          import UnityPy
          import json
          import os
          import struct

          # 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙÙ‡Ø±Ø³ (Catalog)
          catalog_path = ""
          for root, dirs, files in os.walk("game_files"):
              if "catalog.json" in files:
                  catalog_path = os.path.join(root, "catalog.json")
                  break

          extracted_intel = {
              "status": "Incomplete",
              "physics_constants": {},
              "map_points": [],
              "weapon_mechanics": []
          }

          # 2. Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ØŒ Ø³Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ù†ÙˆØ¹ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ‚
          target_keywords = ["weapon", "physics", "bermuda", "recoil", "bullet"]
          
          print("ğŸ“¡ Starting Deep Component Analysis...")
          
          for root, dirs, files in os.walk("game_files"):
              if "bin" not in root: continue
              for file in files:
                  f_path = os.path.join(root, file)
                  if os.path.getsize(f_path) < 10240: continue
                  
                  try:
                      env = UnityPy.load(f_path)
                      for obj in env.objects:
                          # ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„Ø£Ø³Ù„Ø­Ø© (MonoBehaviour)
                          if obj.type.name == "MonoBehaviour":
                              data = obj.read()
                              name = getattr(data, 'name', '').lower()
                              
                              if any(k in name for k in target_keywords) or obj.size > 5000:
                                  # Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø®Ø§Ù…
                                  raw = obj.get_raw_data()
                                  floats = []
                                  for i in range(0, min(len(raw), 1000), 4):
                                      try:
                                          val = struct.unpack('f', raw[i:i+4])[0]
                                          if 0.1 < val < 50.0: # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‚ÙŠÙ… Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ ÙˆØ§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©
                                              floats.append(round(val, 3))
                                      except: continue
                                  
                                  extracted_intel["weapon_mechanics"].append({
                                      "file": file,
                                      "internal_name": name,
                                      "detected_values": list(set(floats))[:10]
                                  })

                          # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Mesh)
                          elif obj.type.name == "Mesh":
                              mesh = obj.read()
                              if "bermuda" in getattr(mesh, 'name', '').lower() or obj.size > 100000:
                                  extracted_intel["map_points"].append({
                                      "bundle": file,
                                      "vertices": getattr(mesh, 'm_VertexCount', 0),
                                      "name": getattr(mesh, 'name', 'Terrain_Segment')
                                  })
                  except: continue

          extracted_intel["status"] = "Success"
          with open("final_intelligence_report.json", "w", encoding='utf-8') as f:
              json.dump(extracted_intel, f, indent=4)
          
          print(f"âœ… Extracted {len(extracted_intel['weapon_mechanics'])} weapon profiles.")
          EOF
          python3 final_processor.py

      - name: 4. Upload Intelligence Report
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_GAME_INTEL
          path: final_intelligence_report.json